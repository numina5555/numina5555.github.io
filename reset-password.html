<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NUMINA | Restablecer contrase√±a</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0f1113; --panel:#16181c; --panel-2:#1d2025; --text:#fff; --muted:#a7aeb8;
      --brand:#ffd700; --brand-2:#e6c200; --danger:#ff6b6b; --ok:#44d07b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, #15181d 0%, transparent 60%),
        radial-gradient(1200px 800px at 120% 110%, #15181d 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex;align-items:center;justify-content:center;padding:24px;
    }
    .card{
      width:min(520px,100%);
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:24px 24px 28px;
      box-shadow:0 20px 45px rgba(0,0,0,.45);
      position:relative;
      text-align:left;
    }
    .topbar{ display:flex;align-items:center;justify-content:flex-end;margin-bottom:6px; }

    /* === Pastilla de idioma (igual que login) === */
    .lang-dropdown{ position:relative; display:inline-block; }
    .lang-btn{
      background:var(--brand);
      border:0; border-radius:999px; padding:6px 14px; cursor:pointer;
      color:#111; font-weight:900; display:inline-flex; align-items:center; gap:8px;
      box-shadow:inset 0 -2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.25);
    }
    .lang-btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(255,215,0,.3); }
    .lang-btn .chevron{ width:12px; height:12px; fill:none; stroke:#111; stroke-width:2px; transition:transform .18s ease; }
    .lang-dropdown.open .lang-btn .chevron{ transform:rotate(180deg); }
    .lang-menu{
      position:absolute; top:110%; right:0; z-index:20;
      background:#fff; color:#111; border-radius:12px; padding:6px 0; margin:8px 0 0;
      box-shadow:0 12px 28px rgba(0,0,0,.25), 0 2px 8px rgba(0,0,0,.2);
      min-width:180px; list-style:none; display:none; max-height:260px; overflow:auto;
    }
    .lang-dropdown.open .lang-menu{ display:block; }
    .lang-item{
      display:flex; align-items:center; gap:10px; padding:10px 14px; cursor:pointer;
      font-weight:700; user-select:none; white-space:nowrap;
    }
    .lang-item:hover, .lang-item[aria-selected="true"]{ background:var(--brand); color:#111; }
    .lang-flag{ width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; }

    /* Marca */
    .brand{ display:flex;gap:10px;align-items:center;justify-content:center;margin:8px 0 18px; }
    .brand .logo{
      width:38px;height:38px;border-radius:10px;
      background:linear-gradient(135deg,#4b4300,#8a7a00);
      display:grid;place-items:center;font-weight:900;color:#111;
    }
    .brand h2{ margin:0; font-size:1.9rem; letter-spacing:1.4px; color:var(--brand); }

    h1{ font-size:1.25rem; margin:6px 0 16px; color:var(--text); text-align:center; }

    label{ display:block; font-size:.88rem; color:var(--muted); margin:4px 0 6px; }
    .field{
      position:relative;
    }
    input{
      width:100%; background:#0f1318; border:1px solid #232832; border-radius:10px;
      color:var(--text); padding:12px 42px 12px 14px; margin-bottom:14px; font-size:1rem;
      outline:none; transition:.18s box-shadow,.18s border-color;
    }
    input:focus{ border-color:#2e3746; box-shadow:0 0 0 3px rgba(255,215,0,.15); }
    .eye{
      position:absolute; right:10px; top:50%; transform:translateY(-50%); width:22px;height:22px;
      display:grid; place-items:center; color:#a7aeb8; cursor:pointer;
    }

    /* Bot√≥n amarillo centrado */
    .btn{
      display:block; margin:16px auto 0;
      width:min(360px,100%); background:var(--brand); color:#111; border:0; border-radius:999px;
      padding:12px 14px; font-weight:900; cursor:pointer; transition:.18s transform;
      text-align:center;
    }
    .btn:hover{ transform:translateY(-1px); }

    .muted{ color:var(--muted); font-size:.9rem; text-align:center; margin-top:12px; }
    a.link{ color:var(--brand); text-decoration:none; }
    a.link:hover{ text-decoration:underline; }

    #msg-ok{ color:var(--ok); min-height:20px; text-align:center; margin:8px 0; }
    #msg-err{ color:var(--danger); min-height:20px; text-align:center; margin:8px 0; }
  </style>
</head>
<body>
  <div class="card">
    <div class="topbar">
      <!-- Dropdown idioma en pastilla -->
      <div class="lang-dropdown" id="langDropdown">
        <button class="lang-btn" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
          <span aria-hidden="true">üåê</span>
          <span id="langCurrentText">Espa√±ol</span>
          <svg class="chevron" viewBox="0 0 10 6" aria-hidden="true"><path d="M1 1l4 4 4-4"/></svg>
        </button>
        <ul class="lang-menu" id="langMenu" role="listbox" aria-label="Language">
          <li class="lang-item" role="option" data-lang="es" aria-selected="true"><span class="lang-flag">üá™üá∏</span><span>Espa√±ol</span></li>
          <li class="lang-item" role="option" data-lang="en" aria-selected="false"><span class="lang-flag">üá¨üáß</span><span>English</span></li>
          <li class="lang-item" role="option" data-lang="pt" aria-selected="false"><span class="lang-flag">üáßüá∑</span><span>Portugu√™s</span></li>
        </ul>
      </div>
    </div>

    <!-- Marca -->
    <div class="brand" aria-hidden="true">
      <div class="logo">N</div>
      <h2>NUMINA</h2>
    </div>

    <h1 id="title">Actualizar contrase√±a</h1>

    <label for="p1" id="lbl1">Nueva contrase√±a</label>
    <div class="field">
      <input type="password" id="p1" placeholder="Contrase√±a (m√≠n. 6)" minlength="6" required />
      <span class="eye" id="eye1" title="Mostrar/ocultar">üëÅÔ∏è</span>
    </div>

    <label for="p2" id="lbl2">Repetir nueva contrase√±a</label>
    <div class="field">
      <input type="password" id="p2" placeholder="Repite la contrase√±a" minlength="6" required />
      <span class="eye" id="eye2" title="Mostrar/ocultar">üëÅÔ∏è</span>
    </div>

    <button class="btn" id="btn">Actualizar contrase√±a</button>

    <div id="msg-ok"></div>
    <div id="msg-err"></div>

    <p class="muted"><a class="link" href="/login.html" id="back">Volver al login</a></p>
  </div>

  <script>
    // ===== I18N =====
    const I18N = {
      es:{ title:"Actualizar contrase√±a", lbl1:"Nueva contrase√±a", lbl2:"Repetir nueva contrase√±a",
           p1:"Contrase√±a (m√≠n. 6)", p2:"Repite la contrase√±a", btn:"Actualizar contrase√±a",
           ok:"¬°Contrase√±a actualizada! Te redirigimos al login‚Ä¶", mismatch:"Las contrase√±as no coinciden.",
           err:"No pudimos actualizar la contrase√±a.", back:"Volver al login",
           lang:{es:"Espa√±ol", en:"Ingl√©s", pt:"Portugu√©s"} },
      en:{ title:"Update password", lbl1:"New password", lbl2:"Repeat new password",
           p1:"Password (min. 6)", p2:"Repeat the password", btn:"Update password",
           ok:"Password updated! Redirecting to sign in‚Ä¶", mismatch:"Passwords do not match.",
           err:"We could not update the password.", back:"Back to sign in",
           lang:{es:"Spanish", en:"English", pt:"Portuguese"} },
      pt:{ title:"Atualizar senha", lbl1:"Nova senha", lbl2:"Repetir nova senha",
           p1:"Senha (m√≠n. 6)", p2:"Repita a senha", btn:"Atualizar senha",
           ok:"Senha atualizada! Redirecionando para entrar‚Ä¶", mismatch:"As senhas n√£o coincidem.",
           err:"N√£o foi poss√≠vel atualizar a senha.", back:"Voltar para entrar",
           lang:{es:"Espanhol", en:"Ingl√™s", pt:"Portugu√™s"} },
    };
    const i18n = { current:'es', set(l){ if(!I18N[l]) return; this.current=l; try{localStorage.setItem('lang',l)}catch(e){}; apply(); } };
    function apply(){
      const t = I18N[i18n.current];
      document.documentElement.lang = i18n.current;
      document.getElementById('langCurrentText').textContent = t.lang[i18n.current];
      document.getElementById('title').textContent = t.title;
      document.getElementById('lbl1').textContent = t.lbl1;
      document.getElementById('lbl2').textContent = t.lbl2;
      document.getElementById('p1').placeholder = t.p1;
      document.getElementById('p2').placeholder = t.p2;
      document.getElementById('btn').textContent = t.btn;
      document.getElementById('back').textContent = t.back;
    }
    (function initLang(){
      const saved = (()=>{ try{return localStorage.getItem('lang')}catch(e){ return null } })();
      const preferred = (navigator.language || 'es').toLowerCase();
      const initial = saved || (preferred.startsWith('en') ? 'en' : preferred.startsWith('pt') ? 'pt' : 'es');
      i18n.set(initial);
    })();
    // Dropdown idioma
    (function(){
      const dd = document.getElementById('langDropdown');
      const btn = document.getElementById('langBtn');
      const menu = document.getElementById('langMenu');
      function open(){ dd.classList.add('open'); btn.setAttribute('aria-expanded','true'); }
      function close(){ dd.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.contains('open')?close():open(); });
      document.addEventListener('click', (e)=>{ if(!dd.contains(e.target)) close(); });
      menu.querySelectorAll('.lang-item').forEach(it=> it.addEventListener('click', ()=>{ i18n.set(it.dataset.lang); close(); }));
    })();

    // Mostrar/ocultar contrase√±a
    function toggleEye(inputId){ const el=document.getElementById(inputId); el.type = (el.type==='password')?'text':'password'; }
    document.getElementById('eye1').addEventListener('click', ()=>toggleEye('p1'));
    document.getElementById('eye2').addEventListener('click', ()=>toggleEye('p2'));

    // ===== SUPABASE =====
    const supabaseUrl = "https://xaeybhscsxpvtnqzpgwj.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhZXliaHNjc3hwdnRucXpwZ3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjQ0NzYsImV4cCI6MjA2OTUwMDQ3Nn0.o470dGkIyNKNP552A6DUB3pkJI3Lty9AZOdCmo3MQvU";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // 1) Setear sesi√≥n desde hash (access_token / refresh_token) y limpiar hash
    (async () => {
      const msgErr = document.getElementById('msg-err');
      try{
        const params = new URLSearchParams(location.hash.replace(/^#/, ''));
        const type = params.get('type');
        const access_token = params.get('access_token');
        const refresh_token = params.get('refresh_token');
        if (type !== 'recovery' || !access_token || !refresh_token){
          msgErr.textContent = 'Link inv√°lido o expirado.';
          return;
        }
        const { error } = await supabaseClient.auth.setSession({ access_token, refresh_token });
        if (error){ msgErr.textContent = error.message; return; }
        history.replaceState({}, document.title, location.pathname + location.search);
      }catch(e){
        msgErr.textContent = e?.message || 'Error al iniciar recuperaci√≥n.';
      }
    })();

    // 2) Actualizar contrase√±a y redirigir al login
    document.getElementById('btn').addEventListener('click', async ()=>{
      const t = I18N[i18n.current];
      const p1 = document.getElementById('p1').value;
      const p2 = document.getElementById('p2').value;
      const ok = document.getElementById('msg-ok');
      const err = document.getElementById('msg-err');
      ok.textContent = ''; err.textContent = '';
      if (p1 !== p2){ err.textContent = t.mismatch; return; }
      try{
        const { data: sess } = await supabaseClient.auth.getSession();
        if (!sess || !sess.session){ err.textContent = 'Sesi√≥n inv√°lida para recuperaci√≥n.'; return; }
        const { error } = await supabaseClient.auth.updateUser({ password: p1 });
        if (error){ err.textContent = error.message || t.err; return; }
        ok.textContent = t.ok;
        setTimeout(()=> { window.location.href = "/login.html"; }, 1200);
      }catch(e){ err.textContent = e?.message || t.err; }
    });
  </script>
</body>
</html>
