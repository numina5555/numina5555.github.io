<!DOCTYPE html>
<html lang="es">
<head>

<!-- i18n shim: evita ReferenceError si dI18n a√∫n no fue cargado -->
<script>
(function(){
  if (!window.dI18n) {
    window.dI18n = {
      lang: 'es',
      t: function(k){ return k; },
      set: function(l){ this.lang = l; },
      apply: function(){ /* noop: se reemplaza cuando i18n real carga */ }
    };
  }
})();
</script>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>NUMINA | Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
    :root {
      --primary: #ffd700;
      --primary-dark: #e6c200;
      --dark: #111;
      --dark-light: #1a1a1a;
      --dark-lighter: #222;
      --text: #fff;
      --text-light: #ccc;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .dashboard-header {
      background: linear-gradient(to right, var(--dark), var(--dark-lighter));
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 215, 0, 0.1);
    }

    .logo {
      color: var(--primary);
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      cursor: pointer;
    }

    .dashboard-container {
      display: flex;
      flex: 1;
    }

    .sidebar {
      width: 250px;
      background-color: var(--dark-light);
      padding: 1.5rem 0;
      border-right: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sidebar-menu {
      list-style: none;
    }

    .menu-item {
      padding: 0.8rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    .menu-item:hover, .menu-item.active {
      background-color: rgba(255, 215, 0, 0.1);
      border-left: 3px solid var(--primary);
      color: var(--primary);
    }

    .menu-item i {
      width: 20px;
      text-align: center;
    }

    .main-content {
      flex: 1;
      padding: 2rem;
      background-color: var(--dark);
    }

    .welcome-banner {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
      border: 1px solid rgba(255, 215, 0, 0.1);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .welcome-text h2 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .welcome-text p {
      color: var(--text-light);
    }

    .referral-code {
      background-color: var(--dark-light);
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .referral-code span {
      font-weight: 600;
      letter-spacing: 1px;
    }

    .copy-btn {
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .copy-btn:hover {
      background-color: var(--primary-dark);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background-color: var(--dark-light);
      border-radius: 10px;
      padding: 1.5rem;
      border-left: 4px solid var(--primary);
    }

    .stat-card h3 {
      color: var(--text-light);
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-card .value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .stat-card .change {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .change.positive {
      color: var(--success);
    }

    .change.negative {
      color: var(--danger);
    }

    .section-title {
      color: var(--primary);
      margin: 2rem 0 1rem;
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .table-container {
      background-color: var(--dark-light);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem;
      text-align: left;
    }

    th {
      background-color: var(--dark-lighter);
      color: var(--primary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-light);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .status {
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status.active {
      background-color: rgba(40, 167, 69, 0.2);
      color: var(--success);
    }

    .status.pending {
      background-color: rgba(255, 193, 7, 0.2);
      color: var(--warning);
    }

    .status.completed {
      background-color: rgba(13, 110, 253, 0.2);
      color: #0d6efd;
    }

    .action-btn {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 0.3rem 0.8rem;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover {
      background-color: var(--primary);
      color: var(--dark);
    }

    .account-info {
      background-color: var(--dark-light);
      border-radius: 10px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .info-item h4 {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .info-item p {
      font-weight: 600;
    }

    .edit-btn {
      display: inline-block;
      margin-top: 1.5rem;
      background-color: var(--primary);
      color: var(--dark);
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
    }

    .edit-btn:hover {
      background-color: var(--primary-dark);
    }

    .error-banner {
      background: rgba(220, 53, 69, 0.2);
      padding: 1rem;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
      border: 1px solid var(--danger);
    }

    .error-banner i {
      color: var(--danger);
    }

    .error-banner button {
      margin-left: auto;
      background: var(--dark);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    @media (max-width: 992px) {
      .sidebar {
        width: 70px;
      }

      .menu-item span {
        display: none;
      }

      .menu-item {
        justify-content: center;
      }

      .welcome-banner {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        padding: 0;
      }

      .sidebar-menu {
        display: flex;
        overflow-x: auto;
      }

      .menu-item {
        padding: 1rem;
        min-width: 70px;
      }
    }

    /* added: ensure section-content hidden by default */
    .section-content { display: none; }

    /* ===== Estilos de Configuraci√≥n (no afectan al dashboard) ===== */
    .settings-card { background-color: var(--dark-light); border: 1px solid rgba(255,255,255,.05); border-radius:10px; padding:1.5rem; margin-bottom:1.5rem; }
    .settings-card h3 { color: var(--primary); margin-bottom:.8rem; font-size:1.05rem; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:1rem; }
    .form-row { display:flex; flex-direction:column; gap:.4rem; }
    .form-row label { color:var(--text-light); font-size:.9rem; }
    .form-row input, .form-row select { background:var(--dark); border:1px solid var(--dark-lighter); border-radius:8px; padding:.7rem .8rem; color:var(--text); outline:none; }
    .form-actions { display:flex; gap:.6rem; justify-content:flex-end; margin-top:1rem; }
    .btn { background:var(--primary); color:var(--dark); border:none; padding:.6rem 1rem; border-radius:8px; font-weight:600; cursor:pointer; }
    .btn:hover { background:var(--primary-dark); }
    .helper { color:var(--text-light); font-size:.85rem; margin-top:.4rem; }
  </style>
<style>
  /* === Productos (scoped) === */
  .section-title { color: var(--primary, #ffd700); margin: 0 0 1rem; font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: .8rem; }
  .products-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.2rem; }
  @media (max-width: 1200px) { .products-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 900px)  { .products-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 560px)  { .products-grid { grid-template-columns: 1fr; } }
  .product-card { background: var(--dark-light, #1a1a1a); border: 1px solid rgba(255,255,255,.05); border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
  .product-card:hover { transform: translateY(-2px); border-color: rgba(255,215,0,.25); box-shadow: 0 8px 24px rgba(0,0,0,.35); }
  .product-media { background: var(--dark-lighter, #222); aspect-ratio: 16/10; }
  .product-media img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .product-body { padding: 1rem; display: flex; flex-direction: column; gap: .6rem; }
  .product-title { font-size: 1rem; font-weight: 700; color: var(--text, #fff); }
  .product-desc  { font-size: .9rem; color: var(--text-light, #ccc); }
  .price { color: var(--primary, #ffd700); font-weight: 700; font-size: 1.1rem; }
  .btn { background: transparent; color: var(--primary, #ffd700); border: 1px solid var(--primary, #ffd700); padding: .55rem .9rem; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background .2s ease, color .2s ease; }
  .btn:hover { background: var(--primary, #ffd700); color: var(--dark, #111); }
  .btn-primary { background: var(--primary, #ffd700); color: var(--dark, #111); }
  .btn-primary:hover { filter: brightness(0.95); }

</style>

<style>
  /* === NUMINA Productos override: fixed 2x2 centered grid === */
  #section-productos .products-wrap { max-width: 1100px; margin: 0 auto; padding: 0 1rem; }
  #section-productos .products-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    justify-items: center;
  }
  @media (max-width: 900px) { 
    #section-productos .products-grid { grid-template-columns: 1fr; }
  }
  #section-productos .product-card { width: 100%; max-width: 500px; border-radius: 16px; }
  #section-productos .section-title { justify-content: center; }
  #section-productos .product-media { aspect-ratio: 16/9; display:block; }
</style>



<style>
  /* Compact top spacing for products */
  #section-productos { margin-top: 0; }
  #section-productos .products-wrap { padding-top: 0.5rem; }
</style>


<style>
  /* === NUMINA: Modal de producto pantalla completa === */
  .nm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;z-index:1000;}
  .nm-overlay.show{display:block;}
  .nm-modal{position:relative;min-height:100vh;background:#111214;color:#fff;display:flex;flex-direction:column;}
  .nm-modal header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;background:#1a1b1f;border-bottom:1px solid #24262b}
  .nm-modal header h3{margin:0;font-size:18px;color:#ffd700;letter-spacing:.3px}
  .nm-close{background:transparent;border:0;color:#b7b7b7;font-size:22px;cursor:pointer}
  .nm-body{flex:1;display:grid;grid-template-columns:0.85fr 1.15fr;gap:22px;padding:22px;max-width:1200px;margin:0 auto}
  .nm-imgbox{background:#222;border-radius:16px;display:flex;align-items:center;justify-content:center;overflow:hidden;aspect-ratio:1/1;max-width:520px;width:100%;margin:0 auto}
  .nm-imgbox img{width:100%;height:100%;display:block;object-fit:contain}
  .nm-info h4{margin:.2rem 0 .6rem;font-size:22px}
  .nm-desc{color:#d0d0d0;line-height:1.55;margin:0 0 14px}
  .nm-price{font-size:24px;font-weight:900;margin:10px 0 18px;color:#ffd700}
  .nm-actions{display:flex;gap:10px;align-items:center;margin-top:6px}
  .nm-btn{background:transparent;border:1px solid #3a3a3a;color:#fafafa;padding:11px 14px;border-radius:12px;cursor:pointer}
  .nm-buy{background:#ffd700;color:#111;border:0;padding:12px 18px;border-radius:12px;font-weight:900;cursor:pointer}
  .nm-note{font-size:12px;color:#9aa0a6;margin-top:8px}
  @media(max-width:900px){.nm-body{flex:1;display:grid;grid-template-columns:0.85fr 1.15fr;gap:22px;padding:22px;max-width:1200px;margin:0 auto}

  .nm-pitch{margin:10px 0 14px;padding:12px 14px;border:1px solid #2b2e34;background:#16181d;border-radius:12px;line-height:1.55;color:#e7e7e7}
  .nm-pitch strong{color:#ffd700}
}
</style>


  <!-- === Sorteos (estilos integrados) === -->
  <style>
    /* Tarjetas y layout de Sorteos */
    .srt-stats { display:grid; grid-template-columns:1fr 1fr; gap:1.2rem; margin-bottom:1.5rem; align-items:stretch; }
    @media (max-width:900px){ .srt-stats{ grid-template-columns:1fr; } }
    .srt-card{ background:var(--dark-light); border-radius:12px; padding:1.2rem; border:1px solid rgba(255,255,255,.07);
               display:flex; flex-direction:column; min-height:150px; }
    .srt-card h3{ color:var(--text-light); font-size:.9rem; text-transform:uppercase; letter-spacing:.6px; margin-bottom:.5rem; }
    .srt-card .val{ font-size:1.5rem; font-weight:800; color:var(--text-light); }
    .srt-card.gold{ background:linear-gradient(135deg, rgba(255,215,0,.12), rgba(255,215,0,.04)); }

    /* Progreso Upgrade Numina */
    .srt-progress{ margin-top:.8rem; }
    .srt-track{ position:relative; height:14px; background:linear-gradient(180deg,#1a1a1a,#151515);
                border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
    .srt-fill{ height:100%; width:0%; background:linear-gradient(90deg, rgba(255,215,0,.85), rgba(255,215,0,1));
               box-shadow:0 0 12px rgba(255,215,0,.35) inset; transition:width .35s ease; }
    .srt-hit{ position:absolute; top:50%; transform:translate(-50%,-50%); width:14px; height:14px; border-radius:50%;
              background:#222; border:2px solid rgba(255,255,255,.25); }
    .srt-hit.on{ background:var(--primary); border-color:var(--primary); }
    .srt-marks{ position:relative; height:20px; margin-top:.45rem; }
    .srt-mark{ position:absolute; top:0; transform:translateX(-50%); font-size:.8rem; color:var(--text-light); white-space:nowrap; }

    /* Tabla */
    #sorteos-table th{ background:var(--dark-lighter); color:var(--primary); font-weight:600; text-transform:uppercase; font-size:.8rem; }
    #sorteos-table td{ color:var(--text-light); border-bottom:1px solid rgba(255,255,255,.05); }
  </style>


<style>
/* === NUMINA: Pill de idioma en header === */
.lang-dropdown{ position:relative; display:inline-block; margin-right:.75rem; }
.lang-btn{ background:#ffd700; border:0; border-radius:999px; padding:6px 12px; cursor:pointer;
  color:#111; font-weight:800; display:inline-flex; align-items:center; gap:8px;
  box-shadow:inset 0 -2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.25); }
.lang-btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(255,215,0,.3); }
.lang-btn .chevron{ width:12px; height:12px; fill:none; stroke:#111; stroke-width:2px; transition:transform .18s ease; }
.lang-dropdown.open .chevron{ transform:rotate(180deg); }
.lang-menu{ position:absolute; top:110%; right:0; z-index:100; background:#fff; color:#111; border-radius:12px; padding:6px 0; margin:8px 0 0;
  box-shadow:0 12px 28px rgba(0,0,0,.25), 0 2px 8px rgba(0,0,0,.2); min-width:170px; list-style:none; display:none; max-height:260px; overflow:auto; }
.lang-dropdown.open .lang-menu{ display:block; }
.lang-item{ display:flex; align-items:center; gap:10px; padding:10px 14px; cursor:pointer; font-weight:700; user-select:none; white-space:nowrap; }
.lang-item:hover, .lang-item[aria-selected="true"]{ background:#ffd700; color:#111; }
.lang-flag{ width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; }
@media (max-width: 600px){
  .lang-dropdown{ margin-right:.35rem; }
}
</style>

</head>
<body>
<header class="dashboard-header"><div style="flex-grow:1; text-align:center;"><div class="logo">NUMINA</div></div><div class="user-menu">

<div class="lang-dropdown" id="langDropdown">
  <button class="lang-btn" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
    <span aria-hidden="true">üåê</span>
    <span id="langCurrentText">Espa√±ol</span>
    <svg class="chevron" viewBox="0 0 10 6" aria-hidden="true"><path d="M1 1l4 4 4-4"/></svg>
  </button>
  <ul class="lang-menu" id="langMenu" role="listbox" aria-label="Language">
    <li class="lang-item" role="option" data-lang="es" aria-selected="true"><span class="lang-flag">üá™üá∏</span><span>Espa√±ol</span></li>
    <li class="lang-item" role="option" data-lang="en" aria-selected="false"><span class="lang-flag">üá¨üáß</span><span>English</span></li>
    <li class="lang-item" role="option" data-lang="pt" aria-selected="false"><span class="lang-flag">üáßüá∑</span><span>Portugu√™s</span></li>
  </ul>
</div>

<div class="user-avatar" id="user-avatar">US</div>
</div>
</header>
<div class="dashboard-container">
<nav class="sidebar">
<ul class="sidebar-menu">
<li class="menu-item active" data-target="dashboard">
<i class="fas fa-home"></i>
<span>Dashboard</span>
</li>
<li class="menu-item" data-target="compras">
<i class="fas fa-shopping-bag"></i>
<span><span data-i18n-section="compras"></span></span>
</li>
<li class="menu-item" data-target="sorteos">
<i class="fas fa-ticket-alt"></i>
<span>Sorteos</span>
</li>
<li class="menu-item" data-target="referidos">
<i class="fas fa-users"></i>
<span>Referidos</span>
</li>
<li class="menu-item" data-target="productos">
<i class="fas fa-box"></i>
<span id="sidebar-productos-text">Cat√°logo</span>
</li>
<li class="menu-item" data-target="configuracion">
<i class="fas fa-cog"></i>
<span>Configuraci√≥n</span>
</li>
<li class="menu-item" data-target="logout" id="logout-btn">
<i class="fas fa-sign-out-alt"></i>
<span>Cerrar Sesi√≥n</span>
</li>
</ul>
</nav>
<main class="main-content"><div id="main-dashboard">
<section class="welcome-banner" id="welcome-banner">
<div class="welcome-text">
<h2 id="welcome-title">Cargando datos...</h2>
<p id="welcome-subtitle" style="display: none;">Por favor espera</p>
</div>
<div class="referral-code">
<i class="fas fa-user-plus"></i>
<span id="referral-code">---</span>
<button class="copy-btn" id="copy-btn">Copiar</button>
</div>
</section>
<div class="stats-grid">
<div class="stat-card">
<h3>Saldo Disponible</h3>
<div class="value" id="balance-value">$---</div>
<div class="change positive">
<i class="fas fa-arrow-up"></i>
<span>Cargando...</span>
</div>
</div>
<div class="stat-card">
<h3>Compras Activas</h3>
<div class="value" id="purchases-value">--</div>
<div class="change positive">
<i class="fas fa-arrow-up"></i>
<span>Cargando...</span>
</div>
</div>
<div class="stat-card">
<h3>Referidos</h3>
<div class="value" id="referrals-value">--</div>
<div class="change positive">
<i class="fas fa-arrow-up"></i>
<span>Cargando...</span>
</div>
</div>
<div class="stat-card">
<h3>Tickets de Sorteo</h3>
<div class="value" id="tickets-value">--</div>
<div class="change negative">
<i class="fas fa-arrow-down"></i>
<span>Cargando...</span>
</div>
</div>
</div>
<h2 class="section-title">
<i class="fas fa-shopping-bag"></i>
<span>Compras Activas</span>
</h2>
<div class="table-container">
<table id="purchases-table">
<thead>
<tr>
<th>Producto</th>
<th data-i18n="raffles.date"></th>
<th>Valor</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="purchases-body">
<tr>
<td colspan="5" style="text-align: center;">Cargando compras...</td>
</tr>
</tbody>
</table>
</div>
<h2 class="section-title">
<i class="fas fa-users"></i>
<span>Historial de Referidos</span>
</h2>
<div class="table-container">
<table id="referrals-table">
<thead>
<tr>
<th>Referido</th>
<th data-i18n="raffles.date"></th>
<th>Compras</th>
<th>Estado</th>
<th>Comisi√≥n</th>
</tr>
</thead>
<tbody id="referrals-body">
<tr>
<td colspan="5" style="text-align: center;">Cargando referidos...</td>
</tr>
</tbody>
</table>
</div>
<h2 class="section-title">
<i class="fas fa-user-circle"></i>
<span>Informaci√≥n de la Cuenta</span>
</h2>
<div class="account-info">
<div class="info-grid" id="account-info-grid">
<div class="info-item">
<h4>Nombre Completo</h4>
<p id="full-name">Cargando...</p>
</div>
<div class="info-item">
<h4>Correo Electr√≥nico</h4>
<p id="user-email">Cargando...</p>
</div>
<div class="info-item">
<h4>Tel√©fono</h4>
<p id="user-phone">Cargando...</p>
</div>
<div class="info-item">
<h4>Direcci√≥n</h4>
<p id="user-address">Cargando...</p>
</div>
<div class="info-item">
  <h4>Pa√≠s</h4>
  <p id="user-country">Cargando...</p>
</div>
<div class="info-item">
  <h4>Ciudad</h4>
  <p id="user-city">Cargando...</p>
</div>
<div class="info-item">
  <h4>C√≥digo Postal</h4>
  <p id="user-postal">Cargando...</p>
</div>

</div>

</div>
</div>

<!-- Configuraci√≥n: MOVIDA FUERA DE #main-dashboard -->
<section class="section-content" id="section-configuracion" style="display:none;">
  <h2 class="section-title"><i class="fas fa-cog"></i><span>Configuraci√≥n de la Cuenta</span></h2>

  <div class="settings-card">
    <h3><i class="fas fa-id-card"></i> Datos Personales</h3>
    <form id="config-datos-form">
      <div class="form-grid">
      <!-- Nota: El campo de correo electr√≥nico se elimin√≥ de este formulario porque se gestiona √∫nicamente desde el proveedor de autenticaci√≥n (Supabase Auth). Si en el futuro se habilita su edici√≥n, puede reinsertarse un campo de solo lectura o un enlace a la secci√≥n correspondiente. Esta nota existe solo como documentaci√≥n para el equipo y no se muestra al usuario. -->

        <div class="form-row"><label for="cfg-fullname">Nombre completo</label><input id="cfg-fullname" type="text" placeholder="Nombre y apellido"/></div>
        
        <div class="form-row"><label for="cfg-phone">Tel√©fono</label><input id="cfg-phone" type="tel" placeholder="+54 11 1234 5678"/></div>
        <div class="form-row"><label for="cfg-address">Direcci√≥n</label><input id="cfg-address" type="text" placeholder="Calle, n√∫mero, ciudad"/></div>
        <div class="form-row"><label for="cfg-country">Pa√≠s</label><input id="cfg-country" type="text" placeholder="Argentina"/></div>
        <div class="form-row"><label for="cfg-city">Ciudad</label><input id="cfg-city" type="text" placeholder="Buenos Aires"/></div>
        <div class="form-row"><label for="cfg-postal">C√≥digo Postal</label><input id="cfg-postal" type="text" placeholder="C.P."/></div>

      </div>
      <div class="form-actions"><button class="btn" type="submit">Guardar cambios</button></div>
    </form>
  </div>

  <div class="settings-card">
    <h3><i class="fas fa-shield-alt"></i> Seguridad</h3>
    <form id="config-pass-form">
      <div class="form-grid">
        <div class="form-row"><label for="cfg-pass1">Nueva contrase√±a</label><input id="cfg-pass1" type="password" placeholder="********"/></div>
        <div class="form-row"><label for="cfg-pass2">Repetir contrase√±a</label><input id="cfg-pass2" type="password" placeholder="********"/></div>
      </div>
      <div class="form-actions"><button class="btn" type="submit">Actualizar contrase√±a</button></div>
    </form>
  </div>

  </section>

<section class="section-content" id="section-compras" style="display:none;">
  <h2 class="section-title">
    <i class="fas fa-shopping-bag"></i>
    <span><span data-i18n-section="compras"></span></span>
  </h2>
  <div class="table-container">
    <table id="miscompras-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th data-i18n="raffles.date"></th>
          <th>Valor</th>
          <th>Estado</th>
          <th>Reclamo</th>
        </tr>
      </thead>
      <tbody id="miscompras-body">
        <tr>
          <td colspan="5" style="text-align: center;">Cargando compras...</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
<section class="section-content" id="section-productos" style="display:none;">
  <div class="products-wrap">
    <h2 class="section-title"><i class="fas fa-box"></i><span id="sidebar-productos-text">Cat√°logo</span></h2>
    <section class="products-grid">
      <!-- Oro -->
      <article class="product-card">
        <figure class="product-media">
          <svg viewBox="0 0 640 360" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Lingote de Oro">
            <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0%" stop-color="#4b4300"/><stop offset="100%" stop-color="#8a7a00"/></linearGradient></defs>
            <rect width="640" height="360" fill="url(#g1)"/><text x="50%" y="52%" text-anchor="middle" fill="#fff" font-family="Montserrat, sans-serif" font-weight="700" font-size="36">Lingote de Oro</text>
          </svg>
        </figure>
        <div class="product-body">
          <h3 class="product-title">Lingote 100g Oro Fino</h3>
          <p class="product-desc">Oro 999.9 certificado. Ideal para inversi√≥n y resguardo de valor.</p>
          <span class="price">US$ 13,500</span>
          <button class="btn btn-primary" data-action="more" data-sku="GOLD-100G">M√°s informaci√≥n</button>
        </div>
      </article>
      <!-- Platino -->
      <article class="product-card">
        <figure class="product-media">
          <svg viewBox="0 0 640 360" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Lingote de Platino">
            <defs><linearGradient id="g2" x1="0" x2="1"><stop offset="0%" stop-color="#2e3136"/><stop offset="100%" stop-color="#6a6f78"/></linearGradient></defs>
            <rect width="640" height="360" fill="url(#g2)"/><text x="50%" y="52%" text-anchor="middle" fill="#fff" font-family="Montserrat, sans-serif" font-weight="700" font-size="36">Lingote de Platino</text>
          </svg>
        </figure>
        <div class="product-body">
          <h3 class="product-title">Lingote 100g Platino Fino</h3>
          <p class="product-desc">Platino 999.5 certificado. Inversi√≥n de alto valor y rareza.</p>
          <span class="price">US$ 6,500</span>
          <button class="btn btn-primary" data-action="more" data-sku="PLAT-100G">M√°s informaci√≥n</button>
        </div>
      </article>
      <!-- Rolex -->
      <article class="product-card">
        <figure class="product-media">
          <svg viewBox="0 0 640 360" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Rolex 126610L">
            <defs><linearGradient id="g3" x1="0" x2="1"><stop offset="0%" stop-color="#0d1f14"/><stop offset="100%" stop-color="#1d6c3a"/></linearGradient></defs>
            <rect width="640" height="360" fill="url(#g3)"/><text x="50%" y="52%" text-anchor="middle" fill="#fff" font-family="Montserrat, sans-serif" font-weight="700" font-size="34">Rolex 126610L</text>
          </svg>
        </figure>
        <div class="product-body">
          <h3 class="product-title">Rolex Starbucks Ref. 126610L</h3>
          <p class="product-desc">Submariner Date con bisel verde y caja Oystersteel. Autom√°tico.</p>
          <span class="price">US$ 19,600</span>
          <button class="btn btn-primary" data-action="more" data-sku="ROLEX-126610L">M√°s informaci√≥n</button>
        </div>
      </article>
      <!-- Pulsera -->
      <article class="product-card">
        <figure class="product-media">
          <svg viewBox="0 0 640 360" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Pulsera Numina">
            <defs><linearGradient id="g4" x1="0" x2="1"><stop offset="0%" stop-color="#2a0d2d"/><stop offset="100%" stop-color="#6f1d75"/></linearGradient></defs>
            <rect width="640" height="360" fill="url(#g4)"/><text x="50%" y="52%" text-anchor="middle" fill="#fff" font-family="Montserrat, sans-serif" font-weight="700" font-size="34">Pulsera Numina</text>
          </svg>
        </figure>
        <div class="product-body">
          <h3 class="product-title">Pulsera Numina</h3>
          <p class="product-desc">Dise√±o exclusivo con materiales de alta calidad. Edici√≥n limitada.</p>
          <span class="price">US$ 35</span>
          <button class="btn btn-primary" data-action="more" data-sku="NUMINA-BRACELET">M√°s informaci√≥n</button>
        </div>
      </article>
    </section>
<script src="https://unpkg.com/@supabase/supabase-js@2.39.0"></script>
<script>
// Memoized Supabase client: re-use the same instance so session persists between sections
(function(){
  const URL = 'https://xaeybhscsxpvtnqzpgwj.supabase.co';
  const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhZXliaHNjc3hwdnRucXpwZ3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjQ0NzYsImV4cCI6MjA2OTUwMDQ3Nn0.o470dGkIyNKNP552A6DUB3pkJI3Lty9AZOdCmo3MQvU';
  let _client = window.__supabaseClient || null;
  window.getSupabase = function(){
    if (_client) { 
      window.__supabaseClient = _client; 
      return _client; 
    }
    // IMPORTANT: do NOT replace the next line; it must call window.supabase.createClient
    _client = window.supabase.createClient(URL, KEY, { 
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: localStorage }
    });
    window.__supabaseClient = _client; return _client;
  };
})();
</script>

<script>
  // 1. VERIFICACI√ìN DE CARGA DE SUPABASE
  function checkSupabaseLoaded() {
    return new Promise((resolve) => {
      const check = () => {
        if (window.supabase) {
          resolve();
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }

  // 2. INICIALIZACI√ìN PRINCIPAL
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Espera a que Supabase est√© disponible
      await checkSupabaseLoaded();

      // Conexi√≥n a Supabase (TUS CREDENCIALES ORIGINALES)
      const supabase = getSupabase();

      // ‚ñ∫ [TODO EL RESTO DE TU C√ìDIGO ORIGINAL SE MANTIENE IGUAL]
      // Desde la verificaci√≥n de sesi√≥n hasta los event listeners
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      if (authError || !user) {
        window.location.href = '/login.html';
        return;
      }

      const { data: userData, error: userError } = await supabase
        .from('users')
        .select('*, purchases(*), referrals(*)')
        .eq('id', user.id)
        .maybeSingle();

      if (userError) throw userError;

      // Actualizar UI (tu funci√≥n original)
      document.getElementById('user-avatar').textContent = 
        userData.full_name?.charAt(0).toUpperCase() || 'U';
      document.getElementById('welcome-title').textContent = 
        `Bienvenido, ${userData.full_name || userData.email}`;
      document.getElementById('referral-code').textContent = 
        userData.referral_code || '---';
      document.getElementById('balance-value').textContent = `${userData.balance?.toFixed(2) || '0.00'}`;
      document.getElementById('purchases-value').textContent = userData.active_purchases || '0';
      document.getElementById('referrals-value').textContent = userData.referrals_count || '0';
      document.getElementById('tickets-value').textContent = userData.tickets_count || '0';
      document.getElementById('full-name').textContent = userData.full_name || dI18n.t('placeholders.undefined');
      document.getElementById('user-email').textContent = userData.email || dI18n.t('placeholders.undefined');
      document.getElementById('user-phone').textContent = userData.phone || dI18n.t('placeholders.undefined');
      document.getElementById('user-address').textContent = userData.address || dI18n.t('placeholders.undefined');
document.getElementById('user-country').textContent = userData.country || dI18n.t('placeholders.undefined');
document.getElementById('user-city').textContent = userData.city || dI18n.t('placeholders.undefined');
document.getElementById('user-postal').textContent = userData.postal_code || dI18n.t('placeholders.undefined');

document.getElementById('user-country').textContent = userData.country || dI18n.t('placeholders.undefined');
document.getElementById('user-city').textContent = userData.city || dI18n.t('placeholders.undefined');
document.getElementById('user-postal').textContent = userData.postal_code || dI18n.t('placeholders.undefined');



      // i18n status helper
      const statusLabel = (s) => {
        const v = String(s||'').toLowerCase();
        if (v === 'active' || v === 'activo') return ((window.dI18n && window.dI18n.t) ? dI18n8n.t('Activo') : 'Activo');
        if (v === 'inactive' || v === 'inactivo') return ((window.dI18n && window.dI18n.t) ? dI18n8n.t('Inactivo') : 'Inactivo');
        if (v === 'pending' || v === 'pendiente') return ((window.dI18n && window.dI18n.t) ? dI18n8n.t('Pendiente') : 'Pendiente');
        if (v === 'completed' || v === 'completado' || v === 'complete') return ((window.dI18n && window.dI18n.t) ? dI18n8n.t('Completado') : 'Completado');
        return s;
      };

      // Compras
      const purchasesBody = document.getElementById('purchases-body');
      purchasesBody.innerHTML = userData.purchases?.length > 0 
        ? userData.purchases.map(p => `
            <tr>
              <td>${p.product_name}</td>
              <td>${new Date(p.created_at).toLocaleDateString()}</td>
              <td>${(p.value ?? 0).toFixed(2)}</td>
              <td><span class="status ${p.status}">${statusLabel(p.status)}</span></td>
              <td><button class="action-btn">Detalles</button></td>
            </tr>
          `).join('')
        : '<tr><td colspan="5" style="text-align: center;">No hay compras</td></tr>';

      // Referidos
      const referralsBody = document.getElementById('referrals-body');
      referralsBody.innerHTML = userData.referrals?.length > 0
        ? userData.referrals.map(r => `
            <tr>
              <td>${r.referred_email}</td>
              <td>${new Date(r.created_at).toLocaleDateString()}</td>
              <td>${r.purchases_count || '0'}</td>
              <td><span class="status ${r.is_active ? 'active' : 'inactive'}">${r.is_active ? 'Activo' : 'Inactivo'}</span></td>
              <td>${(r.commission ?? 0).toFixed(2)}</td>
            </tr>
          `).join('')
        : '<tr><td colspan="5" style="text-align: center;">No hay referidos</td></tr>';

      // --- NUEVO: Prefill y handlers de Configuraci√≥n ---
      try { prefillConfigForms(userData); } catch(e) {}
      try { attachConfigHandlers(supabase); } catch(e) {}
      // ---------------------------------------------------

    } catch (error) {
      console.error('Error:', error);
      const banner = document.getElementById('welcome-banner');
      if (banner) {
        banner.innerHTML = `
          <div class="error-banner">
            <i class="fas fa-exclamation-circle"></i>
            <span>Error al conectar con el servidor. Recarga la p√°gina.</span>
            <button onclick="window.location.reload()">Reintentar</button>
          </div>
        `;
      }
    }
  });

  // Event listeners (originales)
  document.getElementById('copy-btn')?.addEventListener('click', function() {
    const code = document.getElementById('referral-code').textContent;
    navigator.clipboard.writeText(code);
    this.textContent = '¬°Copiado!';
    setTimeout(() => this.textContent = 'Copiar', 2000);
  });

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    const supabase = getSupabase();
    await getSupabase().auth.signOut();
    window.location.href = '/login.html';
  });
</script>
<script>
// NUEVOS helpers para Configuraci√≥n (no afectan otras vistas)
function prefillConfigForms(userData){
  const d = userData || {};
  const $ = (id)=>document.getElementById(id);
  if ($('cfg-fullname')) $('cfg-fullname').value = d.full_name || '';if ($('cfg-phone'))    $('cfg-phone').value    = d.phone || '';
  if ($('cfg-address'))  $('cfg-address').value  = d.address || '';
  if ($('cfg-lang'))     $('cfg-lang').value     = d.language || 'es';
  if ($('cfg-country'))  $('cfg-country').value  = d.country || '';
  if ($('cfg-city'))     $('cfg-city').value     = d.city || '';
  if ($('cfg-postal'))   $('cfg-postal').value   = d.postal_code || '';

}

function attachConfigHandlers(supabase){
  const datos = document.getElementById('config-datos-form');
  if (datos) datos.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const updates = {
      full_name: (document.getElementById('cfg-fullname').value||'').trim() || null,
      phone:     (document.getElementById('cfg-phone').value||'').trim() || null,
      address:   (document.getElementById('cfg-address').value||'').trim() || null,
      country:   (document.getElementById('cfg-country').value||'').trim() || null,
      city:      (document.getElementById('cfg-city').value||'').trim() || null,
      postal_code:(document.getElementById('cfg-postal').value||'').trim() || null,
    };
    // remove undefined keys and keep only provided values (avoid empty update bodies)
    Object.keys(updates).forEach(k => { if (updates[k] === undefined) delete updates[k]; });
    if (Object.values(updates).every(v => v === null)) { alert('No hay cambios para guardar'); return; }
    const { data: { user } } = await supabase.auth.getUser();
    const { data, error } = await supabase
      .from('users')
      .update(updates)
      .eq('id', user.id)
      .select('full_name,phone,address')
      .single();
    if (error) return alert('No se pudieron guardar los cambios');
    alert('Cambios guardados');
    const res = data || updates;
    // Refrescar en dashboard inmediatamente
    (function(){var el=document.getElementById('full-name'); if(el) el.textContent = (res.full_name ?? updates.full_name) || dI18n.t('placeholders.undefined');})();
    (function(){var el=document.getElementById('user-phone'); if(el) el.textContent = (res.phone ?? updates.phone) || dI18n.t('placeholders.undefined');})();
    (function(){var el=document.getElementById('user-address'); if(el) el.textContent = (res.address ?? updates.address) || dI18n.t('placeholders.undefined');})();
    
    // Nuevos campos
    (function(){var el=document.getElementById('user-country'); if(el) el.textContent = (res.country ?? updates.country) || dI18n.t('placeholders.undefined');})();
    (function(){var el=document.getElementById('user-city'); if(el) el.textContent = (res.city ?? updates.city) || dI18n.t('placeholders.undefined');})();
    (function(){var el=document.getElementById('user-postal'); if(el) el.textContent = (res.postal_code ?? updates.postal_code) || dI18n.t('placeholders.undefined');})();

    // Y forzar re-fetch al volver al Dashboard por si hay c√°lculos derivados
    if (typeof cargarDashboard === 'function') { try { await cargarDashboard(); } catch(_){} }
  });

  const pass = document.getElementById('config-pass-form');
  if (pass) pass.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const p1 = document.getElementById('cfg-pass1').value;
    const p2 = document.getElementById('cfg-pass2').value;
    if (!p1 || p1.length<6) return alert('La contrase√±a debe tener al menos 6 caracteres');
    if (p1 !== p2) return alert('Las contrase√±as no coinciden');
    const { error } = await supabase.auth.updateUser({ password:p1 });
    if (error) return alert('No se pudo actualizar la contrase√±a');
    alert('Contrase√±a actualizada');
    pass.reset();
  });

  /* Preferencias de idioma deshabilitadas */
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const hideIfReady = (id, expected) => {
    const el = document.getElementById(id);
    if (el && !el.textContent.includes('Cargando')) {
      const change = el.parentElement.querySelector('.change');
      if (change) change.style.display = 'none';
    }
  };

  hideIfReady('balance-value');
  hideIfReady('purchases-value');
  hideIfReady('referrals-value');
  hideIfReady('tickets-value');
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const copyBtn = document.getElementById("copy-btn");
  const referralCode = document.getElementById("referral-code");

  if (copyBtn && referralCode) {
    copyBtn.addEventListener("click", async () => {
      const code = referralCode.textContent;

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(code);
        } else {
          const textarea = document.createElement("textarea");
          textarea.value = code;
          textarea.style.position = "fixed";
          textarea.style.opacity = 0;
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
        }

        copyBtn.textContent = "¬°Copiado!";
        setTimeout(() => copyBtn.textContent = "Copiar", 2000);
      } catch (err) {
        alert("No se pudo copiar el c√≥digo. Intenta manualmente.");
        console.error("Error al copiar:", err);
      }
    });
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuItems = document.querySelectorAll('.menu-item[data-target]');
  const sections = document.querySelectorAll('.section-content');

  menuItems.forEach(item => {
    item.addEventListener('click', () => {
      const target = item.getAttribute('data-target');
      sections.forEach(section => {
        section.style.display = section.id === 'section-' + target ? 'block' : 'none';
      });
      menuItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
    });
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuItems = document.querySelectorAll(".menu-item[data-target]");
  const sections = document.querySelectorAll(".section-content");

  menuItems.forEach(item => {
    item.addEventListener("click", () => {
      const target = item.getAttribute("data-target");
      sections.forEach(section => {
        section.style.display = section.id === 'section-' + target ? 'block' : 'none';
      });
      menuItems.forEach(i => i.classList.remove("active"));
      item.classList.add("active");
    });
  });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuItems = document.querySelectorAll(".menu-item[data-target]");
  const mainDashboard = document.getElementById("main-dashboard");

  async function cargarDashboard() {
    console.log("[cargarDashboard] Ejecutando");

    document.getElementById('welcome-title').textContent = dI18n8n.t('labels.loading');
    document.getElementById('referral-code').textContent = '---';
    document.getElementById('balance-value').textContent = '$---';
    document.getElementById('purchases-value').textContent = '--';
    document.getElementById('referrals-value').textContent = '--';
    document.getElementById('tickets-value').textContent = '--';
    document.getElementById('full-name').textContent = 'Cargando...';
    document.getElementById('user-email').textContent = 'Cargando...';
    document.getElementById('user-phone').textContent = 'Cargando...';
    document.getElementById('user-address').textContent = 'Cargando...';
    document.getElementById('purchases-body').innerHTML = '<tr><td colspan="5" style="text-align: center;">Cargando compras...</td></tr>';
    document.getElementById('referrals-body').innerHTML = '<tr><td colspan="5" style="text-align: center;">Cargando referidos...</td></tr>';

    const supabase = getSupabase();

    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) return;

    const { data: userData } = await supabase
      .from('users')
      .select('*, purchases(*), referrals(*)')
      .eq('id', user.id)
      .maybeSingle();

    if (!userData) return;

    document.getElementById('user-avatar').textContent = userData.full_name?.charAt(0).toUpperCase() || 'U';
    window.__lastUserName = (userData.full_name || userData.email);
    document.getElementById('welcome-title').textContent = dI18n8n.t('labels.welcome') + ' ' + window.__lastUserName;
    document.getElementById('referral-code').textContent = userData.referral_code || '---';
    document.getElementById('balance-value').textContent = '$' + (userData.balance?.toFixed(2) || '0.00');
    document.getElementById('purchases-value').textContent = userData.active_purchases || '0';
    document.getElementById('referrals-value').textContent = userData.referrals_count || '0';
    document.getElementById('tickets-value').textContent = userData.tickets_count || '0';
    document.getElementById('full-name').textContent = userData.full_name || dI18n.t('placeholders.undefined');
    document.getElementById('user-email').textContent = userData.email || dI18n.t('placeholders.undefined');
    document.getElementById('user-phone').textContent = userData.phone || dI18n.t('placeholders.undefined');
    document.getElementById('user-address').textContent = userData.address || dI18n.t('placeholders.undefined');

    const purchasesBody = document.getElementById('purchases-body');
    if (userData.purchases?.length > 0) {
      purchasesBody.innerHTML = '';
      userData.purchases.forEach(p => {
        const row = '<tr>' +
          '<td>' + p.product_name + '</td>' +
          '<td>' + new Date(p.created_at).toLocaleDateString() + '</td>' +
          '<td>$' + (p.value?.toFixed(2) || '0.00') + '</td>' +
          '<td><span class="status ' + p.status + '\">' + statusLabel(p.status) + '</span></td>' +
          '<td><button class="action-btn">Detalles</button></td>' +
          '</tr>';
        purchasesBody.innerHTML += row;
      });
    } else {
      purchasesBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay compras</td></tr>';
    }

    const referralsBody = document.getElementById('referrals-body');
    if (userData.referrals?.length > 0) {
      referralsBody.innerHTML = '';
      userData.referrals.forEach(r => {
        const row = '<tr>' +
          '<td>' + r.referred_email + '</td>' +
          '<td>' + new Date(r.created_at).toLocaleDateString() + '</td>' +
          '<td>' + (r.purchases_count || '0') + '</td>' +
          '<td><span class="status ' + (r.is_active ? 'active' : 'inactive') + '">' +
          ((window.dI18n && window.dI18n.t) ? (r.is_active ? dI18n8n.t('Activo') : dI18n8n.t('Inactivo')) : (r.is_active ? 'Activo' : 'Inactivo')) + '</span></td>' +
          '<td>$' + (r.commission?.toFixed(2) || '0.00') + '</td>' +
          '</tr>';
        referralsBody.innerHTML += row;
      });
    } else {
      referralsBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay referidos</td></tr>';
    }
  }

  menuItems.forEach(item => {
    item.addEventListener("click", () => {
      const target = item.getAttribute("data-target");
      menuItems.forEach(i => i.classList.remove("active"));
      item.classList.add("active");

      if (target === "dashboard") {
        mainDashboard.style.display = "block";
        cargarDashboard();
      } else if (target !== "logout") {
        mainDashboard.style.display = "none";
      }
    });
  });

  mainDashboard.style.display = "block";
  cargarDashboard();
});
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuCompras = document.querySelector('.menu-item[data-target="compras"]');
  const sectionCompras = document.getElementById("section-compras");
  const mainDashboard = document.getElementById("main-dashboard");
  const sectionConfig = document.getElementById('section-configuracion');
  const menuConfig = document.querySelector('.menu-item[data-target="configuracion"]');

  // Mis Compras
  if (menuCompras) {
    menuCompras.addEventListener("click", async () => {
      if (mainDashboard) mainDashboard.style.display = "none";
      if (sectionCompras) sectionCompras.style.display = "block";
      // Traer compras recientes del usuario desde Supabase
      try {
        const supabase = getSupabase();
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
          window.location.href = '/login.html';
          return;
        }
        // Traer solo las 7 compras m√°s recientes del usuario
        const { data: purchases, error: purchaseError } = await supabase
          .from('purchases')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(7);

        const tbody = document.getElementById('miscompras-body');
        if (purchaseError || !purchases) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay compras</td></tr>';
          return;
        }
        if (purchases.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay compras</td></tr>';
          return;
        }
        tbody.innerHTML = purchases.map(p => `
          <tr>
            <td>${p.product_name}</td>
            <td>${new Date(p.created_at).toLocaleDateString()}</td>
            <td>${(p.value ?? 0).toFixed(2)}</td>
            <td><span class="status ${p.status}">${statusLabel(p.status)}</span></td>
            <td><button class="action-btn" disabled>${dI18n8n.t('Hacer reclamo')}</button></td>
          </tr>
        `).join('');
      } catch (e) {
        const tbody = document.getElementById('miscompras-body');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error cargando compras</td></tr>';
      }
    });
  }

  // Configuraci√≥n
  if (menuConfig) {
    menuConfig.addEventListener("click", () => {
      if (mainDashboard) mainDashboard.style.display = "none";
      if (sectionCompras) sectionCompras.style.display = "none";
      if (sectionConfig) sectionConfig.style.display = "block";
      try { prefillConfigForms(window._userData || {}); } catch(e) {}
    });
  }
});
</script>




  </div>
</section>



<script>
(function(){
  function setSidebarWidthVar(){
    var sb = document.querySelector('.sidebar, .side-bar, nav.sidebar, aside.sidebar');
    var w = sb ? sb.offsetWidth : 0;
    document.documentElement.style.setProperty('--sidebar-w', (w || 240) + 'px');
  }
  setSidebarWidthVar();
  window.addEventListener('resize', setSidebarWidthVar);
})();
</script>


<!-- NUMINA: Modal global de detalle de producto -->
<div class="nm-overlay" id="nmOverlay" hidden inert>
  <div class="nm-modal" role="dialog" aria-modal="true" aria-labelledby="nmTitle">
    <header>
      <h3 id="nmTitle">Detalles del producto</h3>
      <button class="nm-close" id="nmClose" aria-label="Cerrar">‚úï</button>
    </header>
    <div class="nm-body">
      <div class="nm-imgbox"><img id="nmImg" alt="Producto"/></div>
      <div class="nm-info">
        <span id="nmSku" class="label" style="display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#2a2a2a;color:#d7d7d7;font-size:12px;margin-bottom:12px"></span>
        <h4 id="nmName">‚Äî</h4>
        <p class="nm-desc" id="nmDesc">‚Äî</p>
        <div class="nm-price" id="nmPrice">‚Äî</div>
        <div class="nm-pitch" id="nmPitch" style="display:none"></div>
        <div class="nm-actions">
          <button class="nm-buy" id="nmBuy">Comprar</button>
        </div>
        <p class="nm-note">Env√≠os asegurados con seguimiento. Certificado incluido.</p>
      </div>
    </div>
  </div>
</div>




<script>
// NUMINA: Cat√°logo y modal a pantalla completa (sin aria-hidden warnings)
document.addEventListener('DOMContentLoaded', function(){
  const CATALOG = {
    "GOLD-100G": { sku:"GOLD-100G", name:"Lingote 100g Oro Fino 999.9", price:13500,
      img:"https://images.unsplash.com/photo-1623301762237-5b1056f3ce2d?q=80&w=1600&auto=format&fit=crop",
      pitch:"\ud83d\udcb0 <strong>Oro: Proteg\u00e9 tu dinero, asegur\u00e1 tu futuro</strong><br>Cuando todo sube y baja, el oro se mantiene firme. Es el activo refugio elegido por inversores de todo el mundo para proteger su patrimonio frente a la inflaci\u00f3n y la inestabilidad. El oro no depende de gobiernos ni bancos centrales: su valor es global, tangible y eterno. Comprarlo hoy es asegurarte un respaldo real que pod\u00e9s tener en tus manos y vender en cualquier momento. Invert\u00ed en oro y transform\u00e1 tu dinero en un activo que nunca pasa de moda y siempre vale.",
      desc:"Lingote de 100 g de oro 999.9 con n√∫mero de serie y certificado internacional. Alta liquidez y resguardo de valor." },
    "PLAT-100G": { sku:"PLAT-100G", name:"Lingote 100g Platino Fino 999.5", price:6500,
      img:"https://images.unsplash.com/photo-1617195737499-1d6bf14acaa7?q=80&w=1600&auto=format&fit=crop",
      pitch:"\ud83d\udc8e <strong>Platino: Exclusividad y potencial de crecimiento</strong><br>M\u00e1s escaso que el oro y con aplicaciones industriales cr\u00edticas (catalizadores, tecnolog\u00eda y joyer\u00eda), el platino combina lujo con oportunidad. Su rareza y demanda lo posicionan como un metal con fuerte potencial de revalorizaci\u00f3n a largo plazo. Asegur\u00e1 una parte de un recurso limitado, valioso y buscado en todo el mundo.",
      desc:"Lingote de 100 g de platino 999.5. Metal escaso, con potencial de revalorizaci√≥n a largo plazo." },
    "ROLEX-126610L": { sku:"ROLEX-126610L", name:"Rolex Submariner Date 126610LV", price:19600,
      img:"https://images.unsplash.com/photo-1524805444758-089113d48a6d?q=80&w=1600&auto=format&fit=crop",
      pitch:"\u231a <strong>Rolex Submariner \u201cStarbucks\u201d \u2013 S\u00faper Deportiva y Atemporal</strong><br>Con una caja Oystersteel de 41\u202fmm y bisel verde Cerachrom rotatorio unidireccional, este Submariner conserva ese dise\u00f1o ic\u00f3nico y elegante que lo define. Resistente al agua hasta 300 metros, cuenta con cristal de zafiro con lupa Cyclops y corona Triplock, combinando resistencia con claridad. Su calibre autom\u00e1tico 3235 de manufactura Rolex ofrece 70 horas de reserva de marcha, precisi\u00f3n certificada tipo cron\u00f3metro y protecci\u00f3n avanzada como resistencia a golpes y a campos magn\u00e9ticos. El brazalete Oyster con cierre Oysterlock y sistema Glidelock permite ajustes finos sin herramientas, adapt\u00e1ndose tanto a buceo como a uso diario. En conjunto, es el equilibrio perfecto entre tradici\u00f3n, ingenier\u00eda moderna y estilo deportivo de lujo.",
      desc:"Modelo 'Starbucks' con bisel cer√°mico verde y caja Oystersteel. Movimiento autom√°tico y hermeticidad profesional." },
    "NUMINA-BRACELET": { sku:"NUMINA-BRACELET", name:"Pulsera Numina ‚Äì Edici√≥n Limitada", price:35,
      img:"https://images.unsplash.com/photo-1515562141207-7a88fb7ce338?q=80&w=1600&auto=format&fit=crop",
      pitch:"\ud83d\udc8e <strong>Pulsera Numina \u2013 Estilo que te acerca a un Rolex</strong><br>Fabricada en <em>acero inoxidable premium</em>, dise\u00f1ada para durar y lucir impecable. Con cada pulsera obten\u00e9s <strong>1 ticket</strong> para participar en el <strong>sorteo de un Rolex Submariner</strong>.<br><br>\ud83c\udf9f <u>Mec\u00e1nica del sorteo</u>:<br>\u2022 Pulsera = 1 ticket<br>\u2022 Rolex = 5 tickets<br>\u2022 Oro Fino = 2 tickets<br>\u2022 Platino Fino = 2 tickets<br><br>\ud83c\udf81 <u>Premios especiales</u>:<br>\u2022 El comprador n\u00famero 2.500 recibir\u00e1 una <strong>Pulsera de Platino</strong>.<br>\u2022 El comprador n\u00famero 5.000 recibir\u00e1 una <strong>Pulsera de Oro</strong>.<br>\u2022 Si un usuario compra 2.500 pulseras en total, se le enviar\u00e1 una <strong>Pulsera de Platino</strong>.<br>\u2022 Si un usuario compra 5.000 pulseras en total, se le enviar\u00e1 una <strong>Pulsera de Oro</strong>.<br>\u2022 Si un usuario compra 10.000 pulseras en total, se le enviar\u00e1 una <strong>Pulsera de Oro Full Ice con diamantes</strong>.<br><br>Cuando llegue el momento del sorteo, <strong>asegurate de tener tu lugar</strong>.",
      desc:"Pulsera exclusiva con dise√±o minimalista y materiales de alta calidad. Incluye bolsita de microfibra." }
  };

  const $ = (s, c=document) => c.querySelector(s);
  const overlay = $("#nmOverlay");
  const modal    = overlay ? overlay.querySelector(".nm-modal") : null;
  const closeBtn = $("#nmClose");
  const buyBtn   = $("#nmBuy");
  const imgEl    = $("#nmImg");
  const nameEl   = $("#nmName");
  const descEl   = $("#nmDesc");
  const priceEl  = $("#nmPrice");
  const skuEl    = $("#nmSku");

  function money(v){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(v); }

  let currentSku = null;
  let lastTrigger = null;

  function trapFocus(e){
    if (!overlay || overlay.hasAttribute('hidden')) return;
    const focusable = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusable.length === 0) return;
    const first = focusable[0];
    const last  = focusable[focusable.length - 1];
    if (e.key === 'Tab'){
      if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    }
  }

  function openSKU(sku, trigger){
    const p = CATALOG[sku];
    if(!p || !overlay) return;
    currentSku = sku;
    lastTrigger = trigger || document.activeElement;

    if (skuEl)  skuEl.textContent  = p.sku;
    if (nameEl) nameEl.textContent = p.name;
    if (descEl) descEl.textContent = p.desc;
    if (priceEl)priceEl.textContent= money(p.price);
    if (imgEl)  imgEl.src          = p.img;

    
    // Ensure price appears before description and pitch is placed after price
    try {
      if (descEl && priceEl && descEl.previousElementSibling !== priceEl) {
        descEl.parentNode.insertBefore(priceEl, descEl);
      }
      var pitchEl = document.getElementById('nmPitch');
      if (pitchEl) {
        if (p.pitch) {
          pitchEl.innerHTML = p.pitch;
          pitchEl.style.display = '';
          // make sure pitch is right after price
          if (priceEl.nextElementSibling !== pitchEl) {
            priceEl.parentNode.insertBefore(pitchEl, descEl);
          }
        } else {
          pitchEl.style.display = 'none';
          pitchEl.innerHTML = '';
        }
      }
    } catch(e) { console.warn('Pitch render skipped:', e); }
      if (!pitchEl) {
        if (p.pitch && descEl) {
          try {
            descEl.innerHTML = p.pitch + '<br><br>' + (p.desc || '');
          } catch(_) {
            descEl.textContent = (p.desc || '');
          }
        }
      }

overlay.classList.add("show");
    overlay.removeAttribute("hidden");
    overlay.removeAttribute("inert");
    if (modal) { modal.setAttribute("tabindex","-1"); modal.focus({preventScroll:true}); }
    if (closeBtn) closeBtn.focus({preventScroll:true});
    document.addEventListener('keydown', trapFocus);
  }

  function close(){
    if (!overlay) return;
    overlay.classList.remove("show");
    overlay.setAttribute("hidden","");
    overlay.setAttribute("inert","");
    document.removeEventListener('keydown', trapFocus);
    if (lastTrigger && typeof lastTrigger.focus === 'function') {
      setTimeout(()=> lastTrigger.focus(), 0);
    }
  }

  // Delegaci√≥n: abrir modal
  document.addEventListener("click", (e) => {
    const btn = e.target.closest('button[data-action=\"more\"][data-sku], button[data-product]');
    if (btn) {
      e.preventDefault();
      const sku = btn.getAttribute('data-sku') || btn.getAttribute('data-product');
      openSKU(sku, btn);
    }
  });

  // Bot√≥n comprar (crea purchase -> invoca Edge Function -> redirige)
  if (buyBtn) buyBtn.addEventListener('click', async () => {
    try {
      if (!currentSku) return;
      // 1) validar sesi√≥n
      const supabase = getSupabase();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert('Inicia sesi√≥n para continuar con la compra.');
        window.location.href = '/login.html';
        return;
      }
      // 2) obtener datos del producto
      const p = CATALOG[currentSku];
      if (!p) { alert('Producto desconocido'); return; }

      // 3) crear registro local de compra
      const { data: purchase, error: insertErr } = await supabase
        .from('purchases')
        .insert({
          user_id: user.id,
          product_name: p.name,
          sku: p.sku,
          value: p.price,
          currency: 'USD',
          status: 'pending'
        })
        .select('id')
        .single();
      if (insertErr || !purchase) {
        console.error(insertErr);
        alert('No se pudo crear la compra. Intenta nuevamente.');
        return;
      }

      // 4) invocar Edge Function autenticada (maneja CORS internamente)
      const { data, error } = await supabase.functions.invoke('create-invoice', {
        body: { purchase_id: purchase.id, test_amount_usdt: p.price }
      });
      if (error) {
        console.error(error);
        alert('Error al crear la factura: ' + (error.message || 'desconocido'));
        return;
      }

      // 5) redirigir al checkout
      const payment_url = data?.payment_url || data?.paymentUrl || null;
      if (payment_url) {
        window.location.href = payment_url;
      } else {
        alert('No se recibi√≥ la URL de pago.'); 
      }
    } catch (e) {
      console.error(e);
      alert('Error inesperado: ' + (e?.message || e));
    }
  });

  // Cerrar modal
  if (closeBtn) closeBtn.addEventListener('click', close);
  if (overlay) overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
});
</script>

    


<!-- ===== Secci√≥n: Sorteos (integrada) ===== -->
<section class="section-content" id="section-sorteos" style="display:none;">
  <h2 class="section-title"><i class="fas fa-ticket-alt"></i><span data-i18n="sections.sorteoTitle"></span></h2>

  <div class="srt-stats">
    <!-- Tickets activos -->
    <article class="srt-card gold">
      <h3>Tickets Activos</h3>
      <div class="val" id="srt-tickets-activos">--</div>
    </article>

    <!-- Upgrade Numina con barra e hitos -->
    <article class="srt-card">
      <h3>Upgrade Numina</h3>
      <div class="val" id="srt-upgrade-valor">0 / 10,000</div>
      <div class="srt-progress" role="progressbar" aria-valuemin="0" aria-valuemax="10000" aria-valuenow="0">
        <div class="srt-track" id="srt-track">
          <div class="srt-fill" id="srt-fill"></div>
          <!-- Hitos -->
          <span class="srt-hit" style="left:25%" id="srt-25"></span>
          <span class="srt-hit" style="left:50%" id="srt-50"></span>
          <span class="srt-hit" style="left:100%" id="srt-100"></span>
        </div>
        <div class="srt-marks">
          <span class="srt-mark" style="left:25%">2,500</span>
          <span class="srt-mark" style="left:50%">5,000</span>
          <span class="srt-mark" style="left:100%">10,000</span>
        </div>
      </div>
    </article>
  </div>

  <h3 class="section-title"><i class="fas fa-history"></i><span data-i18n="sections.raffleHistory"></span></h3>
  <div class="table-container">
    <table id="sorteos-table">
      <thead>
        <tr>
          <th data-i18n="raffles.date"></th>
          <th data-i18n="raffles.name"></th>
          <th data-i18n="raffles.ticketsUsed"></th>
        </tr>
      </thead>
      <tbody id="sorteos-tbody">
        <tr><td colspan="3" style="text-align:center;">Cargando...</td></tr>
      </tbody>
    </table>
  </div>
</section>
</div></main>


<script>
// ===== Sorteos: carga desde Supabase (users.tickets_count, purchases: NUMINA-BRACELET, historial) =====
(function(){
  const GOAL = 10000;
  const BRACELET_SKU = 'NUMINA-BRACELET';

  async function cargarSorteos(){
    try{
      const supabase = getSupabase();
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      if (authError || !user) { window.location.href = '/login.html'; return; }

      
// Tickets activos tomados desde tickets_ledger (saldo = SUM(count))
      let ticketsActivos = 0;
      try{
        const { data: ticketsRows, error: tErr } = await supabase
          .from('tickets_ledger')
          .select('count')
          .eq('user_id', user.id);
        if (!tErr && ticketsRows) {
          ticketsActivos = ticketsRows.reduce((acc, r) => acc + (Number(r.count) || 0), 0);
        }
      }catch(e){
        console.warn('tickets_ledger sum error', e);
      }
      const $tickets = document.getElementById('srt-tickets-activos');
      if ($tickets) $tickets.textContent = ticketsActivos.toString();

// Upgrade Numina: sumar unidades de pulseras completadas/pagadas (usa quantity si existe)
      let totalBracelets = 0;
      try{
        const { data: rows } = await supabase
          .from('purchases')
          .select('sku, status, qty')
          .eq('user_id', user.id)
          .eq('sku', BRACELET_SKU)
          .in('status', ['completed','paid','success']);
        totalBracelets = (rows || []).reduce((acc, r)=> acc + (Number(r.qty)||1), 0);
      }catch(_){/* noop */}

      const current = totalBracelets;
      const pct = Math.max(0, Math.min(100, (current/GOAL)*100));
      const fill = document.getElementById('srt-fill');
      const label = document.getElementById('srt-upgrade-valor');
      const bar = document.querySelector('.srt-progress');
      if (fill) fill.style.width = pct + '%';
      if (bar) bar.setAttribute('aria-valuenow', String(current));
      if (label) label.textContent = current.toLocaleString() + ' / ' + GOAL.toLocaleString();
      if (current >= 2500) document.getElementById('srt-25').classList.add('on');
      if (current >= 5000) document.getElementById('srt-50').classList.add('on');
      if (current >= 10000) document.getElementById('srt-100').classList.add('on');

      // Historial de participaci√≥n: probar dos posibles tablas/campos
      const tbody = document.getElementById('sorteos-tbody');
      async function loadFrom(table, select){
        const { data, error } = await supabase
          .from(table)
          .select(select)
          .eq('user_id', user.id)
          .order('created_at', { ascending:false })
          .limit(50);
        if (error) return null;
        return data || null;
      }
      let entries = await loadFrom('tickets_ledger','created_at, sku, count');

      if (!tbody) return;
      if (!entries || !entries.length){
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Sin participaciones</td></tr>';
      } else {
        tbody.innerHTML = entries.map(e => {
          const fecha = new Date(e.created_at).toLocaleDateString();
          const sorteo = e.sku ?? '‚Äî';
          const used = (Number(e.count)||0) < 0 ? Math.abs(Number(e.count)) : 0;
          return '<tr><td>'+fecha+'</td><td>'+sorteo+'</td><td>'+used+'</td></tr>';
        }).join('');
      }
    }catch(err){ console.error('[Sorteos] error:', err); }
  }

  // Mostrar secci√≥n y cargar datos al hacer click en el men√∫ "Sorteos"
  document.addEventListener('DOMContentLoaded', () => {
    const menu = document.querySelector('.menu-item[data-target="sorteos"]');
    const section = document.getElementById('section-sorteos');
    const mainDash = document.getElementById('main-dashboard');
    if (menu){
      menu.addEventListener('click', async () => {
        if (mainDash) mainDash.style.display = 'none';
        if (section) section.style.display = 'block';
        await cargarSorteos();
      });
    }
  });
})();
</script>


<script>
// === NUMINA Dashboard i18n (ES/EN/PT) ===
const DB_I18N = {
  es: {
    sidebar: {
      dashboard: "Dashboard",
      compras: "Mis Compras",
      sorteos: "Sorteos",
      referidos: "Referidos",
      catalogo: "Cat√°logo",
      config: "Configuraci√≥n",
      logout: "Cerrar Sesi√≥n",
},
    actions: { copy: "Copiar", copied: "¬°Copiado!" },
    labels: { welcome: "Bienvenido,", loading: "Cargando datos..." },
    sections: {
      raffleHistory: "Historial de Participaci√≥n",
      sorteoTitle: "Sorteo",
      compras: "Mis Compras",
      comprasActivas: "Compras Activas",
      referidosHist: "Historial de Referidos",
      accountInfo: "Informaci√≥n de la Cuenta"
    }
  ,
    placeholders: { undefined: 'No definido' }
},
  en: {
    sidebar: {
      dashboard: "Dashboard",
      compras: "My Purchases",
      sorteos: "Raffles",
      referidos: "Referrals",
      catalogo: "Catalog",
      config: "Settings",
      logout: "Sign out",
},
    actions: { copy: "Copy", copied: "Copied!" },
    labels: { welcome: "Welcome,", loading: "Loading data..." },
    sections: {
      raffleHistory: "Participation History",
      sorteoTitle: "Raffle",
      compras: "My Purchases",
      comprasActivas: "Active Purchases",
      referidosHist: "Referral History",
      accountInfo: "Account Information"
    }
  ,
    placeholders: { undefined: 'Undefined' }
},
  pt: {
    sidebar: {
      dashboard: "Painel",
      compras: "Minhas Compras",
      sorteos: "Sorteios",
      referidos: "Indicados",
      catalogo: "Cat√°logo",
      config: "Configura√ß√µes",
      logout: "Sair",
},
    actions: { copy: "Copiar", copied: "Copiado!" },
    labels: { welcome: "Bem-vindo,", loading: "Carregando dados..." },
    sections: {
      raffleHistory: "Hist√≥rico de Participa√ß√£o",
      sorteoTitle: "Sorteio",
      compras: "Minhas Compras",
      comprasActivas: "Compras Ativas",
      referidosHist: "Hist√≥rico de Indica√ß√µes",
      accountInfo: "Informa√ß√µes da Conta"
    }
  ,
    placeholders: { undefined: 'N√£o definido' }
}
};

const dI18n8n = {
  current: 'es',
  set(lang){
    if(!DB_I18N[lang]) return;
    this.current = lang;
    try{ localStorage.setItem('dash_lang', lang); }catch(e){}
    document.documentElement.setAttribute('lang', lang);
    this.apply();
  },
  t(path){
    // simple dot path e.g. 'sidebar.catalogo'
    const parts = path.split('.'); let obj = DB_I18N[this.current];
    for (const p of parts){ if (!obj) return path; obj = obj[p]; }
    return obj || path;
  },
  apply(){
    // Sidebar
    const map = {
      dashboard: '.menu-item[data-target="dashboard"] span',
      compras:   '.menu-item[data-target="compras"] span',
      sorteos:   '.menu-item[data-target="sorteos"] span',
      referidos: '.menu-item[data-target="referidos"] span',
      catalogo:  '#sidebar-productos-text',
      config:    '.menu-item[data-target="configuracion"] span',
      logout:    '.menu-item[data-target="logout"] span'
    };
    Object.entries(map).forEach(([k, sel]) => {
      const el = document.querySelector(sel);
      if (el) el.textContent = dI18n8n.t('sidebar.'+k);
    });
    // Copy button
    const copyBtn = document.getElementById('copy-btn');
    if (copyBtn) copyBtn.textContent = dI18n8n.t('actions.copy');
    // Section titles (if present)
    const s1 = document.querySelector('h2.section-title i.fa-shopping-bag + span');
    if (s1) s1.textContent = dI18n8n.t('sections.comprasActivas');
    const s2 = document.querySelector('h2.section-title i.fa-users + span');
    if (s2) s2.textContent = dI18n8n.t('sections.referidosHist');
    const s3 = document.querySelector('h2.section-title i.fa-user-circle + span');
    if (s3) s3.textContent = dI18n8n.t('sections.accountInfo');
    const wt = document.getElementById('welcome-title');
    if (wt) {
      const nm = (window.__lastUserName || '').trim();
      wt.textContent = dI18n8n.t('labels.welcome') + (nm ? ' ' + nm : '');
    }

  }
};
// Alias unificado: toda la app usa el mismo objeto i18n
window.dI18n = dI18n8n;


(function initDashLang(){
  const saved = (()=>{ try{return localStorage.getItem('dash_lang')}catch(e){ return null } })();
  const preferred = (navigator.language || 'es').toLowerCase();
  const initial = saved || (preferred.startsWith('en') ? 'en' : preferred.startsWith('pt') ? 'pt' : 'es');
  dI18n.set(initial);
})();

document.addEventListener('DOMContentLoaded', () => {
  // Language pill bindings
  const dropdown = document.getElementById('langDropdown');
  const btn = document.getElementById('langBtn');
  const menu = document.getElementById('langMenu');
  const currentSpan = document.getElementById('langCurrentText');

  function openMenu(){ dropdown.classList.add('open'); btn.setAttribute('aria-expanded','true'); }
  function closeMenu(){ dropdown.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }

  function updateLabel(){
    const label = dI18n.current==='en'?'English': dI18n.current==='pt'?'Portugu√™s':'Espa√±ol';
    if (currentSpan) currentSpan.textContent = label;
  }

  updateLabel();
  dI18n.apply();

  btn?.addEventListener('click', (e)=>{
    e.stopPropagation();
    dropdown.classList.contains('open') ? closeMenu() : openMenu();
  });
  menu?.querySelectorAll('.lang-item').forEach(item=>{
    item.addEventListener('click', (e)=>{
      e.stopPropagation();
      const lang = item.dataset.lang;
      dI18n.set(lang);
      updateLabel();
      // update selected
      menu.querySelectorAll('.lang-item').forEach(li=> li.setAttribute('aria-selected', li.dataset.lang===lang?'true':'false'));
      closeMenu();
    });
  });
  document.addEventListener('click', (e)=>{ if (!dropdown.contains(e.target)) closeMenu(); });

  // Hook copy button text change on success to language
  const copyBtn = document.getElementById('copy-btn');
  if (copyBtn) {
    const setCopied = ()=>{ copyBtn.textContent = dI18n8n.t('actions.copied'); setTimeout(()=> copyBtn.textContent = dI18n8n.t('actions.copy'), 2000); };
    // If an existing handler changes it, we still ensure fallback translation with a custom event
    copyBtn.addEventListener('copied-i18n', setCopied);
  }
});
</script>


<script>
// Patch: after existing copy logic, ensure label matches current language
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('copy-btn');
  if (!btn) return;
  const orig = btn.onclick;
  // If inline not used, attach listener to ensure we set translated 'copied' text
  btn.addEventListener('click', ()=>{
    try{ btn.dispatchEvent(new Event('copied-i18n')); }catch(_){}
  });
});
</script>


<script>
// === Enhance i18n to include common content labels and table headers ===
(function(){
  // Extend dictionaries
  if (!window.DB_I18N) return;
  const ext = {
    es: {
      labels: {
        moreInfo: "M√°s informaci√≥n",
        price: "Precio",
        claim: "Hacer reclamo",
        product: "Producto",
        date: "Fecha",
        value: "Valor",
        status: "Estado",
        complaint: "Reclamo",
        noData: "Sin datos",
      },
      statuses: { pending: "pendiente", paid: "pagado", canceled: "cancelado", disputed: "en disputa" },
      sectionsTitles: {
        catalogo: "Cat√°logo",
        compras: "Mis Compras",
        sorteos: "Sorteos",
        referidos: "Referidos",
        configuracion: "Configuraci√≥n",
        dashboard: "Dashboard"
      }
    },
    en: {
      labels: {
        moreInfo: "More info",
        price: "Price",
        claim: "Make a claim",
        product: "Product",
        date: "Date",
        value: "Amount",
        status: "Status",
        complaint: "Claim",
        noData: "No data",
      },
      statuses: { pending: "pending", paid: "paid", canceled: "canceled", disputed: "disputed" },
      sectionsTitles: {
        catalogo: "Catalog",
        compras: "My Purchases",
        sorteos: "Raffles",
        referidos: "Referrals",
        configuracion: "Settings",
        dashboard: "Dashboard"
      }
    },
    pt: {
      labels: {
        moreInfo: "Mais informa√ß√µes",
        price: "Pre√ßo",
        claim: "Fazer reclama√ß√£o",
        product: "Produto",
        date: "Data",
        value: "Valor",
        status: "Status",
        complaint: "Reclama√ß√£o",
        noData: "Sem dados",
      },
      statuses: { pending: "pendente", paid: "pago", canceled: "cancelado", disputed: "em disputa" },
      sectionsTitles: {
        catalogo: "Cat√°logo",
        compras: "Minhas Compras",
        sorteos: "Sorteios",
        referidos: "Indicados",
        configuracion: "Configura√ß√µes",
        dashboard: "Painel"
      }
    }
  };
  // Deep merge
  for (const lang of Object.keys(ext)){
    DB_I18N[lang] = DB_I18N[lang] || {};
    for (const k of Object.keys(ext[lang])){
      DB_I18N[lang][k] = Object.assign({}, DB_I18N[lang][k] || {}, ext[lang][k]);
    }
  }

  // Monkey-patch apply to also translate content if present
  const origApply = dI18n.apply.bind(dI18n8n);
  dI18n.apply = function(){
    origApply();

    const dict = DB_I18N[this.current];

    // Section title (icon + span.section-title) if present
    const knownTitles = new Map([
      ['Cat√°logo', dict.sectionsTitles.catalogo],
      ['Catalog', dict.sectionsTitles.catalogo],
      ['Mis Compras', dict.sectionsTitles.compras],
      ['My Purchases', dict.sectionsTitles.compras],
      ['Sorteos', dict.sectionsTitles.sorteos],
      ['Raffles', dict.sectionsTitles.sorteos],
      ['Referidos', dict.sectionsTitles.referidos],
      ['Referrals', dict.sectionsTitles.referidos],
      ['Configuraci√≥n', dict.sectionsTitles.configuracion],
      ['Settings', dict.sectionsTitles.configuracion],
      ['Dashboard', dict.sectionsTitles.dashboard],
      ['Painel', dict.sectionsTitles.dashboard]
    ]);
    document.querySelectorAll('h1 span, h2 span, h3 span, .section-title span').forEach(sp=>{
      const txt = sp.textContent.trim();
      if (knownTitles.has(txt)) sp.textContent = knownTitles.get(txt);
    });

    // Table headers common mapping
    const thMap = new Map([
      ['Producto', dict.labels.product],
      ['Product', dict.labels.product],
      ['Fecha', dict.labels.date],
      ['Date', dict.labels.date],
      ['Valor', dict.labels.value],
      ['Amount', dict.labels.value],
      ['Estado', dict.labels.status],
      ['Status', dict.labels.status],
      ['Reclamo', dict.labels.complaint],
      ['Claim', dict.labels.complaint]
    ]);
    document.querySelectorAll('th').forEach(th=>{
      const t = th.textContent.trim();
      if (thMap.has(t)) th.textContent = thMap.get(t);
    });

    // Translate "M√°s informaci√≥n" buttons inside cards
    const candidates = Array.from(document.querySelectorAll('button, a.button, .btn, .button')).filter(el=>{
      const t = el.textContent.trim();
      return t === 'M√°s informaci√≥n' || t === 'More info' || t === 'Mais informa√ß√µes';
    });
    candidates.forEach(el=> el.textContent = dict.labels.moreInfo);

    // Translate "Hacer reclamo" buttons
    const claimBtns = Array.from(document.querySelectorAll('button, a')).filter(el=>{
      const t = el.textContent.trim();
      return t === (dI18n8n.t ? dI18n8n.t('Hacer reclamo') : 'Hacer reclamo') || t === 'Make a claim' || t === 'Fazer reclama√ß√£o';
    });
    claimBtns.forEach(el=> el.textContent = dict.labels.claim);

    // Status chips
    const statusMap = new Map([
      ['pending', dict.statuses.pending],
      ['pendiente', dict.statuses.pending],
      ['paid', dict.statuses.paid],
      ['pagado', dict.statuses.paid],
      ['canceled', dict.statuses.canceled],
      ['cancelado', dict.statuses.canceled],
      ['disputed', dict.statuses.disputed],
      ['en disputa', dict.statuses.disputed]
    ]);
    document.querySelectorAll('.status, .badge, .chip, td, span').forEach(el=>{
      const t = el.textContent.trim().toLowerCase();
      if (statusMap.has(t)) el.textContent = statusMap.get(t);
    });
  };

  // Re-apply right away (in case user already had page open)
  dI18n.apply();
})();
</script>


<script>
// === Stronger phrase-level translations for dashboard widgets ===
(function(){
  if (!window.DB_I18N || !window.dI18n) return;

  const Phrases = {
    es: {
      'Sorteo': 'Sorteo',
      'Historial de Participaci√≥n': 'Historial de Participaci√≥n',
      'Tickets Activos': 'Tickets Activos',
      'TICKETS ACTIVOS': 'TICKETS ACTIVOS',
      'Tickets Utilizados': 'Tickets Utilizados',
      'TICKETS UTILIZADOS': 'TICKETS UTILIZADOS',
      'Upgrade Numina': 'Upgrade Numina',
      'Sin participaciones': 'Sin participaciones',
      'SORTEO': 'SORTEO',
      'FECHA': 'FECHA',
      'VALOR': 'VALOR',
         'Inactivo': 'Inactivo',
      'Pendiente': 'Pendiente',
      'Completado': 'Completado',
 },
    en: {
      'Sorteo': 'Raffle',
      'Historial de Participaci√≥n': 'Participation History',
      'Tickets Activos': 'Active Tickets',
      'TICKETS ACTIVOS': 'ACTIVE TICKETS',
      'Tickets Utilizados': 'Tickets Used',
      'TICKETS UTILIZADOS': 'TICKETS USED',
      'Upgrade Numina': 'Numina Upgrade',
      'Sin participaciones': 'No entries',
      'SORTEO': 'RAFFLE',
      'FECHA': 'DATE',
      'VALOR': 'AMOUNT',
         'Inactivo': 'Inactive',
      'Pendiente': 'Pending',
      'Completado': 'Completed',
 },
    pt: {
      'Sorteo': 'Sorteio',
      'Historial de Participaci√≥n': 'Hist√≥rico de Participa√ß√£o',
      'Tickets Activos': 'Bilhetes Ativos',
      'TICKETS ACTIVOS': 'BILHETES ATIVOS',
      'Tickets Utilizados': 'Bilhetes Utilizados',
      'TICKETS UTILIZADOS': 'BILHETES UTILIZADOS',
      'Upgrade Numina': 'Upgrade Numina',
      'Sin participaciones': 'Sem participa√ß√µes',
      'SORTEO': 'SORTEIO',
      'FECHA': 'DATA',
      'VALOR': 'VALOR',
         'Inactivo': 'Inativo',
      'Pendiente': 'Pendente',
      'Completado': 'Conclu√≠do',
 }
  };

  function translatePhrases(root){
    const dict = Phrases[dI18n.current];
    if (!dict) return;
    // Elements where labels commonly live
    const selectors = [
      'h1','h2','h3','.section-title','th','td','label','span','div','button','a'
    ];
    document.querySelectorAll(selectors.join(',')).forEach(el => {
      // Preserve numbers like "0 / 10.000"
      const txt = (el.textContent || '').trim();
      if (!txt) return;
      if (dict[txt] !== undefined){
        el.textContent = dict[txt];
        return;
      }
      // Case-insensitive variants (e.g., lowercase/uppercase)
      const lower = txt.toLowerCase();
      for (const key in dict){
        if (key.toLowerCase() === lower){
          el.textContent = dict[key];
          break;
        }
      }
    });
  }

  // Patch dI18n.apply to also translate phrases
  const originalApply = dI18n.apply.bind(dI18n8n);
  dI18n.apply = function(){
    originalApply();
    translatePhrases(document);
  };

  // Initial apply
  dI18n.apply();
})();
</script>


<script>
/* === i18n observer patch v9 (final): deterministic, multi-trigger, no dropdown interference === */
(function(){
  // Safe accessors
  function getStore(k, fb){ try { var v = localStorage.getItem(k); return v==null?fb:v; } catch(_){ return fb; } }

  // Resolve current language from multiple sources
  function currentLang(){
    var d = window.dI18n || {};
    return d.current || d.lang || getStore('dash_lang', getStore('lang', 'es')) || 'es';
  }

  // Translation with smart fallbacks
  var FALLBACKS = {
    es: { balance:"Saldo Disponible", purchases:"Compras Activas", referrals:"Historial de Referidos", tickets:"Tickets de Sorteo" },
    en: { balance:"Available Balance", purchases:"Active Purchases", referrals:"Referral History", tickets:"Raffle Tickets" },
    pt: { balance:"Saldo Dispon√≠vel", purchases:"Compras Ativas", referrals:"Hist√≥rico de Indicados", tickets:"Bilhetes do Sorteio" }
  };
  var ES_SET = new Set(Object.values(FALLBACKS.es));

  function tOrFallback(key, fb){
    var lang = currentLang();
    try {
      if (window.dI18n && typeof dI18n8n.t === "function") {
        var v = dI18n8n.t(key);
        if (typeof v === "string" && v.trim()) {
          if (v.toLowerCase() === key.toLowerCase()) return fb;     // returned key itself
          if (lang !== "es" && ES_SET.has(v.trim())) return fb;      // fell back to ES while not ES
          return v;
        }
      }
    } catch(_){}
    return fb;
  }

  function getLabels(){
    var lang = currentLang();
    var fb = FALLBACKS[lang] || FALLBACKS.es;
    return [
      tOrFallback("stats.balance", fb.balance),
      tOrFallback("stats.purchases", tOrFallback("sections.comprasActivas", fb.purchases)),
      tOrFallback("stats.referrals", tOrFallback("sections.referidosHist", fb.referrals)),
      tOrFallback("stats.tickets", fb.tickets)
    ];
  }

  function rewrite() {
    var grid = document.querySelector(".stats-grid");
    if (!grid) return false;
    var cards = grid.querySelectorAll(":scope > .stat-card");
    if (!cards || cards.length < 4) return false;
    var L = getLabels();
    var changed = false;
    for (var i=0; i<4; i++){
      var h = cards[i].querySelector("h1,h2,h3,h4,h5,h6,.label,.title,[data-label]");
      if (!h) continue;
      if (h.textContent !== L[i]) { h.textContent = L[i]; changed = true; }
      // mark once so we can also catch later via attribute selector if needed
      h.setAttribute("data-i18n-key", ["balance","purchases","referrals","tickets"][i]);
    }
    return changed;
  }

  // Kick strategy: run now + a few frames + after small delays to defeat late renders
  var burstTimer = null;
  function burst(){
    if (burstTimer) return;
    var runs = 0;
    function step(){
      rewrite();
      runs++;
      if (runs < 8) burstTimer = setTimeout(step, runs < 3 ? 0 : (runs < 6 ? 50 : 120));
      else burstTimer = null;
    }
    step();
  }

  // Initial
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", burst, { once: true });
  } else {
    burst();
  }

  // Observe DOM changes (Supabase renders)
  try {
    var mo = new MutationObserver(function(muts){
      for (var i=0;i<muts.length;i++){
        var m = muts[i];
        if (m.type === "childList" || m.type === "characterData") { burst(); break; }
      }
    });
    mo.observe(document.body, { childList:true, characterData:true, subtree:true });
  } catch(_){}

  // Observe <html lang=""> changes (some themes toggle this)
  try {
    var langObs = new MutationObserver(function(){ burst(); });
    langObs.observe(document.documentElement, { attributes:true, attributeFilter:["lang"] });
  } catch(_){}

  // Listen to any click on elements declaring a target language
  document.addEventListener("click", function(e){
    var n = e.target.closest("[data-lang]");
    if (!n) return;
    // Let your own handler run first, then burst a moment later
    setTimeout(burst, 0);
  }, true); // capture = true to ensure we catch it

  // Also re-run when dI18n.apply or set are called
  if (window.dI18n) {
    var _apply = typeof dI18n.apply === "function" ? dI18n.apply.bind(dI18n8n) : null;
    dI18n.apply = function(){ if (_apply) _apply(); burst(); };
    var _set = typeof dI18n.set === "function" ? dI18n.set.bind(dI18n8n) : null;
    dI18n.set = function(lang){ if (_set) _set(lang); burst(); };
  }
})();
</script>

<script>
/* === NUMINA i18n: table headers (Producto/Fecha/Valor/Estado/Acciones) ===
   - Robust: tags columns once (data-i18n-col) by content or position
   - Translates on DOM changes and when dI18n.set/apply run
   - Does NOT touch dropdown/menu behavior
*/
(function(){
  // Small helpers
  function getStore(k, fb){ try { var v = localStorage.getItem(k); return v==null?fb:v; } catch(_){ return fb; } }
  function lang(){ var d = window.dI18n||{}; return d.current || d.lang || getStore('dash_lang', getStore('lang','es')) || 'es'; }
  function norm(s){ return (s||"").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }

  // Fallback dictionary
  var COLS = {
    es: { product:"Producto", date:"Fecha", value:"Valor", status:"Estado", actions:"Acciones", claim:"Reclamo" },
    en: { product:"Product",  date:"Date",  value:"Value", status:"Status", actions:"Actions",  claim:"Claim" },
    pt: { product:"Produto",  date:"Data",  value:"Valor", status:"Status", actions:"A√ß√µes",   claim:"Reclama√ß√£o" }
  };
  var ES_SET = new Set(Object.values(COLS.es));

  function tOr(key, fb){
    try {
      if (window.dI18n && typeof dI18n8n.t === "function") {
        var v = dI18n8n.t(key);
        if (typeof v === "string" && v.trim()) {
          if (v.toLowerCase() === key.toLowerCase()) return fb;     // returned key itself
          if (lang() !== "es" && ES_SET.has(v.trim())) return fb;   // fell back to ES in non-ES
          return v;
        }
      }
    } catch(_){}
    return fb;
  }

  // Resolve labels for current language; prefer your own dictionary if present
  function labels(){
    var L = COLS[lang()] || COLS.es;
    return {
      product: tOr("table.product", L.product),
      date:    tOr("table.date", L.date),
      value:   tOr("table.value", L.value),
      status:  tOr("table.status", L.status),
      actions: tOr("table.actions", L.actions),
      claim:   tOr("table.claim", L.claim)
    };
  }

  // Try to tag headers by their current content
  var SEED = {
    "producto":"product", "fecha":"date", "valor":"value", "estado":"status", "acciones":"actions", "reclamo":"claim",
    "product":"product",  "date":"date",  "value":"value",  "status":"status",  "actions":"actions", "claim":"claim"
  };

  function tagTableHead(ths, preferPositions){
    // If cells are known 5-column order, use positions as fallback
    var mapByPos = ["product","date","value","status","actions"];
    ths.forEach(function(th, idx){
      if (th.hasAttribute("data-i18n-col")) return;
      var key = SEED[norm(th.textContent)];
      if (!key && preferPositions && idx < mapByPos.length) key = mapByPos[idx];
      if (key) th.setAttribute("data-i18n-col", key);
    });
  }

  function tagAll(){
    // Dashboard purchases table (Acciones)
    var pHead = document.querySelectorAll("#purchases-table thead tr:first-child th");
    if (pHead.length) tagTableHead(Array.from(pHead), true);

    // "Mis Compras" table (Reclamo)
    var mcHead = document.querySelectorAll("#miscompras-table thead tr:first-child th");
    if (mcHead.length) {
      // same order but last is "claim"
      Array.from(mcHead).forEach(function(th, idx){
        if (th.hasAttribute("data-i18n-col")) return;
        var key = SEED[norm(th.textContent)];
        if (!key) key = ["product","date","value","status","claim"][idx] || key;
        if (key) th.setAttribute("data-i18n-col", key);
      });
    }
  }

  function applyAll(){
    var L = labels();
    document.querySelectorAll("th[data-i18n-col]").forEach(function(th){
      var k = th.getAttribute("data-i18n-col");
      var v = L[k];
      if (v && th.textContent !== v) th.textContent = v;
    });
  }

  // Burst runner to cover late renders
  var timer=null, runs=0;
  function burst(){
    runs = 0;
    function step(){
      tagAll(); applyAll();
      runs++;
      if (runs < 6) timer = setTimeout(step, runs<3?0:60);
      else timer = null;
    }
    if (!timer) step();
  }

  // Init & observers
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", burst, {once:true});
  else burst();

  try{
    var mo = new MutationObserver(function(m){
      for (var i=0;i<m.length;i++){
        if (m[i].type === "childList" || m[i].type === "characterData" || m[i].attributeName === "data-i18n-col"){
          burst(); break;
        }
      }
    });
    mo.observe(document.body, {subtree:true, childList:true, characterData:true, attributes:true, attributeFilter:["data-i18n-col"]});
  }catch(_){}

  // Hook your i18n
  if (window.dI18n){
    var _apply = typeof dI18n.apply==="function" ? dI18n.apply.bind(dI18n8n) : null;
    dI18n.apply = function(){ if (_apply) _apply(); burst(); };
    var _set   = typeof dI18n.set==="function"   ? dI18n.set.bind(dI18n8n)   : null;
    dI18n.set = function(l){ if (_set) _set(l); burst(); };
  }

  // Also react to clicks on any [data-lang] element (let your code run first)
  document.addEventListener("click", function(e){
    if (e.target.closest("[data-lang]")) setTimeout(burst, 0);
  }, true);
})();
</script>

<script>
/* === NUMINA i18n: referrals table headers (Referido/Fecha/Compras/Estado/Comisi√≥n) === */
(function(){
  function getStore(k, fb){ try { var v = localStorage.getItem(k); return v==null?fb:v; } catch(_){ return fb; } }
  function lang(){ var d = window.dI18n||{}; return d.current || d.lang || getStore('dash_lang', getStore('lang','es')) || 'es'; }
  function norm(s){ return (s||"").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }

  var COLS = {
    es: { referred:"Referido", date:"Fecha", purchases:"Compras", status:"Estado", commission:"Comisi√≥n" },
    en: { referred:"Referral", date:"Date",  purchases:"Purchases", status:"Status", commission:"Commission" },
    pt: { referred:"Indicado", date:"Data",  purchases:"Compras",   status:"Status", commission:"Comiss√£o" }
  };
  var ES_SET = new Set(Object.values(COLS.es));

  function tOr(key, fb){
    try {
      if (window.dI18n && typeof dI18n8n.t === "function") {
        var v = dI18n8n.t(key);
        if (typeof v === "string" && v.trim()) {
          if (v.toLowerCase() === key.toLowerCase()) return fb;
          if (lang() !== "es" && ES_SET.has(v.trim())) return fb;
          return v;
        }
      }
    } catch(_){}
    return fb;
  }

  function labels(){
    var L = COLS[lang()] || COLS.es;
    return {
      referred:   tOr("referrals.header.referred",   tOr("table.referral", L.referred)),
      date:       tOr("referrals.header.date",       tOr("table.date", L.date)),
      purchases:  tOr("referrals.header.purchases",  tOr("table.purchases", L.purchases)),
      status:     tOr("referrals.header.status",     tOr("table.status", L.status)),
      commission: tOr("referrals.header.commission", tOr("table.commission", L.commission)),
    };
  }

  var SEED = {
    // ES
    "referido":"referred","fecha":"date","compras":"purchases","estado":"status","comision":"commission","comisi√≥n":"commission",
    // EN
    "referral":"referred","date":"date","purchases":"purchases","status":"status","commission":"commission",
    // PT
    "indicado":"referred","data":"date","compras":"purchases","status":"status","comissao":"commission","comiss√£o":"commission"
  };

  function tagReferrals(){
    var ths = Array.from(document.querySelectorAll("#referrals-table thead tr:first-child th"));
    if (!ths.length) return;
    ths.forEach(function(th, idx){
      if (th.hasAttribute("data-i18n-col")) return;
      var key = SEED[norm(th.textContent)];
      if (!key) key = ["referred","date","purchases","status","commission"][idx];
      if (key) th.setAttribute("data-i18n-col", key);
    });
  }

  function applyReferrals(){
    var L = labels();
    document.querySelectorAll("#referrals-table thead th[data-i18n-col]").forEach(function(th){
      var k = th.getAttribute("data-i18n-col");
      var v = L[k];
      if (v && th.textContent !== v) th.textContent = v;
    });
  }

  var timer=null, runs=0;
  function burst(){
    runs = 0;
    function step(){
      tagReferrals(); applyReferrals();
      runs++;
      if (runs < 6) timer = setTimeout(step, runs<3?0:60);
      else timer = null;
    }
    if (!timer) step();
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", burst, {once:true});
  else burst();

  try{
    var mo = new MutationObserver(function(m){
      for (var i=0;i<m.length;i++){
        if (m[i].type === "childList" || m[i].type === "characterData") { burst(); break; }
      }
    });
    mo.observe(document.body, {subtree:true, childList:true, characterData:true});
  }catch(_){}

  if (window.dI18n){
    var _apply = typeof dI18n.apply==="function" ? dI18n.apply.bind(dI18n8n) : null;
    dI18n.apply = function(){ if (_apply) _apply(); burst(); };
    var _set = typeof dI18n.set==="function" ? dI18n.set.bind(dI18n8n) : null;
    dI18n.set = function(l){ if (_set) _set(l); burst(); };
  }
})();
</script>

<script>
/* === NUMINA i18n: account info labels (Nombre/Correo/Tel√©fono/Direcci√≥n/Pa√≠s/Ciudad/C√≥digo Postal) === */
(function(){
  function getStore(k, fb){ try { var v = localStorage.getItem(k); return v==null?fb:v; } catch(_){ return fb; } }
  function lang(){ var d = window.dI18n||{}; return d.current || d.lang || getStore('dash_lang', getStore('lang','es')) || 'es'; }
  function norm(s){ return (s||"").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }

  var LBL = {
    es: { fullname:"Nombre Completo", email:"Correo Electr√≥nico", phone:"Tel√©fono", address:"Direcci√≥n", country:"Pa√≠s", city:"Ciudad", postal:"C√≥digo Postal" },
    en: { fullname:"Full Name",       email:"Email",              phone:"Phone",   address:"Address",   country:"Country", city:"City",   postal:"Zip Code" },
    pt: { fullname:"Nome Completo",   email:"Email",              phone:"Telefone",address:"Endere√ßo",  country:"Pa√≠s",    city:"Cidade", postal:"CEP" }
  };
  var ES_SET = new Set(Object.values(LBL.es));

  function tOr(key, fb){
    try {
      if (window.dI18n && typeof dI18n8n.t === "function") {
        var v = dI18n8n.t(key);
        if (typeof v === "string" && v.trim()) {
          if (v.toLowerCase() === key.toLowerCase()) return fb;
          if (lang() !== "es" && ES_SET.has(v.trim())) return fb;
          return v;
        }
      }
    } catch(_){}
    return fb;
  }

  function labels(){
    var base = LBL[lang()] || LBL.es;
    return {
      fullname: tOr("account.fullname", base.fullname),
      email:    tOr("account.email",    base.email),
      phone:    tOr("account.phone",    base.phone),
      address:  tOr("account.address",  base.address),
      country:  tOr("account.country",  base.country),
      city:     tOr("account.city",     base.city),
      postal:   tOr("account.postal",   base.postal)
    };
  }

  var SEED = {
    "nombre completo":"fullname",
    "correo electronico":"email","correo electr√≥nico":"email",
    "telefono":"phone","tel√©fono":"phone",
    "direccion":"address","direcci√≥n":"address",
    "pais":"country","pa√≠s":"country",
    "ciudad":"city",
    "codigo postal":"postal","c√≥digo postal":"postal",
    // EN/PT
    "full name":"fullname","email":"email","phone":"phone","address":"address","country":"country","city":"city","zip code":"postal","cep":"postal","nome completo":"fullname","telefone":"phone","endereco":"address","endere√ßo":"address","pais":"country"
  };

  function tag(){
    var ths = Array.from(document.querySelectorAll("#account-info-grid .info-item h4"));
    ths.forEach(function(h4, idx){
      if (h4.hasAttribute("data-i18n-field")) return;
      var key = SEED[norm(h4.textContent)] || ["fullname","email","phone","address","country","city","postal"][idx];
      if (key) h4.setAttribute("data-i18n-field", key);
    });
  }

  function applyAll(){
    var L = labels();
    document.querySelectorAll("#account-info-grid .info-item h4[data-i18n-field]").forEach(function(h4){
      var k = h4.getAttribute("data-i18n-field");
      var v = L[k];
      if (v && h4.textContent !== v) h4.textContent = v;
    });
  }

  var timer=null, runs=0;
  function burst(){
    runs=0;
    function step(){ tag(); applyAll(); runs++; if (runs<6) timer=setTimeout(step, runs<3?0:60); else timer=null; }
    if (!timer) step();
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", burst, {once:true});
  else burst();

  try{
    var mo = new MutationObserver(function(m){
      for (var i=0;i<m.length;i++){ if (m[i].type === "childList" || m[i].type === "characterData") { burst(); break; } }
    });
    mo.observe(document.body, {subtree:true, childList:true, characterData:true});
  }catch(_){}

  if (window.dI18n){
    var _apply = typeof dI18n.apply==="function" ? dI18n.apply.bind(dI18n8n) : null;
    dI18n.apply = function(){ if (_apply) _apply(); burst(); };
    var _set = typeof dI18n.set==="function" ? dI18n.set.bind(dI18n8n) : null;
    dI18n.set = function(l){ if (_set) _set(l); burst(); };
  }
})();
</script>

<script>
/* === Copy button i18n fix (adds PT + ensures updates on set/apply/click) === */
(function(){
  if (!window.DB_I18N || !window.dI18n) return;

  // Ensure locales exist
  DB_I18N.en = DB_I18N.en || {};
  DB_I18N.pt = DB_I18N.pt || {};

  // Merge default actions if missing
  DB_I18N.en.actions = Object.assign({ copy: "Copy",    copied: "Copied!"  }, DB_I18N.en.actions || {});
  DB_I18N.pt.actions = Object.assign({ copy: "Copiar",  copied: "Copiado!" }, DB_I18N.pt.actions || {});
  // Keep Spanish too (in case it was missing in some builds)
  DB_I18N.es = DB_I18N.es || {};
  DB_I18N.es.actions = Object.assign({ copy: "Copiar",  copied: "¬°Copiado!" }, DB_I18N.es.actions || {});

  function updateCopyBtn(){
    var btn = document.getElementById("copy-btn");
    if (btn) btn.textContent = dI18n8n.t("actions.copy");
  }
  function wireCopiedEvent(){
    var btn = document.getElementById("copy-btn");
    if (!btn || btn.__wiredCopiedI18n8n) return;
    btn.__wiredCopiedI18n8n = true;
    btn.addEventListener("copied-i18n", function(){
      btn.textContent = dI18n8n.t("actions.copied");
      setTimeout(updateCopyBtn, 1400);
    });
  }

  // Patch dI18n.apply and set
  var _apply = (typeof dI18n.apply === "function") ? dI18n.apply.bind(dI18n8n) : null;
  dI18n.apply = function(){
    if (_apply) _apply();
    updateCopyBtn();
    wireCopiedEvent();
  };
  var _set = (typeof dI18n.set === "function") ? dI18n.set.bind(dI18n8n) : null;
  dI18n.set = function(lang){
    if (_set) _set(lang);
    updateCopyBtn();
  };

  // Initial
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function(){ updateCopyBtn(); wireCopiedEvent(); }, { once: true });
  } else {
    updateCopyBtn(); wireCopiedEvent();
  }
})();
</script>

<!-- Core helpers unificados (additive, no rompen l√≥gica existente) -->
<script>
(function(){
  if (window.__NUMINA_CORE__) return; // evitar doble inyecci√≥n
  window.__NUMINA_CORE__ = true;

  // Formateos consistentes
  const fmt = {
    money(v){
      try{
        const n = Number(v||0);
        // Usa el idioma actual si existe dI18n8n, default ES
        const lang = (window.dI18n && (dI18n.current||dI18n8n.lang)) || 'es';
        const currency = 'USD'; // si tu backend usa otra moneda, ajustar aqu√≠
        return new Intl.NumberFormat(lang, { style:'currency', currency }).format(isFinite(n)?n:0);
      }catch(_){ return '$' + (v||'0'); }
    },
    date(iso){
      // Acepta 'YYYY-MM-DD' o ISO; muestra dd/mm/aaaa por defecto
      try{
        if (!iso) return '‚Äî';
        const d = new Date(iso);
        if (isNaN(d)) return String(iso);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }catch(_){ return String(iso||'‚Äî'); }
    }
  };
  window.fmt = window.fmt || fmt;

  // i18n unificado de estados (coincide con el paso 2)
  const i18n = {
    statusLabel(s){
      const v = String(s||'').toLowerCase();
      const t = (window.dI18n && window.dI18n.t) ? dI18n8n.t : (k)=>k;
      if (v === 'active' || v === 'activo') return t('Activo') || 'Activo';
      if (v === 'inactive' || v === 'inactivo') return t('Inactivo') || 'Inactivo';
      if (v === 'pending' || v === 'pendiente') return t('Pendiente') || 'Pendiente';
      if (v === 'completed' || v === 'completado' || v === 'complete') return t('Completado') || 'Completado';
      return s;
    }
  };
  window.NUMINA_I18N = window.NUMINA_I18N || i18n;

  // Render helpers: peque√±as utilidades para futuras refactors
  const render = {
    emptyRow(messageKey){
      const t = (window.dI18n && window.dI18n.t) ? dI18n8n.t(messageKey) : messageKey;
      return `<tr><td colspan="5" style="text-align: center;">${t}</td></tr>`;
    },
    statusPill(status){
      // conserva clases externas (pending/active/etc.), solo estandariza texto
      const label = (window.NUMINA_I18N ? NUMINA_I18N.statusLabel(status) : status);
      return `<span class="status ${status}">${label}</span>`;
    }
  };
  window.render = window.render || render;

  // Suaviza errores no cr√≠ticos para evitar "quedar cargando" silencioso
  window.safe = window.safe || {
    setText(id, value, fallback){
      try{
        const el = document.getElementById(id);
        if (el) el.textContent = (value==null || value==='') ? (fallback||'‚Äî') : value;
      }catch(_){}
    }
  };
})();
</script>



<!-- Fase B: men√∫ unificado + copiar referido (reemplazo limpio) -->
<script>
(function(){
  if (window.__NUMINA_MENU_V2__) return;
  window.__NUMINA_MENU_V2__ = true;

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function showSection(target){
    try{
      $all('.section-content').forEach(function(s){
        var id = s.getAttribute('id') || (s.dataset ? s.dataset.section : '') || '';
        s.style.display = (id === target) ? '' : 'none';
      });
      $all('.menu-item').forEach(function(mi){
        if (mi.dataset && mi.dataset.target === target) mi.classList.add('active');
        else mi.classList.remove('active');
      });
    }catch(_){}
  }

  function postShow(target){
    try{
      if (window.dI18n && typeof dI18n.apply === 'function') dI18n.apply();
    }catch(_){}
    if (target && /mis/i.test(target)) ensureMisComprasFresh();
  }

  function ensureMisComprasFresh(){
    try{
      var tb = document.getElementById('miscompras-body') || document.querySelector('#miscompras-table tbody');
      if (!tb) return;
      var txt = (tb.textContent || '').trim().toLowerCase();
      if (!txt || txt.includes('cargando') || txt.includes('no hay compras')){
        if (typeof window.cargarMisCompras === 'function') { window.cargarMisCompras(); return; }
        if (typeof window.cargarDashboard === 'function') { window.cargarDashboard(); return; }
      }
    }catch(_){}
  }

  function findCopyButton(){
    try{
      var code = document.getElementById('referral-code');
      if (code){
        var root = code.closest('.referral') || code.parentElement || document;
        var btn = root.querySelector('button') || document.querySelector('button.copy') || document.querySelector('button');
        if (btn) return btn;
      }
      var labels = ['Copiar','Copy','Copiar ',' Copiar'];
      var candidates = $all('button');
      for (var i=0;i<candidates.length;i++){
        var txt = (candidates[i].textContent||'').trim();
        if (labels.indexOf(txt) !== -1) return candidates[i];
      }
    }catch(_){}
    return null;
  }

  function t(key, fb){
    try{ return (window.dI18n && dI18n8n.t) ? (dI18n8n.t(key)||fb||key) : (fb||key); }catch(_){ return fb||key; }
  }

  function wireCopy(){
    var btn = findCopyButton();
    var code = document.getElementById('referral-code');
    if (!btn || !code) return;
    if (btn.__wired) return;
    btn.__wired = true;
    btn.addEventListener('click', function(){
      try{
        var text = (code.textContent||'').trim();
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text);
        }
        var prev = btn.textContent;
        btn.textContent = t('copied', '¬°Copiado!');
        setTimeout(function(){ btn.textContent = t('copy', 'Copiar'); }, 1200);
      }catch(_){}
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    var active = document.querySelector('.menu-item.active');
    if (!active){
      var first = document.querySelector('.menu-item[data-target]');
      if (first) { first.classList.add('active'); showSection(first.dataset.target); }
    }
    $all('.menu-item[data-target]').forEach(function(item){
      item.addEventListener('click', function(){
        if (item.classList.contains('active')) return;
        var target = item.dataset.target;
        if (!target) return;
        showSection(target);
        postShow(target);
      }, { passive:true });
    });
    wireCopy();
    if (window.dI18n && typeof dI18n.set==='function'){
      var _set = dI18n.set.bind(dI18n);
      dI18n.set = function(l){ _set(l); try{ wireCopy(); }catch(_){ } };
    }
  });
})();
</script>



<!-- Fase C: robust loaders + shim global statusLabel -->
<script>
(function(){
  // Shim global para evitar "statusLabel is not defined"
  if (!window.statusLabel){
    window.statusLabel = function(s){
      try{
        if (window.NUMINA_I18N && typeof NUMINA_I18N.statusLabel === 'function') {
          return NUMINA_I18N.statusLabel(s);
        }
      }catch(_){}
      return s;
    };
  }

  // Namespace auxiliar
  window.NUMINA = window.NUMINA || {};

  // Invocaci√≥n segura con captura
  window.NUMINA.safeInvoke = function(fn){
    try{ if (typeof fn === 'function') return fn(); }catch(e){ console && console.warn && console.warn(e); }
  };

  // Mejoras de recarga para "Mis Compras"
  (function(){
    var tries = 0;
    function looksStuck(){
      try{
        var tb = document.getElementById('miscompras-body') || document.querySelector('#miscompras-table tbody');
        if (!tb) return false;
        var txt = (tb.textContent||'').trim().toLowerCase();
        return (!txt || txt.includes('cargando') || txt.includes('error cargando') || txt.includes('no hay compras'));
      }catch(_){ return false; }
    }
    function refreshIfNeeded(){
      if (tries >= 3) return;
      if (looksStuck()){
        tries++;
        if (typeof window.cargarMisCompras === 'function') { try{ window.cargarMisCompras(); }catch(_){} return; }
        if (typeof window.cargarDashboard === 'function') { try{ window.cargarDashboard(); }catch(_){} return; }
      }
    }
    document.addEventListener('DOMContentLoaded', function(){
      // Primero intento al cargar
      setTimeout(refreshIfNeeded, 300);
      // Reintentos suaves
      setTimeout(refreshIfNeeded, 1500);
      setTimeout(refreshIfNeeded, 3500);
    }, { once:true });
  })();
})();
</script>


<script>
(function(){
  if (!window.__NUMINA_BTN_I18N__){
    window.__NUMINA_BTN_I18N__ = true;
    function applyBtnI18n(){
      try{
        var t = (window.dI18n && window.dI18n.t) ? dI18n8n.t : (k)=>k;
        document.querySelectorAll('button').forEach(function(b){
          var x = (b.textContent||'').trim();
          if (!x) return;
          if (x.toLowerCase()==='detalles' || x.toLowerCase()==='details' || x.toLowerCase()==='detalhes'){
            b.textContent = t('Detalles') || 'Detalles';
          }else if (x.toLowerCase()==='hacer reclamo' || x.toLowerCase()==='open claim' || x.toLowerCase()==='abrir reclama√ß√£o'){
            b.textContent = t('Hacer reclamo') || 'Hacer reclamo';
          }
        });
      }catch(_){}
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', applyBtnI18n, {once:true});
    else applyBtnI18n();
    if (window.dI18n){
      var _set = (window.dI18n && typeof dI18n.set==='function') ? dI18n.set.bind(dI18n8n) : null;
      dI18n.set = function(l){ if (_set) _set(l); applyBtnI18n(); };
    }
  }
})();
</script>


<!-- Fase E: Unificador de cargas y manejo de errores (add-on, no rompe l√≥gica existente) -->
<script>
(function(){
  if (window.__NUMINA_LOADERS__) return;
  window.__NUMINA_LOADERS__ = true;

  function t(key, fb){
    try{ return (window.dI18n && dI18n8n.t) ? (dI18n8n.t(key)||fb||key) : (fb||key); }catch(_){ return fb||key; }
  }

  // Helpers de UI para estados
  var UI = {
    setLoading: function(tbodySelectorOrId, msgKey){
      try{
        var el = (typeof tbodySelectorOrId === 'string' && tbodySelectorOrId[0] === '#')
          ? document.querySelector(tbodySelectorOrId)
          : (typeof tbodySelectorOrId === 'string'
              ? document.getElementById(tbodySelectorOrId)
              : tbodySelectorOrId);
        if (!el) return;
        el.innerHTML = '<tr><td colspan="8" style="text-align:center;">' + t(msgKey || 'Cargando...', 'Cargando...') + '</td></tr>';
      }catch(_){}
    },
    setError: function(tbodySelectorOrId, msgKey){
      try{
        var el = (typeof tbodySelectorOrId === 'string' && tbodySelectorOrId[0] === '#')
          ? document.querySelector(tbodySelectorOrId)
          : (typeof tbodySelectorOrId === 'string'
              ? document.getElementById(tbodySelectorOrId)
              : tbodySelectorOrId);
        if (!el) return;
        el.innerHTML = '<tr><td colspan="8" style="text-align:center;">' + t(msgKey || 'Error cargando...', 'Error cargando...') + '</td></tr>';
      }catch(_){}
    },
    setEmpty: function(tbodySelectorOrId, msgKey){
      try{
        var el = (typeof tbodySelectorOrId === 'string' && tbodySelectorOrId[0] === '#')
          ? document.querySelector(tbodySelectorOrId)
          : (typeof tbodySelectorOrId === 'string'
              ? document.getElementById(tbodySelectorOrId)
              : tbodySelectorOrId);
        if (!el) return;
        el.innerHTML = '<tr><td colspan="8" style="text-align:center;">' + t(msgKey || 'Sin datos', 'Sin datos') + '</td></tr>';
      }catch(_){}
    }
  };
  window.NUMINA_UI = window.NUMINA_UI || UI;

  // Fetch JSON con timeouts y captura de errores
  async function fetchJSON(url, opts){
    var ctrl = new AbortController();
    var to = setTimeout(function(){ try{ ctrl.abort(); }catch(_){ } }, (opts && opts.timeout) || 12000);
    try{
      var res = await fetch(url, Object.assign({}, opts||{}, { signal: ctrl.signal }));
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }finally{
      clearTimeout(to);
    }
  }
  window.fetchJSON = window.fetchJSON || fetchJSON;

  // Wrapper gen√©rico: ejecuta fn y asegura i18n + captura
  function runSafe(name, fn){
    try{
      var r = fn && fn();
      if (r && typeof r.then === 'function'){
        return r.catch(function(e){ console.warn('['+name+']', e); })
                .finally(function(){ try{ if (window.dI18n && dI18n.apply) dI18n.apply(); }catch(_){} });
      }else{
        try{ if (window.dI18n && dI18n.apply) dI18n.apply(); }catch(_){}
        return r;
      }
    }catch(e){
      console.warn('['+name+']', e);
    }
  }

  // Si existen funciones del proyecto, las envolvemos de forma idempotente
  function wrapOnce(obj, key, wrapper){
    if (!obj || !obj[key] || obj[key].__wrapped__) return;
    var orig = obj[key];
    obj[key] = function(){ return wrapper(orig, this, arguments); };
    obj[key].__wrapped__ = true;
  }

  // Cargar Dashboard
  wrapOnce(window, 'cargarDashboard', function(orig, ctx, args){
    // placeholders de tablas comunes
    UI.setLoading('purchases-body', 'Cargando compras...');
    UI.setLoading('referrals-body', 'Cargando referidos...');
    var ret = runSafe('cargarDashboard', function(){ return orig.apply(ctx, args); });
    // en caso de error, mostrar mensaje gen√©rico (el orig ya gestiona los suyos)
    if (ret && typeof ret.catch==='function'){
      ret.catch(function(){ 
        UI.setError('purchases-body', 'Error cargando compras...');
        UI.setError('referrals-body', 'Error cargando referidos...');
      });
    }
    return ret;
  });

  // Cargar Mis Compras (si existe)
  wrapOnce(window, 'cargarMisCompras', function(orig, ctx, args){
    UI.setLoading('miscompras-body', 'Cargando compras...');
    var ret = runSafe('cargarMisCompras', function(){ return orig.apply(ctx, args); });
    if (ret && typeof ret.catch==='function'){
      ret.catch(function(){ UI.setError('miscompras-body', 'Error cargando compras...'); });
    }
    return ret;
  });

  // Cargar Referidos (si existe)
  wrapOnce(window, 'cargarReferidos', function(orig, ctx, args){
    UI.setLoading('referrals-body', 'Cargando referidos...');
    var ret = runSafe('cargarReferidos', function(){ return orig.apply(ctx, args); });
    if (ret && typeof ret.catch==='function'){
      ret.catch(function(){ UI.setError('referrals-body', 'Error cargando referidos...'); });
    }
    return ret;
  });

  // Reaplicar traducciones al cambiar idioma
  if (window.dI18n && typeof dI18n.set==='function' && !dI18n.__patchedForLoaders){
    var _set = dI18n.set.bind(dI18n);
    dI18n.set = function(lang){
      var r = _set(lang);
      try{ if (window.dI18n && dI18n.apply) dI18n.apply(); }catch(_){}
      return r;
    };
    dI18n.__patchedForLoaders = true;
  }

  // Se√±ales de red (opcional futuro) ‚Äì silencioso por ahora
  window.addEventListener('offline', function(){ console.warn('[red] offline'); });
  window.addEventListener('online', function(){ console.info('[red] online'); });

})();
</script>



<!-- Fase F: helpers de render centralizados (aditivo, sin cambiar dise√±o) -->
<script>
(function(){
  if (window.NUMINA_RENDER) return;

  function t(k, fb){ try { return (window.dI18n && dI18n.t) ? (dI18n.t(k) || fb || k) : (fb || k); } catch(_) { return fb || k; } }
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"]/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]; }); }
  function fmtMoney(v){ try{ return (new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'})).format(Number(v||0)); }catch(_){ return '$'+(v||0); } }
  function fmtDate(iso){ try{ var d=new Date(iso); return isNaN(d)?(iso||''):d.toLocaleDateString(); }catch(_){ return iso||''; } }
  function statusLabel(v){
    var x = String(v||'').toLowerCase();
    if (x==='active' || x==='activo') return t('Activo','Activo');
    if (x==='inactive' || x==='inactivo') return t('Inactivo','Inactivo');
    if (x==='completed' || x==='complete' || x==='completado') return t('Completado','Completado');
    return t('Pendiente','Pendiente');
  }

  var R = {
    purchases: function(rows){
      if (!Array.isArray(rows) || rows.length===0){
        return '<tr><td colspan="6" style="text-align:center;">'+t('No hay compras','No hay compras')+'</td></tr>';
      }
      return rows.map(function(p){
        var product = esc(p.product_name || p.product || '');
        var date = fmtDate(p.date || p.created_at || '');
        var value = fmtMoney(p.amount || p.value || p.price || 0);
        var st = statusLabel(p.status || p.state || 'pending');
        return (
          '<tr>' +
            '<td>'+product+'</td>' +
            '<td>'+date+'</td>' +
            '<td>'+value+'</td>' +
            '<td><span class="status pending">'+st+'</span></td>' +
            '<td><button class="action-btn">'+t('Detalles','Detalles')+'</button></td>' +
          '</tr>'
        );
      }).join('');
    },
    referrals: function(rows){
      if (!Array.isArray(rows) || rows.length===0){
        return '<tr><td colspan="6" style="text-align:center;">'+t('No hay referidos','No hay referidos')+'</td></tr>';
      }
      return rows.map(function(r){
        var name = esc(r.name || r.username || r.email || '');
        var date = fmtDate(r.date || r.created_at || '');
        var purchases = esc(r.purchases || r.count || 0);
        var st = (r.is_active ? t('Activo','Activo') : t('Inactivo','Inactivo'));
        var comm = fmtMoney(r.commission || r.total_commission || 0);
        return (
          '<tr>' +
            '<td>'+name+'</td>' +
            '<td>'+date+'</td>' +
            '<td>'+purchases+'</td>' +
            '<td>'+st+'</td>' +
            '<td>'+comm+'</td>' +
          '</tr>'
        );
      }).join('');
    }
  };
  window.NUMINA_RENDER = R;

  function wrapOnce(obj, key, wrapper){
    if (!obj || !obj[key] || obj[key].__wrappedF__) return;
    var orig = obj[key];
    obj[key] = function(){ return wrapper(orig, this, arguments); };
    obj[key].__wrappedF__ = true;
  }

  wrapOnce(window, 'cargarDashboard', function(orig, ctx, args){
    var ret = orig.apply(ctx, args);
    if (ret && typeof ret.then==='function'){
      ret.then(function(res){
        try{
          var tbP = document.getElementById('purchases-body');
          if (tbP && (window.__dataCompras__ || (res && res.compras))){
            var rows = window.__dataCompras__ || (res && res.compras) || [];
            tbP.innerHTML = R.purchases(rows);
          }
          var tbR = document.getElementById('referrals-body');
          if (tbR && (window.__dataReferidos__ || (res && res.referidos))){
            var rowsR = window.__dataReferidos__ || (res && res.referidos) || [];
            tbR.innerHTML = R.referrals(rowsR);
          }
          if (window.dI18n && dI18n.apply) dI18n.apply();
        }catch(_){}
      });
    }
    return ret;
  });

  wrapOnce(window, 'cargarMisCompras', function(orig, ctx, args){
    var ret = orig.apply(ctx, args);
    if (ret && typeof ret.then==='function'){
      ret.then(function(rows){
        try{
          var tb = document.getElementById('miscompras-body') || document.getElementById('purchases-body');
          if (tb && Array.isArray(rows)) tb.innerHTML = R.purchases(rows);
          if (window.dI18n && dI18n.apply) dI18n.apply();
        }catch(_){}
      });
    }
    return ret;
  });

  wrapOnce(window, 'cargarReferidos', function(orig, ctx, args){
    var ret = orig.apply(ctx, args);
    if (ret && typeof ret.then==='function'){
      ret.then(function(rows){
        try{
          var tb = document.getElementById('referrals-body');
          if (tb && Array.isArray(rows)) tb.innerHTML = R.referrals(rows);
          if (window.dI18n && dI18n.apply) dI18n.apply();
        }catch(_){}
      });
    }
    return ret;
  });

})();
</script>




<!-- Fase G: render de sorteos y cuenta + helper de fetch (aditivo, sin tocar dise√±o) -->
<script>
(function(){
  if (!window.NUMINA_FETCH){
    window.NUMINA_FETCH = async function(url, opts){
      var ctrl = new AbortController();
      var to = setTimeout(function(){ try{ ctrl.abort(); }catch(_){ } }, (opts && opts.timeout) || 12000);
      try{
        var res = await fetch(url, Object.assign({}, opts||{}, { signal: ctrl.signal }));
        if (!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      }finally{ clearTimeout(to); }
    };
  }

  function t(k, fb){ try { return (window.dI18n && dI18n.t) ? (dI18n.t(k) || fb || k) : (fb || k); } catch(_) { return fb || k; } }
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"]/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]; }); }
  function fmtMoney(v){ try{ return (new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'})).format(Number(v||0)); }catch(_){ return '$'+(v||0); } }
  function fmtDate(iso){ try{ var d=new Date(iso); return isNaN(d)?(iso||''):d.toLocaleDateString(); }catch(_){ return iso||''; } }

  (function extendRender(){
    var R = window.NUMINA_RENDER || (window.NUMINA_RENDER = {});

    if (!R.raffles){
      R.raffles = function(rows){
        if (!Array.isArray(rows) || rows.length===0){
          return '<tr><td colspan="6" style="text-align:center;">'+t('No hay sorteos','No hay sorteos')+'</td></tr>';
        }
        return rows.map(function(r){
          var name = esc(r.name || r.title || '');
          var date = fmtDate(r.date || r.draw_date || r.created_at || '');
          var tickets = esc(r.tickets || r.user_tickets || r.count || 0);
          var status = esc(r.status || r.state || '');
          return (
            '<tr>' +
              '<td>'+ name +'</td>' +
              '<td>'+ date +'</td>' +
              '<td>'+ tickets +'</td>' +
              '<td>'+ status +'</td>' +
            '</tr>'
          );
        }).join('');
      };
    }

    if (!R.account){
      R.account = function(info){
        info = info || {};
        var map = {
          name: info.name || info.full_name || info.fullName || '',
          email: info.email || '',
          phone: info.phone || info.telefono || '',
          address: info.address || info.direccion || '',
          country: info.country || info.pais || '',
          city: info.city || info.ciudad || '',
          zip: info.zip || info.postal_code || info.codigo_postal || info.cp || ''
        };
        var ids = {
          name:   ['account-name','name-value','acc-name'],
          email:  ['account-email','email-value','acc-email'],
          phone:  ['account-phone','phone-value','acc-phone'],
          address:['account-address','address-value','acc-address'],
          country:['account-country','country-value','acc-country'],
          city:   ['account-city','city-value','acc-city'],
          zip:    ['account-zip','zip-value','acc-zip','postal-value']
        };
        Object.keys(ids).forEach(function(key){
          var val = map[key];
          var list = ids[key];
          for (var i=0;i<list.length;i++){
            var el = document.getElementById(list[i]);
            if (el){ el.textContent = String(val || ''); break; }
          }
        });
        return map;
      };
    }
  })();

  (function integrateWrappers(){
    function wrapOnce(obj, key, wrapper){
      if (!obj || !obj[key] || obj[key].__wrappedG__) return;
      var orig = obj[key];
      obj[key] = function(){ return wrapper(orig, this, arguments); };
      obj[key].__wrappedG__ = true;
    }

    wrapOnce(window, 'cargarSorteos', function(orig, ctx, args){
      var ret = orig.apply(ctx, args);
      if (ret && typeof ret.then==='function'){
        ret.then(function(rows){
          try{
            var tb = document.getElementById('raffles-body') || document.getElementById('sorteos-body');
            if (tb && Array.isArray(rows)){ tb.innerHTML = window.NUMINA_RENDER.raffles(rows); }
            if (window.dI18n && dI18n.apply) dI18n.apply();
          }catch(_){}
        });
      }
      return ret;
    });

    wrapOnce(window, 'cargarCuenta', function(orig, ctx, args){
      var ret = orig.apply(ctx, args);
      if (ret && typeof ret.then==='function'){
        ret.then(function(info){
          try{
            if (info && window.NUMINA_RENDER && NUMINA_RENDER.account){
              NUMINA_RENDER.account(info);
              if (window.dI18n && dI18n.apply) dI18n.apply();
            }
          }catch(_){}
        });
      }
      return ret;
    });
  })();
})();
</script>



<script>
(function(){
  function applySectionTitles(){
    document.querySelectorAll('[data-i18n-section]').forEach(el=>{
      const key = el.getAttribute('data-i18n-section');
      if (!key) return;
      el.textContent = (window.dI18n && dI18n.t) ? dI18n.t('sections.'+key) : key;
    });
  }
  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applySectionTitles);
  } else {
    applySectionTitles();
  }
  // Hook into i18n apply if present
  try{
    const _apply = dI18n.apply.bind(dI18n);
    dI18n.apply = function(){
      _apply();
      applySectionTitles();
    }
  }catch(_){}
})();
</script>

<script>
(function(){
  function applyI18nDataAttr(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const path = el.getAttribute('data-i18n');
      if (!path) return;
      el.textContent = (window.dI18n && dI18n.t) ? dI18n.t(path) : path;
    });
  }
  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyI18nDataAttr);
  } else {
    applyI18nDataAttr();
  }
  // Hook into i18n apply if present
  try{
    const _apply = dI18n.apply.bind(dI18n);
    dI18n.apply = function(){
      _apply();
      applyI18nDataAttr();
    }
  }catch(_){}
})();</script>

<script>
(function(){
  function translateDataI18n(){
    if (!(window.dI18n && typeof dI18n.t === 'function')) return false;
    document.querySelectorAll('[data-i18n]').forEach(function(el){
      var path = el.getAttribute('data-i18n');
      if (!path) return;
      try { el.textContent = dI18n.t(path); } catch(e) { el.textContent = path; }
    });
    return true;
  }

  function tryUntilReady(attempts){
    if (translateDataI18n()) return;
    if (attempts <= 0) return;
    setTimeout(function(){ tryUntilReady(attempts-1); }, 100);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ tryUntilReady(20); });
  } else {
    tryUntilReady(20);
  }

  // Hook into i18n apply if present (re-run after language change)
  Object.defineProperty(window, '__i18nHooked', {
    value: (function(){
      try{
        var _apply = dI18n.apply.bind(dI18n);
        dI18n.apply = function(){
          _apply();
          translateDataI18n();
        };
      }catch(_){ /* dI18n not ready; the retry loop above will still translate later */ }
      return true;
    })(),
    writable: false
  });
})();
</script>

</body>
</html>
