<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NUMINA | Dashboard</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    /* (Mantengo todo igual, omitido aquí por brevedad) */
    /* Copiá y pega el CSS que ya tenías, no lo repito para ahorrar espacio */
  </style>
</head>
<body>
  <!-- Header -->
  <header class="dashboard-header">
    <div class="logo">NUMINA</div>
    <div class="user-menu">
      <div id="user-avatar" class="user-avatar">JD</div>
    </div>
  </header>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <ul class="sidebar-menu">
        <li class="menu-item active">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </li>
        <li class="menu-item">
          <i class="fas fa-shopping-bag"></i>
          <span>Mis Compras</span>
        </li>
        <li class="menu-item">
          <i class="fas fa-ticket-alt"></i>
          <span>Sorteos</span>
        </li>
        <li class="menu-item">
          <i class="fas fa-users"></i>
          <span>Referidos</span>
        </li>
        <li class="menu-item">
          <i class="fas fa-wallet"></i>
          <span>Billetera</span>
        </li>
        <li class="menu-item">
          <i class="fas fa-cog"></i>
          <span>Configuración</span>
        </li>
        <li class="menu-item" id="logout-button">
          <i class="fas fa-sign-out-alt"></i>
          <span>Cerrar Sesión</span>
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Welcome Banner -->
      <section class="welcome-banner">
        <div class="welcome-text">
          <h2 id="welcome-name">Bienvenido, Juan Delgado</h2>
          <p id="welcome-level">Nivel Oro | Miembro desde: 15/03/2023</p>
        </div>
        <div class="referral-code">
          <i class="fas fa-user-plus"></i>
          <span id="referral-code">CODIGO123</span>
          <button class="copy-btn">Copiar</button>
        </div>
      </section>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Saldo Disponible</h3>
          <div class="value" id="saldo-disponible">$4,250.00</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i>
            <span>12% este mes</span>
          </div>
        </div>

        <div class="stat-card">
          <h3>Compras Activas</h3>
          <div class="value" id="compras-activas">3</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i>
            <span>1 nueva</span>
          </div>
        </div>

        <div class="stat-card">
          <h3>Referidos</h3>
          <div class="value" id="referidos-count">27</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i>
            <span>5 nuevos</span>
          </div>
        </div>

        <div class="stat-card">
          <h3>Tickets de Sorteo</h3>
          <div class="value" id="tickets-sorteo">15</div>
          <div class="change negative">
            <i class="fas fa-arrow-down"></i>
            <span>2 usados</span>
          </div>
        </div>
      </div>

      <!-- (Resto del contenido lo dejamos igual, ya que es estático o se podría mejorar luego) -->

      <!-- Account Information -->
      <h2 class="section-title">
        <i class="fas fa-user-circle"></i>
        <span>Información de la Cuenta</span>
      </h2>

      <div class="account-info">
        <div class="info-grid">
          <div class="info-item">
            <h4>Nombre Completo</h4>
            <p id="info-nombre">Juan Delgado</p>
          </div>
          <div class="info-item">
            <h4>Correo Electrónico</h4>
            <p id="info-email">juan.delgado@email.com</p>
          </div>
          <div class="info-item">
            <h4>Teléfono</h4>
            <p id="info-telefono">+1 (555) 123-4567</p>
          </div>
          <div class="info-item">
            <h4>Dirección</h4>
            <p id="info-direccion">Calle Principal 123, Ciudad</p>
          </div>
          <div class="info-item">
            <h4>Nivel de Membresía</h4>
            <p id="info-nivel">Oro</p>
          </div>
          <div class="info-item">
            <h4>Fecha de Registro</h4>
            <p id="info-fecha-registro">15/03/2023</p>
          </div>
        </div>

        <a href="#" class="edit-btn">Editar Información</a>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://xaeybhscsxpvtnqzpgwj.supabase.co'; // <- Cambiá esto
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhZXliaHNjc3hwdnRucXpwZ3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjQ0NzYsImV4cCI6MjA2OTUwMDQ3Nn0.o470dGkIyNKNP552A6DUB3pkJI3Lty9AZOdCmo3MQvU'; // <- Cambiá esto
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Copiar código referido
    document.querySelector('.copy-btn').addEventListener('click', function () {
      const referralCode = document.getElementById('referral-code').textContent;
      navigator.clipboard.writeText(referralCode);

      const originalText = this.textContent;
      this.textContent = '¡Copiado!';
      this.style.backgroundColor = '#28a745';

      setTimeout(() => {
        this.textContent = originalText;
        this.style.backgroundColor = '#ffd700';
      }, 2000);
    });

    // Cambio de menú activo
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach((item) => {
      item.addEventListener('click', function () {
        menuItems.forEach((i) => i.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Función para cargar datos del usuario y mostrarlos
    async function cargarDatosUsuario() {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user) {
        // No hay usuario logueado, redirigir a login
        window.location.href = '/login.html'; // Cambiá a la ruta real de tu login
        return;
      }

      // Consultar tabla perfiles (profiles)
      const { data: perfil, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

      if (error) {
        console.error('Error al obtener perfil:', error.message);
        return;
      }

      // Actualizar DOM con datos reales
      const avatar = document.getElementById('user-avatar');
      const welcomeName = document.getElementById('welcome-name');
      const welcomeLevel = document.getElementById('welcome-level');
      const referralCode = document.getElementById('referral-code');

      const infoNombre = document.getElementById('info-nombre');
      const infoEmail = document.getElementById('info-email');
      const infoTelefono = document.getElementById('info-telefono');
      const infoDireccion = document.getElementById('info-direccion');
      const infoNivel = document.getElementById('info-nivel');
      const infoFechaRegistro = document.getElementById('info-fecha-registro');

      // Mostrar iniciales en avatar (ejemplo: Juan Delgado -> JD)
      const initials = perfil.full_name
        ? perfil.full_name
            .split(' ')
            .map((n) => n[0])
            .join('')
            .toUpperCase()
        : 'U';

      avatar.textContent = initials;

      // Actualizar textos
      welcomeName.textContent = `Bienvenido, ${perfil.full_name || 'Usuario'}`;
      welcomeLevel.textContent = `Nivel ${perfil.level || '-'} | Miembro desde: ${
        perfil.created_at
          ? new Date(perfil.created_at).toLocaleDateString('es-AR')
          : '-'
      }`;
      referralCode.textContent = perfil.referral_code || 'SIN CÓDIGO';

      infoNombre.textContent = perfil.full_name || '-';
      infoEmail.textContent = user.email || '-';
      infoTelefono.textContent = perfil.phone || '-';
      infoDireccion.textContent = perfil.address || '-';
      infoNivel.textContent = perfil.level || '-';
      infoFechaRegistro.textContent = perfil.created_at
        ? new Date(perfil.created_at).toLocaleDateString('es-AR')
        : '-';
    }

    cargarDatosUsuario();

    // Logout (cerrar sesión)
    document.getElementById('logout-button').addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) {
        alert('Error al cerrar sesión: ' + error.message);
      } else {
        window.location.href = '/login.html'; // Cambiá a la ruta real de login
      }
    });
  </script>
</body>
</html>
