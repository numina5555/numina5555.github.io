<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>NUMINA | Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
    :root {
      --primary: #ffd700;
      --primary-dark: #e6c200;
      --dark: #111;
      --dark-light: #1a1a1a;
      --dark-lighter: #222;
      --text: #fff;
      --text-light: #ccc;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .dashboard-header {
      background: linear-gradient(to right, var(--dark), var(--dark-lighter));
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 215, 0, 0.1);
    }

    .logo {
      color: var(--primary);
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      cursor: pointer;
    }

    .dashboard-container {
      display: flex;
      flex: 1;
    }

    .sidebar {
      width: 250px;
      background-color: var(--dark-light);
      padding: 1.5rem 0;
      border-right: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sidebar-menu {
      list-style: none;
    }

    .menu-item {
      padding: 0.8rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    .menu-item:hover, .menu-item.active {
      background-color: rgba(255, 215, 0, 0.1);
      border-left: 3px solid var(--primary);
      color: var(--primary);
    }

    .menu-item i {
      width: 20px;
      text-align: center;
    }

    .main-content {
      flex: 1;
      padding: 2rem;
      background-color: var(--dark);
    }

    .welcome-banner {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
      border: 1px solid rgba(255, 215, 0, 0.1);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .welcome-text h2 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .welcome-text p {
      color: var(--text-light);
    }

    .referral-code {
      background-color: var(--dark-light);
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .referral-code span {
      font-weight: 600;
      letter-spacing: 1px;
    }

    .copy-btn {
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .copy-btn:hover {
      background-color: var(--primary-dark);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background-color: var(--dark-light);
      border-radius: 10px;
      padding: 1.5rem;
      border-left: 4px solid var(--primary);
    }

    .stat-card h3 {
      color: var(--text-light);
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-card .value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .stat-card .change {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .change.positive {
      color: var(--success);
    }

    .change.negative {
      color: var(--danger);
    }

    .section-title {
      color: var(--primary);
      margin: 2rem 0 1rem;
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .table-container {
      background-color: var(--dark-light);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem;
      text-align: left;
    }

    th {
      background-color: var(--dark-lighter);
      color: var(--primary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-light);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .status {
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status.active {
      background-color: rgba(40, 167, 69, 0.2);
      color: var(--success);
    }

    .status.pending {
      background-color: rgba(255, 193, 7, 0.2);
      color: var(--warning);
    }

    .status.completed {
      background-color: rgba(13, 110, 253, 0.2);
      color: #0d6efd;
    }

    .action-btn {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 0.3rem 0.8rem;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover {
      background-color: var(--primary);
      color: var(--dark);
    }

    .account-info {
      background-color: var(--dark-light);
      border-radius: 10px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .info-item h4 {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .info-item p {
      font-weight: 600;
    }

    .edit-btn {
      display: inline-block;
      margin-top: 1.5rem;
      background-color: var(--primary);
      color: var(--dark);
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
    }

    .edit-btn:hover {
      background-color: var(--primary-dark);
    }

    .error-banner {
      background: rgba(220, 53, 69, 0.2);
      padding: 1rem;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
      border: 1px solid var(--danger);
    }

    .error-banner i {
      color: var(--danger);
    }

    .error-banner button {
      margin-left: auto;
      background: var(--dark);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    @media (max-width: 992px) {
      .sidebar {
        width: 70px;
      }

      .menu-item span {
        display: none;
      }

      .menu-item {
        justify-content: center;
      }

      .welcome-banner {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        padding: 0;
      }

      .sidebar-menu {
        display: flex;
        overflow-x: auto;
      }

      .menu-item {
        padding: 1rem;
        min-width: 70px;
      }
    }

    /* added: ensure section-content hidden by default */
    .section-content { display: none; }

    /* ===== Estilos de Configuración (no afectan al dashboard) ===== */
    .settings-card { background-color: var(--dark-light); border: 1px solid rgba(255,255,255,.05); border-radius:10px; padding:1.5rem; margin-bottom:1.5rem; }
    .settings-card h3 { color: var(--primary); margin-bottom:.8rem; font-size:1.05rem; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:1rem; }
    .form-row { display:flex; flex-direction:column; gap:.4rem; }
    .form-row label { color:var(--text-light); font-size:.9rem; }
    .form-row input, .form-row select { background:var(--dark); border:1px solid var(--dark-lighter); border-radius:8px; padding:.7rem .8rem; color:var(--text); outline:none; }
    .form-actions { display:flex; gap:.6rem; justify-content:flex-end; margin-top:1rem; }
    .btn { background:var(--primary); color:var(--dark); border:none; padding:.6rem 1rem; border-radius:8px; font-weight:600; cursor:pointer; }
    .btn:hover { background:var(--primary-dark); }
    .helper { color:var(--text-light); font-size:.85rem; margin-top:.4rem; }
  </style>
<style>
  /* === Productos (scoped) === */
  .section-title { color: var(--primary, #ffd700); margin: 0 0 1rem; font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: .8rem; }
  .products-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.2rem; }
  @media (max-width: 1200px) { .products-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 900px)  { .products-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 560px)  { .products-grid { grid-template-columns: 1fr; } }
  .product-card { background: var(--dark-light, #1a1a1a); border: 1px solid rgba(255,255,255,.05); border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
  .product-card:hover { transform: translateY(-2px); border-color: rgba(255,215,0,.25); box-shadow: 0 8px 24px rgba(0,0,0,.35); }
  .product-media { background: var(--dark-lighter, #222); aspect-ratio: 16/10; }
  .product-media img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .product-body { padding: 1rem; display: flex; flex-direction: column; gap: .6rem; }
  .product-title { font-size: 1rem; font-weight: 700; color: var(--text, #fff); }
  .product-desc  { font-size: .9rem; color: var(--text-light, #ccc); }
  .price { color: var(--primary, #ffd700); font-weight: 700; font-size: 1.1rem; }
  .btn { background: transparent; color: var(--primary, #ffd700); border: 1px solid var(--primary, #ffd700); padding: .55rem .9rem; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background .2s ease, color .2s ease; }
  .btn:hover { background: var(--primary, #ffd700); color: var(--dark, #111); }
  .btn-primary { background: var(--primary, #ffd700); color: var(--dark, #111); }
  .btn-primary:hover { filter: brightness(0.95); }

</style>

<style>
  /* === NUMINA Productos override: fixed 2x2 centered grid === */
  #section-productos .products-wrap { max-width: 1100px; margin: 0 auto; padding: 0 1rem; }
  #section-productos .products-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    justify-items: center;
  }
  @media (max-width: 900px) { 
    #section-productos .products-grid { grid-template-columns: 1fr; }
  }
  #section-productos .product-card { width: 100%; max-width: 500px; border-radius: 16px; }
  #section-productos .section-title { justify-content: center; }
  #section-productos .product-media { aspect-ratio: 16/9; display:block; }
</style>


<style>
/* ---- Align Productos section flush to the right of the sidebar ---- */
#section-productos { 
  margin-left: var(--sidebar-w, 240px);
  width: calc(100% - var(--sidebar-w, 240px));
}
#section-productos .products-wrap { 
  max-width: none; 
  margin: 0; 
  padding: 0 24px 24px; 
}
#section-productos .section-title { justify-content: flex-start; padding-left: 4px; }
</style>

</head>
<body>
<header class="dashboard-header"><div style="flex-grow:1; text-align:center;"><div class="logo">NUMINA</div></div><div class="user-menu">
<div class="user-avatar" id="user-avatar">US</div>
</div>
</header>
<div class="dashboard-container">
<nav class="sidebar">
<ul class="sidebar-menu">
<li class="menu-item active" data-target="dashboard">
<i class="fas fa-home"></i>
<span>Dashboard</span>
</li>
<li class="menu-item" data-target="compras">
<i class="fas fa-shopping-bag"></i>
<span>Mis Compras</span>
</li>
<li class="menu-item" data-target="sorteos">
<i class="fas fa-ticket-alt"></i>
<span>Sorteos</span>
</li>
<li class="menu-item" data-target="referidos">
<i class="fas fa-users"></i>
<span>Referidos</span>
</li>
<li class="menu-item" data-target="productos">
<i class="fas fa-box"></i>
<span>Productos</span>
</li>
<li class="menu-item" data-target="configuracion">
<i class="fas fa-cog"></i>
<span>Configuración</span>
</li>
<li class="menu-item" data-target="logout" id="logout-btn">
<i class="fas fa-sign-out-alt"></i>
<span>Cerrar Sesión</span>
</li>
</ul>
</nav>
<main class="main-content"><div id="main-dashboard">
<section class="welcome-banner" id="welcome-banner">
<div class="welcome-text">
<h2 id="welcome-title">Cargando datos...</h2>
<p id="welcome-subtitle" style="display: none;">Por favor espera</p>
</div>
<div class="referral-code">
<i class="fas fa-user-plus"></i>
<span id="referral-code">---</span>
<button class="copy-btn" id="copy-btn">Copiar</button>
</div>
</section>
<div class="stats-grid">
<div class="stat-card">
<h3>Saldo Disponible</h3>
<div class="value" id="balance-value">$---</div>
<div class="change positive">
<i class="fas fa-arrow-up"></i>
<span>Cargando...</span>
</div>
</div>
<div class="stat-card">
<h3>Compras Activas</h3>
<div class="value" id="purchases-value">--</div>
<div class="change positive">
<i class="fas fa-arrow-up"></i>
<span>Cargando...</span>
</div>
</div>
<div class="stat-card">
<h3>Referidos</h3>
<div class="value" id="referrals-value">--</div>
<div class="change positive">
<i class="fas fa-arrow-up"></i>
<span>Cargando...</span>
</div>
</div>
<div class="stat-card">
<h3>Tickets de Sorteo</h3>
<div class="value" id="tickets-value">--</div>
<div class="change negative">
<i class="fas fa-arrow-down"></i>
<span>Cargando...</span>
</div>
</div>
</div>
<h2 class="section-title">
<i class="fas fa-shopping-bag"></i>
<span>Compras Activas</span>
</h2>
<div class="table-container">
<table id="purchases-table">
<thead>
<tr>
<th>Producto</th>
<th>Fecha</th>
<th>Valor</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="purchases-body">
<tr>
<td colspan="5" style="text-align: center;">Cargando compras...</td>
</tr>
</tbody>
</table>
</div>
<h2 class="section-title">
<i class="fas fa-users"></i>
<span>Historial de Referidos</span>
</h2>
<div class="table-container">
<table id="referrals-table">
<thead>
<tr>
<th>Referido</th>
<th>Fecha</th>
<th>Compras</th>
<th>Estado</th>
<th>Comisión</th>
</tr>
</thead>
<tbody id="referrals-body">
<tr>
<td colspan="5" style="text-align: center;">Cargando referidos...</td>
</tr>
</tbody>
</table>
</div>
<h2 class="section-title">
<i class="fas fa-user-circle"></i>
<span>Información de la Cuenta</span>
</h2>
<div class="account-info">
<div class="info-grid" id="account-info-grid">
<div class="info-item">
<h4>Nombre Completo</h4>
<p id="full-name">Cargando...</p>
</div>
<div class="info-item">
<h4>Correo Electrónico</h4>
<p id="user-email">Cargando...</p>
</div>
<div class="info-item">
<h4>Teléfono</h4>
<p id="user-phone">Cargando...</p>
</div>
<div class="info-item">
<h4>Dirección</h4>
<p id="user-address">Cargando...</p>
</div>
</div>
<a class="edit-btn" href="#" id="edit-btn">Editar Información</a>
</div>
</div>

<!-- Configuración: MOVIDA FUERA DE #main-dashboard -->
<section class="section-content" id="section-configuracion" style="display:none;">
  <h2 class="section-title"><i class="fas fa-cog"></i><span>Configuración de la Cuenta</span></h2>

  <div class="settings-card">
    <h3><i class="fas fa-id-card"></i> Datos Personales</h3>
    <form id="config-datos-form">
      <div class="form-grid">
      <!-- Nota: El campo de correo electrónico se eliminó de este formulario porque se gestiona únicamente desde el proveedor de autenticación (Supabase Auth). Si en el futuro se habilita su edición, puede reinsertarse un campo de solo lectura o un enlace a la sección correspondiente. Esta nota existe solo como documentación para el equipo y no se muestra al usuario. -->

        <div class="form-row"><label for="cfg-fullname">Nombre completo</label><input id="cfg-fullname" type="text" placeholder="Nombre y apellido"/></div>
        
        <div class="form-row"><label for="cfg-phone">Teléfono</label><input id="cfg-phone" type="tel" placeholder="+54 11 1234 5678"/></div>
        <div class="form-row"><label for="cfg-address">Dirección</label><input id="cfg-address" type="text" placeholder="Calle, número, ciudad"/></div>
      </div>
      <div class="form-actions"><button class="btn" type="submit">Guardar cambios</button></div>
    </form>
  </div>

  <div class="settings-card">
    <h3><i class="fas fa-shield-alt"></i> Seguridad</h3>
    <form id="config-pass-form">
      <div class="form-grid">
        <div class="form-row"><label for="cfg-pass1">Nueva contraseña</label><input id="cfg-pass1" type="password" placeholder="********"/></div>
        <div class="form-row"><label for="cfg-pass2">Repetir contraseña</label><input id="cfg-pass2" type="password" placeholder="********"/></div>
      </div>
      <div class="form-actions"><button class="btn" type="submit">Actualizar contraseña</button></div>
    </form>
  </div>

  </section>

<section class="section-content" id="section-compras" style="display:none;">
  <h2 class="section-title">
    <i class="fas fa-shopping-bag"></i>
    <span>Mis Compras</span>
  </h2>
  <div class="table-container">
    <table id="miscompras-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Fecha</th>
          <th>Valor</th>
          <th>Estado</th>
          <th>Reclamo</th>
        </tr>
      </thead>
      <tbody id="miscompras-body">
        <tr>
          <td colspan="5" style="text-align: center;">Cargando compras...</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
</main></div>

</div>
<script src="https://unpkg.com/@supabase/supabase-js@2.39.0"></script>
<script>
// Memoized Supabase client: re-use the same instance so session persists between sections
(function(){
  const URL = 'https://xaeybhscsxpvtnqzpgwj.supabase.co';
  const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhZXliaHNjc3hwdnRucXpwZ3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjQ0NzYsImV4cCI6MjA2OTUwMDQ3Nn0.o470dGkIyNKNP552A6DUB3pkJI3Lty9AZOdCmo3MQvU';
  let _client = window.__supabaseClient || null;
  window.getSupabase = function(){
    if (_client) { 
      window.__supabaseClient = _client; 
      return _client; 
    }
    // IMPORTANT: do NOT replace the next line; it must call window.supabase.createClient
    _client = window.supabase.createClient(URL, KEY, { 
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: localStorage }
    });
    window.__supabaseClient = _client; return _client;
  };
})();
</script>

<script>
  // 1. VERIFICACIÓN DE CARGA DE SUPABASE
  function checkSupabaseLoaded() {
    return new Promise((resolve) => {
      const check = () => {
        if (window.supabase) {
          resolve();
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }

  // 2. INICIALIZACIÓN PRINCIPAL
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Espera a que Supabase esté disponible
      await checkSupabaseLoaded();

      // Conexión a Supabase (TUS CREDENCIALES ORIGINALES)
      const supabase = getSupabase();

      // ► [TODO EL RESTO DE TU CÓDIGO ORIGINAL SE MANTIENE IGUAL]
      // Desde la verificación de sesión hasta los event listeners
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      if (authError || !user) {
        window.location.href = '/login.html';
        return;
      }

      const { data: userData, error: userError } = await supabase
        .from('users')
        .select('*, purchases(*), referrals(*)')
        .eq('id', user.id)
        .maybeSingle();

      if (userError) throw userError;

      // Actualizar UI (tu función original)
      document.getElementById('user-avatar').textContent = 
        userData.full_name?.charAt(0).toUpperCase() || 'U';
      document.getElementById('welcome-title').textContent = 
        `Bienvenido, ${userData.full_name || userData.email}`;
      document.getElementById('referral-code').textContent = 
        userData.referral_code || '---';
      document.getElementById('balance-value').textContent = `$${userData.balance?.toFixed(2) || '0.00'}`;
      document.getElementById('purchases-value').textContent = userData.active_purchases || '0';
      document.getElementById('referrals-value').textContent = userData.referrals_count || '0';
      document.getElementById('tickets-value').textContent = userData.tickets_count || '0';
      document.getElementById('full-name').textContent = userData.full_name || 'No definido';
      document.getElementById('user-email').textContent = userData.email || 'No definido';
      document.getElementById('user-phone').textContent = userData.phone || 'No definido';
      document.getElementById('user-address').textContent = userData.address || 'No definido';

      // Compras
      const purchasesBody = document.getElementById('purchases-body');
      purchasesBody.innerHTML = userData.purchases?.length > 0 
        ? userData.purchases.map(p => `
            <tr>
              <td>${p.product_name}</td>
              <td>${new Date(p.created_at).toLocaleDateString()}</td>
              <td>$${(p.value ?? 0).toFixed(2)}</td>
              <td><span class="status ${p.status}">${p.status}</span></td>
              <td><button class="action-btn">Detalles</button></td>
            </tr>
          `).join('')
        : '<tr><td colspan="5" style="text-align: center;">No hay compras</td></tr>';

      // Referidos
      const referralsBody = document.getElementById('referrals-body');
      referralsBody.innerHTML = userData.referrals?.length > 0
        ? userData.referrals.map(r => `
            <tr>
              <td>${r.referred_email}</td>
              <td>${new Date(r.created_at).toLocaleDateString()}</td>
              <td>${r.purchases_count || '0'}</td>
              <td><span class="status ${r.is_active ? 'active' : 'inactive'}">${r.is_active ? 'Activo' : 'Inactivo'}</span></td>
              <td>$${(r.commission ?? 0).toFixed(2)}</td>
            </tr>
          `).join('')
        : '<tr><td colspan="5" style="text-align: center;">No hay referidos</td></tr>';

      // --- NUEVO: Prefill y handlers de Configuración ---
      try { prefillConfigForms(userData); } catch(e) {}
      try { attachConfigHandlers(supabase); } catch(e) {}
      // ---------------------------------------------------

    } catch (error) {
      console.error('Error:', error);
      const banner = document.getElementById('welcome-banner');
      if (banner) {
        banner.innerHTML = `
          <div class="error-banner">
            <i class="fas fa-exclamation-circle"></i>
            <span>Error al conectar con el servidor. Recarga la página.</span>
            <button onclick="window.location.reload()">Reintentar</button>
          </div>
        `;
      }
    }
  });

  // Event listeners (originales)
  document.getElementById('copy-btn')?.addEventListener('click', function() {
    const code = document.getElementById('referral-code').textContent;
    navigator.clipboard.writeText(code);
    this.textContent = '¡Copiado!';
    setTimeout(() => this.textContent = 'Copiar', 2000);
  });

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    const supabase = getSupabase();
    await getSupabase().auth.signOut();
    window.location.href = '/login.html';
  });
</script>
<script>
// NUEVOS helpers para Configuración (no afectan otras vistas)
function prefillConfigForms(userData){
  const d = userData || {};
  const $ = (id)=>document.getElementById(id);
  if ($('cfg-fullname')) $('cfg-fullname').value = d.full_name || '';if ($('cfg-phone'))    $('cfg-phone').value    = d.phone || '';
  if ($('cfg-address'))  $('cfg-address').value  = d.address || '';
  if ($('cfg-lang'))     $('cfg-lang').value     = d.language || 'es';
}

function attachConfigHandlers(supabase){
  const datos = document.getElementById('config-datos-form');
  if (datos) datos.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const updates = {
      full_name: (document.getElementById('cfg-fullname').value||'').trim() || null,
      phone:     (document.getElementById('cfg-phone').value||'').trim() || null,
      address:   (document.getElementById('cfg-address').value||'').trim() || null,
    };
    // remove undefined keys and keep only provided values (avoid empty update bodies)
    Object.keys(updates).forEach(k => { if (updates[k] === undefined) delete updates[k]; });
    if (Object.values(updates).every(v => v === null)) { alert('No hay cambios para guardar'); return; }
    const { data: { user } } = await supabase.auth.getUser();
    const { data, error } = await supabase
      .from('users')
      .update(updates)
      .eq('id', user.id)
      .select('full_name,phone,address')
      .single();
    if (error) return alert('No se pudieron guardar los cambios');
    alert('Cambios guardados');
    const res = data || updates;
    // Refrescar en dashboard inmediatamente
    (function(){var el=document.getElementById('full-name'); if(el) el.textContent = (res.full_name ?? updates.full_name) || 'No definido';})();
    (function(){var el=document.getElementById('user-phone'); if(el) el.textContent = (res.phone ?? updates.phone) || 'No definido';})();
    (function(){var el=document.getElementById('user-address'); if(el) el.textContent = (res.address ?? updates.address) || 'No definido';})();
    // Y forzar re-fetch al volver al Dashboard por si hay cálculos derivados
    if (typeof cargarDashboard === 'function') { try { await cargarDashboard(); } catch(_){} }
  });

  const pass = document.getElementById('config-pass-form');
  if (pass) pass.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const p1 = document.getElementById('cfg-pass1').value;
    const p2 = document.getElementById('cfg-pass2').value;
    if (!p1 || p1.length<6) return alert('La contraseña debe tener al menos 6 caracteres');
    if (p1 !== p2) return alert('Las contraseñas no coinciden');
    const { error } = await supabase.auth.updateUser({ password:p1 });
    if (error) return alert('No se pudo actualizar la contraseña');
    alert('Contraseña actualizada');
    pass.reset();
  });

  /* Preferencias de idioma deshabilitadas */
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const hideIfReady = (id, expected) => {
    const el = document.getElementById(id);
    if (el && !el.textContent.includes('Cargando')) {
      const change = el.parentElement.querySelector('.change');
      if (change) change.style.display = 'none';
    }
  };

  hideIfReady('balance-value');
  hideIfReady('purchases-value');
  hideIfReady('referrals-value');
  hideIfReady('tickets-value');
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const copyBtn = document.getElementById("copy-btn");
  const referralCode = document.getElementById("referral-code");

  if (copyBtn && referralCode) {
    copyBtn.addEventListener("click", async () => {
      const code = referralCode.textContent;

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(code);
        } else {
          const textarea = document.createElement("textarea");
          textarea.value = code;
          textarea.style.position = "fixed";
          textarea.style.opacity = 0;
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
        }

        copyBtn.textContent = "¡Copiado!";
        setTimeout(() => copyBtn.textContent = "Copiar", 2000);
      } catch (err) {
        alert("No se pudo copiar el código. Intenta manualmente.");
        console.error("Error al copiar:", err);
      }
    });
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuItems = document.querySelectorAll('.menu-item[data-target]');
  const sections = document.querySelectorAll('.section-content');

  menuItems.forEach(item => {
    item.addEventListener('click', () => {
      const target = item.getAttribute('data-target');
      sections.forEach(section => {
        section.style.display = section.id === 'section-' + target ? 'block' : 'none';
      });
      menuItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
    });
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuItems = document.querySelectorAll(".menu-item[data-target]");
  const sections = document.querySelectorAll(".section-content");

  menuItems.forEach(item => {
    item.addEventListener("click", () => {
      const target = item.getAttribute("data-target");
      sections.forEach(section => {
        section.style.display = section.id === 'section-' + target ? 'block' : 'none';
      });
      menuItems.forEach(i => i.classList.remove("active"));
      item.classList.add("active");
    });
  });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuItems = document.querySelectorAll(".menu-item[data-target]");
  const mainDashboard = document.getElementById("main-dashboard");

  async function cargarDashboard() {
    console.log("[cargarDashboard] Ejecutando");

    document.getElementById('welcome-title').textContent = 'Cargando datos...';
    document.getElementById('referral-code').textContent = '---';
    document.getElementById('balance-value').textContent = '$---';
    document.getElementById('purchases-value').textContent = '--';
    document.getElementById('referrals-value').textContent = '--';
    document.getElementById('tickets-value').textContent = '--';
    document.getElementById('full-name').textContent = 'Cargando...';
    document.getElementById('user-email').textContent = 'Cargando...';
    document.getElementById('user-phone').textContent = 'Cargando...';
    document.getElementById('user-address').textContent = 'Cargando...';
    document.getElementById('purchases-body').innerHTML = '<tr><td colspan="5" style="text-align: center;">Cargando compras...</td></tr>';
    document.getElementById('referrals-body').innerHTML = '<tr><td colspan="5" style="text-align: center;">Cargando referidos...</td></tr>';

    const supabase = getSupabase();

    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) return;

    const { data: userData } = await supabase
      .from('users')
      .select('*, purchases(*), referrals(*)')
      .eq('id', user.id)
      .maybeSingle();

    if (!userData) return;

    document.getElementById('user-avatar').textContent = userData.full_name?.charAt(0).toUpperCase() || 'U';
    document.getElementById('welcome-title').textContent = 'Bienvenido, ' + (userData.full_name || userData.email);
    document.getElementById('referral-code').textContent = userData.referral_code || '---';
    document.getElementById('balance-value').textContent = '$' + (userData.balance?.toFixed(2) || '0.00');
    document.getElementById('purchases-value').textContent = userData.active_purchases || '0';
    document.getElementById('referrals-value').textContent = userData.referrals_count || '0';
    document.getElementById('tickets-value').textContent = userData.tickets_count || '0';
    document.getElementById('full-name').textContent = userData.full_name || 'No definido';
    document.getElementById('user-email').textContent = userData.email || 'No definido';
    document.getElementById('user-phone').textContent = userData.phone || 'No definido';
    document.getElementById('user-address').textContent = userData.address || 'No definido';

    const purchasesBody = document.getElementById('purchases-body');
    if (userData.purchases?.length > 0) {
      purchasesBody.innerHTML = '';
      userData.purchases.forEach(p => {
        const row = '<tr>' +
          '<td>' + p.product_name + '</td>' +
          '<td>' + new Date(p.created_at).toLocaleDateString() + '</td>' +
          '<td>$' + (p.value?.toFixed(2) || '0.00') + '</td>' +
          '<td><span class="status ' + p.status + '">' + p.status + '</span></td>' +
          '<td><button class="action-btn">Detalles</button></td>' +
          '</tr>';
        purchasesBody.innerHTML += row;
      });
    } else {
      purchasesBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay compras</td></tr>';
    }

    const referralsBody = document.getElementById('referrals-body');
    if (userData.referrals?.length > 0) {
      referralsBody.innerHTML = '';
      userData.referrals.forEach(r => {
        const row = '<tr>' +
          '<td>' + r.referred_email + '</td>' +
          '<td>' + new Date(r.created_at).toLocaleDateString() + '</td>' +
          '<td>' + (r.purchases_count || '0') + '</td>' +
          '<td><span class="status ' + (r.is_active ? 'active' : 'inactive') + '">' +
          (r.is_active ? 'Activo' : 'Inactivo') + '</span></td>' +
          '<td>$' + (r.commission?.toFixed(2) || '0.00') + '</td>' +
          '</tr>';
        referralsBody.innerHTML += row;
      });
    } else {
      referralsBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay referidos</td></tr>';
    }
  }

  menuItems.forEach(item => {
    item.addEventListener("click", () => {
      const target = item.getAttribute("data-target");
      menuItems.forEach(i => i.classList.remove("active"));
      item.classList.add("active");

      if (target === "dashboard") {
        mainDashboard.style.display = "block";
        cargarDashboard();
      } else if (target !== "logout") {
        mainDashboard.style.display = "none";
      }
    });
  });

  mainDashboard.style.display = "block";
  cargarDashboard();
});
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuCompras = document.querySelector('.menu-item[data-target="compras"]');
  const sectionCompras = document.getElementById("section-compras");
  const mainDashboard = document.getElementById("main-dashboard");
  const sectionConfig = document.getElementById('section-configuracion');
  const menuConfig = document.querySelector('.menu-item[data-target="configuracion"]');

  // Mis Compras
  if (menuCompras) {
    menuCompras.addEventListener("click", async () => {
      if (mainDashboard) mainDashboard.style.display = "none";
      if (sectionCompras) sectionCompras.style.display = "block";
      // Traer compras recientes del usuario desde Supabase
      try {
        const supabase = getSupabase();
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
          window.location.href = '/login.html';
          return;
        }
        // Traer solo las 7 compras más recientes del usuario
        const { data: purchases, error: purchaseError } = await supabase
          .from('purchases')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(7);

        const tbody = document.getElementById('miscompras-body');
        if (purchaseError || !purchases) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay compras</td></tr>';
          return;
        }
        if (purchases.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay compras</td></tr>';
          return;
        }
        tbody.innerHTML = purchases.map(p => `
          <tr>
            <td>${p.product_name}</td>
            <td>${new Date(p.created_at).toLocaleDateString()}</td>
            <td>$${(p.value ?? 0).toFixed(2)}</td>
            <td><span class="status ${p.status}">${p.status}</span></td>
            <td><button class="action-btn" disabled>Hacer reclamo</button></td>
          </tr>
        `).join('');
      } catch (e) {
        const tbody = document.getElementById('miscompras-body');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error cargando compras</td></tr>';
      }
    });
  }

  // Configuración
  if (menuConfig) {
    menuConfig.addEventListener("click", () => {
      if (mainDashboard) mainDashboard.style.display = "none";
      if (sectionCompras) sectionCompras.style.display = "none";
      if (sectionConfig) sectionConfig.style.display = "block";
      try { prefillConfigForms(window._userData || {}); } catch(e) {}
    });
  }
});
</script>



<!-- Sección Productos (NUMINA) — 2x2 fixed layout -->
<section class="section-content" id="section-productos" style="display:none;">
  <div class="products-wrap">
    <h2 class="section-title"><i class="fas fa-box"></i><span>Productos</span></h2>
    <section class="products-grid">
      <!-- Oro -->
      <article class="product-card">
        <figure class="product-media">
          <svg viewBox="0 0 640 360" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Lingote de Oro">
            <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0%" stop-color="#4b4300"/><stop offset="100%" stop-color="#8a7a00"/></linearGradient></defs>
            <rect width="640" height="360" fill="url(#g1)"/><text x="50%" y="52%" text-anchor="middle" fill="#fff" font-family="Montserrat, sans-serif" font-weight="700" font-size="36">Lingote de Oro</text>
          </svg>
        </figure>
        <div class="product-body">
          <h3 class="product-title">Lingote 100g Oro Fino</h3>
          <p class="product-desc">Oro 999.9 certificado. Ideal para inversión y resguardo de valor.</p>
          <span class="price">US$ 13,500</span>
          <button class="btn btn-primary" data-action="more" data-sku="GOLD-100G">Más información</button>
        </div>
      </article>
      <!-- Platino -->
      <article class="product-card">
        <figure class="product-media">
          <svg viewBox="0 0 640 360" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Lingote de Platino">
            <defs><linearGradient id="g2" x1="0" x2="1"><stop offset="0%" stop-color="#2e3136"/><stop offset="100%" stop-color="#6a6f78"/></linearGradient></defs>
            <rect width="640" height="360" fill="url(#g2)"/><text x="50%" y="52%" text-anchor="middle" fill="#fff" font-family="Montserrat, sans-serif" font-weight="700" font-size="36">Lingote de Platino</text>
          </svg>
        </figure>
        <div class="product-body">
          <h3 class="product-title">Lingote 100g Platino Fino</h3>
          <p class="product-desc">Platino 999.5 certificado. Inversión de alto valor y rareza.</p>
          <span class="price">US$ 6,500</span>
          <button class="btn btn-primary" data-action="more" data-sku="PLAT-100G">Más información</button>
        </div>
      </article>
      <!-- Rolex -->
      <article class="product-card">
        <figure class="product-media">
          <svg viewBox="0 0 640 360" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Rolex 126610L">
            <defs><linearGradient id="g3" x1="0" x2="1"><stop offset="0%" stop-color="#0d1f14"/><stop offset="100%" stop-color="#1d6c3a"/></linearGradient></defs>
            <rect width="640" height="360" fill="url(#g3)"/><text x="50%" y="52%" text-anchor="middle" fill="#fff" font-family="Montserrat, sans-serif" font-weight="700" font-size="34">Rolex 126610L</text>
          </svg>
        </figure>
        <div class="product-body">
          <h3 class="product-title">Rolex Starbucks Ref. 126610L</h3>
          <p class="product-desc">Submariner Date con bisel verde y caja Oystersteel. Automático.</p>
          <span class="price">US$ 19,600</span>
          <button class="btn btn-primary" data-action="more" data-sku="ROLEX-126610L">Más información</button>
        </div>
      </article>
      <!-- Pulsera -->
      <article class="product-card">
        <figure class="product-media">
          <svg viewBox="0 0 640 360" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Pulsera Numina">
            <defs><linearGradient id="g4" x1="0" x2="1"><stop offset="0%" stop-color="#2a0d2d"/><stop offset="100%" stop-color="#6f1d75"/></linearGradient></defs>
            <rect width="640" height="360" fill="url(#g4)"/><text x="50%" y="52%" text-anchor="middle" fill="#fff" font-family="Montserrat, sans-serif" font-weight="700" font-size="34">Pulsera Numina</text>
          </svg>
        </figure>
        <div class="product-body">
          <h3 class="product-title">Pulsera Numina</h3>
          <p class="product-desc">Diseño exclusivo con materiales de alta calidad. Edición limitada.</p>
          <span class="price">US$ 35</span>
          <button class="btn btn-primary" data-action="more" data-sku="NUMINA-BRACELET">Más información</button>
        </div>
      </article>
    </section>
  </div>
</section>



<script>
// ---- NUMINA: navegación para sección Productos ----
(function(){
  // Helper: show one section and hide others
  function showSection(id){
    var all = document.querySelectorAll('.section-content');
    if (all && all.length){
      all.forEach(function(sec){ sec.style.display = 'none'; });
    }
    var el = document.getElementById(id);
    if (el) el.style.display = 'block';
  }

  // If there's already a global router, we only add a hook for 'productos'
  var btn = document.querySelector('[data-section="productos"], [data-target="productos"], a[href="#productos"]');
  if (btn){
    btn.addEventListener('click', function(e){
      e.preventDefault && e.preventDefault();
      showSection('section-productos');
      // optional: update active state on sidebar
      try {
        document.querySelectorAll('[data-section]').forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
      } catch(err){}
    });
  }

  // Optional demo: wire product buttons
  document.addEventListener('click', function(e){
    var b = e.target.closest('button[data-action="more"]');
    if (!b) return;
    var sku = b.getAttribute('data-sku') || '---';
    alert('Detalles del producto: ' + sku);
  });
})();
</script>


<script>
(function(){
  function setSidebarWidthVar(){
    var sb = document.querySelector('.sidebar, .side-bar, nav.sidebar, aside.sidebar');
    var w = sb ? sb.offsetWidth : 0;
    document.documentElement.style.setProperty('--sidebar-w', (w || 240) + 'px');
  }
  setSidebarWidthVar();
  window.addEventListener('resize', setSidebarWidthVar);
})();
</script>

</body></html>
