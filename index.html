<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NUMINA | Index</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0f1113;--panel:#16181c;--panel-2:#1d2025;--brand:#ffd700;--text:#fff;--muted:#a7aeb8}
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
         display:grid;place-items:center;background:var(--bg);color:var(--text)}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.08);
          border-radius:16px;padding:28px;box-shadow:0 20px 45px rgba(0,0,0,.45);width:min(520px,96%)}
    .brand{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#4b4300,#8a7a00);
          display:grid;place-items:center;font-weight:900;color:#111}
    h1{margin:0;font-size:1.9rem;letter-spacing:1.4px;color:var(--brand)}
    .muted{color:var(--muted);text-align:center;margin:4px 0 12px}
    .spinner{width:46px;height:46px;border-radius:50%;border:4px solid rgba(255,255,255,.12);
             border-top-color:var(--brand);margin:16px auto 6px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .btn{background:var(--brand);color:#111;border:0;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.outline{background:transparent;border:1px solid var(--brand);color:var(--brand)}
    small{display:block;color:var(--muted);text-align:center;margin-top:8px}
  </style>
</head>
<body>
  <div class="card" role="status" aria-live="polite">
    <div class="brand" aria-hidden="true">
      <div class="logo">N</div><h1>NUMINA</h1>
    </div>
    <div class="spinner" aria-hidden="true"></div>
    <p class="muted" id="msg">Verificando sesión segura…</p>
    <div class="actions">
      <button class="btn" id="goLogin" style="display:none">Ir al login</button>
      <button class="btn outline" id="goDash" style="display:none">Ir al dashboard</button>
    </div>
    <small id="hint"></small>
  </div>

  <script>
    // === CONFIG: rutas de producción ===
    // NOTA: usa rutas relativas (login.html / dashboard.html) para que funcione igual en / y en subcarpetas.
    const URL_LOGIN = "login.html";
    const URL_DASHBOARD = "dashboard.html";

    // === Supabase: mismos valores que tu login.html ===
    const SUPABASE_URL  = "https://xaeybhscsxpvtnqzpgwj.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhZXliaHNjc3hwdnRucXpwZ3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjQ0NzYsImV4cCI6MjA2OTUwMDQ3Nn0.o470dGkIyNKNP552A6DUB3pkJI3Lty9AZOdCmo3MQvU";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // === Helpers robustos ===
    const $ = (sel)=>document.querySelector(sel);
    const rawQuery = (location.search || "").replace(/^\?/, "");
    const rawHash  = (location.hash   || "").replace(/^#/, "");

    /**
     * Sanitiza un destino y lo resuelve a una ruta navegable SIN usar new URL(to, location.href),
     * que en algunos entornos puede lanzar "Invalid URL" si `to` es inválido.
     */
    function resolveTarget(to){
      if (typeof to !== 'string') throw new TypeError('Target must be a string');
      const t = to.trim();
      if (!t) throw new TypeError('Target is empty');
      // Si es URL absoluta (http/https o protocolo relativo //)
      if (/^(https?:)?\/\//i.test(t)) return t;
      // Si empieza con "/" => absoluto desde el host
      if (t.startsWith('/')) return location.origin + t;
      // Relativo al directorio actual
      const dir = location.pathname.endsWith('/')
        ? location.pathname
        : location.pathname.replace(/[^/]+$/, '');
      return dir + t;
    }

    /** Construye href final preservando ?query y #hash actuales, sin duplicarlos */
    function buildHref(baseHref){
      let href = baseHref;
      if (rawQuery) href += (href.includes('?') ? '&' : '?') + rawQuery;
      if (rawHash && !href.includes('#')) href += '#' + rawHash; // si ya tenia hash, lo respetamos
      return href;
    }

    function safeRedirect(to){
      try{
        const target = resolveTarget(to);
        const finalHref = buildHref(target);
        // Usamos location.assign en lugar de replace para permitir "volver" durante debug
        location.assign(finalHref);
      }catch(e){
        console.warn('Redirección segura falló, intento fallback:', e);
        try{
          // Fallback muy simple: si todo falla, navegar directo sin query/hash
          location.href = (typeof to === 'string' && to.trim()) ? to.trim() : URL_LOGIN;
        }catch(e2){
          console.error('No pude redirigir ni con fallback', e2);
          $('#hint').textContent = (e && e.message) || (e2 && e2.message) || '';
        }
      }
    }

    // Botones de fallback visibles si algo demora
    document.getElementById('goLogin').addEventListener('click', ()=> safeRedirect(URL_LOGIN));
    document.getElementById('goDash').addEventListener('click',  ()=> safeRedirect(URL_DASHBOARD));

    (async function main(){
      try{
        // ?logout borra la sesión y va a login
        const q = new URLSearchParams(location.search);
        if (q.has('logout')){
          try{ await supabaseClient.auth.signOut(); }catch(_){/* ignore */}
          return safeRedirect(URL_LOGIN);
        }

        // 1) Sesión actual
        const { data: sessData, error } = await supabaseClient.auth.getSession();
        if (error) throw error;

        if (sessData && sessData.session){
          $('#msg').textContent = 'Sesión encontrada. Entrando al dashboard…';
          return safeRedirect(URL_DASHBOARD);
        }

        // 2) Escuchamos eventos mientras mostramos opciones
        $('#msg').textContent = 'No hay sesión activa. Enviando al login…';
        $('#goLogin').style.display = 'inline-block';
        $('#goDash').style.display  = 'inline-block';

        const { data: sub } = supabaseClient.auth.onAuthStateChange((_event, session) => {
          if (session) safeRedirect(URL_DASHBOARD);
        });

        // Fallback corto por si el evento no llega
        setTimeout(()=> safeRedirect(URL_LOGIN), 1200);
      }catch(e){
        console.warn(e);
        $('#msg').textContent = 'No se pudo verificar la sesión. Te llevo al login…';
        $('#hint').textContent = e?.message || '';
        setTimeout(()=> safeRedirect(URL_LOGIN), 800);
      }
    })();

    // ==================
    // Auto-tests (debug)
    // ==================
    (function selfTests(){
      const group = 'NUMINA index self-tests';
      console.groupCollapsed(group);
      try{
        const samples = [
          'login.html',
          '/login.html',
          './login.html',
          'dashboard.html',
          'https://example.com/path',
        ];
        samples.forEach(s=>{
          try{ const r = resolveTarget(s); console.assert(typeof r === 'string' && r.length>0, 'resolveTarget ok for', s, '=>', r); }catch(e){ console.error('resolveTarget error', s, e); }
        });
        // Casos borde
        try{ let err=false; try{ resolveTarget(''); }catch(_){ err=true; } console.assert(err, 'resolveTarget vacio debe fallar'); }catch(_){ }
        try{ const h = buildHref('login.html'); console.assert(h.includes('login.html'), 'buildHref base'); }catch(_){ }
        // Preservación de query/hash
        const qh = buildHref('/login.html');
        console.assert(qh.startsWith('/login.html') || qh.includes('login.html'), 'buildHref mantiene base');
      }finally{
        console.groupEnd();
      }
    })();
  </script>
</body>
</html>
