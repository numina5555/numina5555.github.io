<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NUMINA | Acceso</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Supabase JS v2 (pinned) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.43.4"></script>
  <style>
    :root{
      --bg:#0f1113;--panel:#16181c;--panel-2:#1d2025;--text:#fff;--muted:#a7aeb8;--brand:#ffd700;--brand-2:#e6c200;--danger:#ff6b6b;--success:#44d07b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 20% -10%, #15181d 0%, transparent 60%),
                 radial-gradient(1200px 800px at 120% 110%, #15181d 0%, transparent 60%),
                 var(--bg);
      color:var(--text);
      display:flex;align-items:center;justify-content:center;padding:24px;
    }
    .wrap{width:min(420px, 100%)}
    .card{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px;
      box-shadow:0 20px 45px rgba(0,0,0,.45);
      display:grid;
      grid-template-rows:auto 1fr auto; /* header fijo, body scroll, footer fijo */
      max-height:min(760px, 92vh);
      width:100%;
    }
    .card-head{padding:24px 24px 12px 24px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg,var(--panel) 0%, rgba(22,24,28,.95) 100%); border-top-left-radius:16px; border-top-right-radius:16px;}
    .card-body{padding:16px 24px; overflow:auto;}
    .card .footer{padding:14px 18px; border-top:1px solid rgba(255,255,255,.06); border-bottom-left-radius:16px; border-bottom-right-radius:16px; text-align:center; color:var(--muted); font-size:.8rem;}
    .brand{display:flex;gap:10px;align-items:center;justify-content:center;margin:2px 0 12px}
    .brand .logo{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#4b4300,#8a7a00);display:grid;place-items:center;font-weight:900;color:#111}
    .brand h1{margin:0;font-size:1.9rem;letter-spacing:1.4px;color:var(--brand)}

    .tabs{display:flex;background:#11151a;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:4px;margin:0}
    .tab{flex:1;text-align:center;padding:10px 12px;border-radius:8px;font-weight:700;color:var(--muted);cursor:pointer;user-select:none}
    .tab.active{background:var(--panel);color:var(--text)}

    form{display:grid;gap:12px}
    label{font-size:.92rem;color:var(--muted)}
    .field{display:grid;gap:6px}
    .control{position:relative}
    input{
      width:100%;background:#0f1318;border:1px solid #232832;border-radius:10px;color:var(--text);
      padding:12px 14px;font-size:1rem;outline:none;transition:.18s box-shadow,.18s border-color;
    }
    input:focus{border-color:#2e3746;box-shadow:0 0 0 3px rgba(255,215,0,.15)}
    .toggle-eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--muted);cursor:pointer}

    .actions{display:grid;gap:8px;margin-top:10px}
    button.primary{background:var(--brand);color:#111;border:0;border-radius:999px;padding:12px 14px;font-weight:900;cursor:pointer}
    button.primary[disabled]{opacity:.55;cursor:not-allowed}
    .hint{font-size:.86rem;color:var(--muted);text-align:center}
    .hint a{ color:var(--brand); text-decoration:none; }
    .hint a:hover{ text-decoration:underline; }

    .msg{min-height:24px;font-size:.92rem;margin-top:6px}
    .error{color:var(--danger)}
    .ok{color:var(--success)}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="dialog" aria-labelledby="title">
      <div class="card-head">
        <div class="brand" aria-hidden="true">
          <div class="logo">N</div>
          <h1 id="title">NUMINA</h1>
        </div>
        <div class="tabs" role="tablist" aria-label="Cambiar entre iniciar sesi√≥n y crear cuenta">
          <div class="tab active" id="tab-login" role="tab" aria-selected="true" tabindex="0">Iniciar sesi√≥n</div>
          <div class="tab" id="tab-register" role="tab" aria-selected="false" tabindex="-1">Crear cuenta</div>
        </div>
      </div>

      <div class="card-body">
        <!-- LOGIN -->
        <form id="form-login" autocomplete="on" novalidate>
          <div class="field">
            <label for="email">Correo electr√≥nico</label>
            <div class="control"><input id="email" type="email" inputmode="email" placeholder="tu@email.com" required autocomplete="email" /></div>
          </div>
          <div class="field">
            <label for="password">Contrase√±a</label>
            <div class="control">
              <input id="password" type="password" placeholder="********" minlength="6" required autocomplete="current-password" />
              <button class="toggle-eye" type="button" aria-label="Mostrar u ocultar contrase√±a" data-toggle="password">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="actions">
            <button id="btn-login" class="primary" type="submit">Ingresar</button>
            <div class="hint">¬øOlvidaste tu contrase√±a? <a id="link-reset" href="#">Restablecer</a></div>
          </div>
          <div class="msg" id="msg-login" aria-live="polite"></div>
        </form>

        <!-- REGISTER -->
        <form id="form-register" autocomplete="on" novalidate style="display:none">
          <div class="field">
            <label for="r-email">Correo electr√≥nico</label>
            <div class="control"><input id="r-email" type="email" inputmode="email" placeholder="tu@email.com" required autocomplete="email" /></div>
          </div>
          <div class="field">
            <label for="r-password">Contrase√±a</label>
            <div class="control">
              <input id="r-password" type="password" placeholder="M√≠nimo 6 caracteres" minlength="6" required autocomplete="new-password" />
              <button class="toggle-eye" type="button" aria-label="Mostrar u ocultar contrase√±a" data-toggle="r-password">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="field">
            <label for="r-name">Nombre completo</label>
            <div class="control"><input id="r-name" type="text" placeholder="Nombre y apellido" autocomplete="name" /></div>
          </div>
          <div class="field">
            <label for="r-country">Pa√≠s</label>
            <div class="control"><input id="r-country" type="text" placeholder="Argentina" autocomplete="country-name" /></div>
          </div>
          <div class="field">
            <label for="r-city">Ciudad</label>
            <div class="control"><input id="r-city" type="text" placeholder="Buenos Aires" autocomplete="address-level2" /></div>
          </div>
          <div class="field">
            <label for="r-address">Direcci√≥n</label>
            <div class="control"><input id="r-address" type="text" placeholder="Calle y n√∫mero" autocomplete="street-address" /></div>
          </div>
          <div class="field">
            <label for="r-postal">C√≥digo Postal</label>
            <div class="control"><input id="r-postal" type="text" inputmode="numeric" placeholder="C.P." autocomplete="postal-code" /></div>
          </div>
          <div class="actions">
            <button id="btn-register" class="primary" type="submit">Crear cuenta</button>
            <div class="hint">¬øYa ten√©s cuenta? <a id="link-goto-login" href="#">Iniciar sesi√≥n</a></div>
            <div class="hint">Al registrarte acept√°s los T√©rminos y la Pol√≠tica de privacidad.</div>\n          </div>\n          <div class=\"msg\" id=\"msg-register\" aria-live=\"polite\"></div>\n        </form>\n      </div>\n\n      <div class=\"footer\">¬© <span id=\"y\"></span> Numina</div>\n    </div>\n  </div>\n\n<script>\n  // === CONFIG ===\n  const SUPABASE_URL = \"https://xaeybhscsxpvtnqzpgwj.supabase.co\";\n  const SUPABASE_ANON_KEY = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhZXliaHNjc3hwdnRucXpwZ3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjQ0NzYsImV4cCI6MjA2OTUwMDQ3Nn0.o470dGkIyNKNP552A6DUB3pkJI3Lty9AZOdCmo3MQvU\";\n  const DASHBOARD_URL = \"dashboard.html\"; // ajustar si tu archivo se llama distinto\n\n  // === INIT ===\n  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {\n    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: localStorage }\n  });\n\n  document.getElementById('y').textContent = new Date().getFullYear();\n\n  // Helper: esperar hasta que haya usuario (evita rebotes)\n  async function waitForUser(ms = 1200){\n    const start = Date.now();\n    while (Date.now() - start < ms) {\n      const { data: { user } } = await supabase.auth.getUser();\n      if (user) return user;\n      await new Promise(r => setTimeout(r, 120));\n    }\n    return null;\n  }\n\n  // Intento de redirecci√≥n solo si confirmamos usuario (evita loop login‚Üîdashboard)\n  (async () => {\n    const user = await waitForUser(600);\n    if (user && !document.referrer.includes('dashboard')) {\n      window.location.replace(DASHBOARD_URL);\n    }\n  })();\n\n  // UI helpers\n  const qs = (s, c=document)=>c.querySelector(s);\n  const $loginForm = qs('#form-login');\n  const $regForm   = qs('#form-register');\n  const $tabLogin  = qs('#tab-login');\n  const $tabReg    = qs('#tab-register');\n  const $msgLogin  = qs('#msg-login');\n  const $msgReg    = qs('#msg-register');\n\n  function setTab(which){\n    const loginActive = which === 'login';\n    $tabLogin.classList.toggle('active', loginActive);\n    $tabReg.classList.toggle('active', !loginActive);\n    $tabLogin.setAttribute('aria-selected', String(loginActive));\n    $tabReg.setAttribute('aria-selected', String(!loginActive));\n    $tabLogin.tabIndex = loginActive ? 0 : -1;\n    $tabReg.tabIndex   = loginActive ? -1 : 0;\n    $loginForm.style.display = loginActive ? 'grid' : 'none';\n    $regForm.style.display   = loginActive ? 'none'  : 'grid';\n    (loginActive ? qs('#email') : qs('#r-email')).focus();\n  }\n\n  $tabLogin.addEventListener('click',()=>setTab('login'));\n  $tabReg.addEventListener('click',()=>setTab('register'));\n  $tabLogin.addEventListener('keydown',(e)=>{ if(e.key==='ArrowRight') setTab('register'); });\n  $tabReg.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft') setTab('login'); });\n\n  document.addEventListener('click', (e)=>{\n    const a = e.target.closest('#link-goto-login');\n    if(a){ e.preventDefault(); setTab('login'); }\n  });\n\n  // Toggle password visibility\n  document.addEventListener('click', (e)=>{\n    const btn = e.target.closest('[data-toggle]');\n    if(!btn) return;\n    const id = btn.getAttribute('data-toggle');\n    const input = document.getElementById(id);\n    if(!input) return;\n    input.type = input.type === 'password' ? 'text' : 'password';\n  });\n\n  function mapError(err){\n    const m = (''+(err?.message||err||'Error desconocido')).toLowerCase();\n    if(m.includes('invalid login credentials')) return 'Correo o contrase√±a incorrectos.';\n    if(m.includes('email rate limit')) return 'Demasiados intentos. Prob√° m√°s tarde.';\n    if(m.includes('user already registered')) return 'Ese correo ya est√° registrado. Inici√° sesi√≥n.';\n    if(m.includes('password should be at least')) return 'La contrase√±a debe tener al menos 6 caracteres.';\n    return err?.message || 'Ocurri√≥ un error. Intenta nuevamente.';\n  }\n\n  function setLoading(btn, on){ btn.disabled = !!on; btn.textContent = on ? 'Procesando‚Ä¶' : btn.dataset.label || btn.textContent; }\n\n  // Login handler (espera a que la sesi√≥n quede lista antes de redirigir)\n  $loginForm.addEventListener('submit', async (e)=>{\n    e.preventDefault();\n    $msgLogin.textContent = '';\n    const email = qs('#email').value.trim();\n    const password = qs('#password').value;\n    if(!email || !password){ $msgLogin.textContent = 'Complet√° todos los campos.'; $msgLogin.className='msg error'; return; }\n\n    const btn = qs('#btn-login'); btn.dataset.label = 'Ingresar'; setLoading(btn, true);\n    try{\n      const { error } = await supabase.auth.signInWithPassword({ email, password });\n      if(error) throw error;\n      const user = await waitForUser(1200);\n      if(!user) throw new Error('No se pudo confirmar la sesi√≥n.');\n      window.location.replace(DASHBOARD_URL);\n    }catch(err){\n      $msgLogin.textContent = mapError(err);\n      $msgLogin.className = 'msg error';\n    }finally{ setLoading(btn, false); }\n  });\n\n  // Register handler ‚Äî confirmaci√≥n desactivada: registrar ‚Üí completar perfil ‚Üí dashboard\n  $regForm.addEventListener('submit', async (e)=>{\n    e.preventDefault();\n    $msgReg.textContent = '';\n    const email = qs('#r-email').value.trim();\n    const password = qs('#r-password').value;\n    const fullName = qs('#r-name').value.trim();\n    const country  = qs('#r-country').value.trim();\n    const city     = qs('#r-city').value.trim();\n    const address  = qs('#r-address').value.trim();\n    const postal   = qs('#r-postal').value.trim();\n    if(!email || !password){ $msgReg.textContent = 'Complet√° email y contrase√±a.'; $msgReg.className='msg error'; return; }\n\n    const btn = qs('#btn-register'); btn.dataset.label = 'Crear cuenta'; setLoading(btn,true);\n    try{\n      const { data, error: signUpError } = await supabase.auth.signUp({ email, password });\n      if(signUpError) throw signUpError;\n\n      const user = await waitForUser(1500);\n      if(!user){\n        const { error: loginError } = await supabase.auth.signInWithPassword({ email, password });\n        if(loginError) throw loginError;\n      }\n\n      const { data: u } = await supabase.auth.getUser();\n      const userId = u?.user?.id || null;\n\n      if(userId){\n        await supabase.from('users').upsert({\n          id: userId,\n          email: email,\n          full_name: fullName || null,\n          country: country || null,\n          city: city || null,\n          address: address || null,\n          postal_code: postal || null,\n          referral_code: 'NUM' + Math.random().toString(36).slice(2,8).toUpperCase()\n        }, { onConflict: 'id' });\n      }\n\n      window.location.replace(DASHBOARD_URL);\n    }catch(err){\n      $msgReg.textContent = mapError(err);\n      $msgReg.className = 'msg error';\n    }finally{ setLoading(btn,false); }\n  });\n\n  // Reset password\n  qs('#link-reset').addEventListener('click', async (e)=>{\n    e.preventDefault();\n    const email = prompt('Ingres√° tu correo para restablecer la contrase√±a:');\n    if(!email) return;\n    try{\n      const { error } = await supabase.auth.resetPasswordForEmail(email, {\n        redirectTo: window.location.origin + '/reset.html'\n      });\n      if(error) throw error;\n      alert('Si el correo existe, te enviamos un enlace para restablecer.');\n    }catch(err){ alert(mapError(err)); }\n  });\n</script>\n</body>\n</html>\n
