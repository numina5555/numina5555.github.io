<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NUMINA | Acceso</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Supabase JS v2 (pinned) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.43.4"></script>
  <style>
    :root{
      --bg:#0f1113;--panel:#16181c;--panel-2:#1d2025;--text:#fff;--muted:#a7aeb8;--brand:#ffd700;--brand-2:#e6c200;--danger:#ff6b6b;--success:#44d07b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 20% -10%, #15181d 0%, transparent 60%),
                 radial-gradient(1200px 800px at 120% 110%, #15181d 0%, transparent 60%),
                 var(--bg);
      color:var(--text);
      display:flex;align-items:center;justify-content:center;padding:24px;
    }
    .wrap{width:min(420px, 100%)}
    .card{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px;
      box-shadow:0 20px 45px rgba(0,0,0,.45);
      display:grid;
      grid-template-rows:auto 1fr auto; /* header fijo, body scroll, footer fijo */
      max-height:min(760px, 92vh);
      width:100%;
    }
    .card-head{padding:24px 24px 12px 24px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg,var(--panel) 0%, rgba(22,24,28,.95) 100%); border-top-left-radius:16px; border-top-right-radius:16px;}
    .card-body{padding:16px 24px; overflow:auto;}
    .card .footer{padding:14px 18px; border-top:1px solid rgba(255,255,255,.06); border-bottom-left-radius:16px; border-bottom-right-radius:16px; text-align:center; color:var(--muted); font-size:.8rem;}
    .brand{display:flex;gap:10px;align-items:center;justify-content:center;margin:2px 0 12px}
    .brand .logo{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#4b4300,#8a7a00);display:grid;place-items:center;font-weight:900;color:#111}
    .brand h1{margin:0;font-size:1.9rem;letter-spacing:1.4px;color:var(--brand)}

    .tabs{display:flex;background:#11151a;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:4px;margin:0}
    .tab{flex:1;text-align:center;padding:10px 12px;border-radius:8px;font-weight:700;color:var(--muted);cursor:pointer;user-select:none}
    .tab.active{background:var(--panel);color:var(--text)}

    form{display:grid;gap:12px}
    label{font-size:.92rem;color:var(--muted)}
    .field{display:grid;gap:6px}
    .control{position:relative}
    input{
      width:100%;background:#0f1318;border:1px solid #232832;border-radius:10px;color:var(--text);
      padding:12px 14px;font-size:1rem;outline:none;transition:.18s box-shadow,.18s border-color;
    }
    input:focus{border-color:#2e3746;box-shadow:0 0 0 3px rgba(255,215,0,.15)}
    .toggle-eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--muted);cursor:pointer}

    .actions{display:grid;gap:8px;margin-top:10px}
    button.primary{background:var(--brand);color:#111;border:0;border-radius:999px;padding:12px 14px;font-weight:900;cursor:pointer}
    button.primary[disabled]{opacity:.55;cursor:not-allowed}
    .hint{font-size:.86rem;color:var(--muted);text-align:center}
    .hint a { color: var(--brand); text-decoration: none; }
    .hint a:hover { text-decoration: underline; }

    .msg{min-height:24px;font-size:.92rem;margin-top:6px}
    .error{color:var(--danger)}
    .ok{color:var(--success)}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="dialog" aria-labelledby="title">
      <div class="card-head">
        <div class="brand" aria-hidden="true">
          <div class="logo">N</div>
          <h1 id="title">NUMINA</h1>
        </div>
        <div class="tabs" role="tablist" aria-label="Cambiar entre iniciar sesi√≥n y crear cuenta">
          <div class="tab active" id="tab-login" role="tab" aria-selected="true" tabindex="0">Iniciar sesi√≥n</div>
          <div class="tab" id="tab-register" role="tab" aria-selected="false" tabindex="-1">Crear cuenta</div>
        </div>
      </div>

      <div class="card-body">
        <!-- LOGIN -->
        <form id="form-login" autocomplete="on" novalidate>
          <div class="field">
            <label for="email">Correo electr√≥nico</label>
            <div class="control"><input id="email" type="email" inputmode="email" placeholder="tu@email.com" required autocomplete="email" /></div>
          </div>
          <div class="field">
            <label for="password">Contrase√±a</label>
            <div class="control">
              <input id="password" type="password" placeholder="********" minlength="6" required autocomplete="current-password" />
              <button class="toggle-eye" type="button" aria-label="Mostrar u ocultar contrase√±a" data-toggle="password">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="actions">
            <button id="btn-login" class="primary" type="submit">Ingresar</button>
            <div class="hint">¬øOlvidaste tu contrase√±a? <a id="link-reset" href="#">Restablecer</a></div>
          </div>
          <div class="msg" id="msg-login" aria-live="polite"></div>
        </form>

        <!-- REGISTER -->
        <form id="form-register" autocomplete="on" novalidate style="display:none">
          <div class="field">
            <label for="r-email">Correo electr√≥nico</label>
            <div class="control"><input id="r-email" type="email" inputmode="email" placeholder="tu@email.com" required autocomplete="email" /></div>
          </div>
          <div class="field">
            <label for="r-password">Contrase√±a</label>
            <div class="control">
              <input id="r-password" type="password" placeholder="M√≠nimo 6 caracteres" minlength="6" required autocomplete="new-password" />
              <button class="toggle-eye" type="button" aria-label="Mostrar u ocultar contrase√±a" data-toggle="r-password">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="field">
            <label for="r-name">Nombre completo</label>
            <div class="control"><input id="r-name" type="text" placeholder="Nombre y apellido" autocomplete="name" /></div>
          </div>
          <div class="field">
            <label for="r-country">Pa√≠s</label>
            <div class="control"><input id="r-country" type="text" placeholder="Argentina" autocomplete="country-name" /></div>
          </div>
          <div class="field">
            <label for="r-city">Ciudad</label>
            <div class="control"><input id="r-city" type="text" placeholder="Buenos Aires" autocomplete="address-level2" /></div>
          </div>
          <div class="field">
            <label for="r-address">Direcci√≥n</label>
            <div class="control"><input id="r-address" type="text" placeholder="Calle y n√∫mero" autocomplete="street-address" /></div>
          </div>
          <div class="field">
            <label for="r-postal">C√≥digo Postal</label>
            <div class="control"><input id="r-postal" type="text" inputmode="numeric" placeholder="C.P." autocomplete="postal-code" /></div>
          </div>
          <div class="actions">
            <button id="btn-register" class="primary" type="submit">Crear cuenta</button>
            <div class="hint">¬øYa ten√©s cuenta? <a id="link-goto-login" href="#">Iniciar sesi√≥n</a></div>
            <div class="hint">Al registrarte acept√°s los T√©rminos y la Pol√≠tica de privacidad.</div>
          </div>
          <div class="msg" id="msg-register" aria-live="polite"></div>
        </form>
      </div>

      <div class="footer">¬© <span id="y"></span> Numina</div>
    </div>
  </div>

<script>
  // === CONFIG ===
  const SUPABASE_URL = "https://xaeybhscsxpvtnqzpgwj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhZXliaHNjc3hwdnRucXpwZ3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjQ0NzYsImV4cCI6MjA2OTUwMDQ3Nn0.o470dGkIyNKNP552A6DUB3pkJI3Lty9AZOdCmo3MQvU";
  const DASHBOARD_URL = "dashboard.html"; // ajustar si tu archivo se llama distinto

  // === INIT ===
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: localStorage }
  });

  document.getElementById('y').textContent = new Date().getFullYear();

  // Redirigir si ya hay sesi√≥n
  (async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        window.location.replace(DASHBOARD_URL);
      }
    } catch (_) {}
  })();

  // UI helpers
  const qs = (s, c=document)=>c.querySelector(s);
  const $loginForm = qs('#form-login');
  const $regForm   = qs('#form-register');
  const $tabLogin  = qs('#tab-login');
  const $tabReg    = qs('#tab-register');
  const $msgLogin  = qs('#msg-login');
  const $msgReg    = qs('#msg-register');

  // Tabs behavior
  function setTab(which){
    const loginActive = which === 'login';
    $tabLogin.classList.toggle('active', loginActive);
    $tabReg.classList.toggle('active', !loginActive);
    $tabLogin.setAttribute('aria-selected', String(loginActive));
    $tabReg.setAttribute('aria-selected', String(!loginActive));
    $tabLogin.tabIndex = loginActive ? 0 : -1;
    $tabReg.tabIndex   = loginActive ? -1 : 0;
    $loginForm.style.display = loginActive ? 'grid' : 'none';
    $regForm.style.display   = loginActive ? 'none'  : 'grid';
    (loginActive ? qs('#email') : qs('#r-email')).focus();
  }

  $tabLogin.addEventListener('click',()=>setTab('login'));
  $tabReg.addEventListener('click',()=>setTab('register'));
  $tabLogin.addEventListener('keydown',(e)=>{ if(e.key==='ArrowRight') setTab('register'); });
  $tabReg.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft') setTab('login'); });

  // Extra: link visible en registro para volver a login
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('#link-goto-login');
    if(a){ e.preventDefault(); setTab('login'); }
  });

  // Toggle password visibility
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-toggle]');
    if(!btn) return;
    const id = btn.getAttribute('data-toggle');
    const input = document.getElementById(id);
    if(!input) return;
    input.type = input.type === 'password' ? 'text' : 'password';
  });

  // Error mapping
  function mapError(err){
    const m = (''+(err?.message||err||'Error desconocido')).toLowerCase();
    if(m.includes('invalid login credentials')) return 'Correo o contrase√±a incorrectos.';
    if(m.includes('email rate limit')) return 'Demasiados intentos. Prob√° m√°s tarde.';
    if(m.includes('user already registered')) return 'Ese correo ya est√° registrado. Inici√° sesi√≥n.';
    if(m.includes('password should be at least')) return 'La contrase√±a debe tener al menos 6 caracteres.';
    return err?.message || 'Ocurri√≥ un error. Intenta nuevamente.';
  }

  function setLoading(btn, on){ btn.disabled = !!on; btn.textContent = on ? 'Procesando‚Ä¶' : btn.dataset.label || btn.textContent; }

  // Login handler
  $loginForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    $msgLogin.textContent = '';
    const email = qs('#email').value.trim();
    const password = qs('#password').value;
    if(!email || !password){ $msgLogin.textContent = 'Complet√° todos los campos.'; $msgLogin.className='msg error'; return; }

    const btn = qs('#btn-login'); btn.dataset.label = 'Ingresar'; setLoading(btn, true);
    try{
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;
      window.location.replace(DASHBOARD_URL);
    }catch(err){
      $msgLogin.textContent = mapError(err);
      $msgLogin.className = 'msg error';
    }finally{ setLoading(btn, false); }
  });

  // Register handler ‚Äî confirmaci√≥n desactivada: registramos, completamos perfil y vamos al dashboard
  $regForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    $msgReg.textContent = '';
    const email = qs('#r-email').value.trim();
    const password = qs('#r-password').value;
    const fullName = qs('#r-name').value.trim();
    const country  = qs('#r-country').value.trim();
    const city     = qs('#r-city').value.trim();
    const address  = qs('#r-address').value.trim();
    const postal   = qs('#r-postal').value.trim();
    if(!email || !password){ $msgReg.textContent = 'Complet√° email y contrase√±a.'; $msgReg.className='msg error'; return; }

    const btn = qs('#btn-register'); btn.dataset.label = 'Crear cuenta'; setLoading(btn,true);
    try{
      // Alta en Auth (con confirmaci√≥n desactivada deber√≠a devolver session)
      const { data, error: signUpError } = await supabase.auth.signUp({ email, password });
      if(signUpError) throw signUpError;

      // Si por alguna raz√≥n no hay sesi√≥n, iniciamos sesi√≥n manualmente
      if(!data?.session){
        const { error: loginError } = await supabase.auth.signInWithPassword({ email, password });
        if(loginError) throw loginError;
      }

      // Obtener user id
      let userId = data?.user?.id || null;
      if(!userId){
        const { data: u } = await supabase.auth.getUser();
        userId = u?.user?.id || null;
      }

      // Completar/actualizar datos en tabla users
      if(userId){
        await supabase.from('users').upsert({
          id: userId,
          email: email,
          full_name: fullName || null,
          country: country || null,
          city: city || null,
          address: address || null,
          postal_code: postal || null,
          referral_code: 'NUM' + Math.random().toString(36).slice(2,8).toUpperCase()
        }, { onConflict: 'id' });
      }

      // Ir al dashboard
      window.location.replace(DASHBOARD_URL);
    }catch(err){
      $msgReg.textContent = mapError(err);
      $msgReg.className = 'msg error';
    }finally{ setLoading(btn,false); }
  });

  // Reset password (email OTP)
  qs('#link-reset').addEventListener('click', async (e)=>{
    e.preventDefault();
    const email = prompt('Ingres√° tu correo para restablecer la contrase√±a:');
    if(!email) return;
    try{
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/reset.html' // opcional: p√°gina para setear nueva contrase√±a
      });
      if(error) throw error;
      alert('Si el correo existe, te enviamos un enlace para restablecer.');
    }catch(err){ alert(mapError(err)); }
  });
</script>
</body>
</html>
